---
/**
 * SpeedCameras - Blitzer-Warnung Widget
 *
 * Zeigt bekannte station√§re Blitzer in einer Region.
 * Hinweis: Keine kostenlose API verf√ºgbar, daher mit manuellen Daten.
 *
 * F√ºr Live-Daten: blitzer.de App oder kostenpflichtige APIs
 */
import { cn } from '../utils/cn';

interface SpeedCamera {
  id: string;
  type: 'fixed' | 'mobile' | 'section' | 'redlight';
  location: string;
  street?: string;
  speedLimit: number;
  direction?: string;
  lat?: number;
  lng?: number;
  active?: boolean;
}

interface Props {
  cameras?: SpeedCamera[];
  region?: string;
  showMap?: boolean;
  showSpeedLimit?: boolean;
  compact?: boolean;
  className?: string;
}

const {
  cameras = [],
  region = 'Beispiel-Region',
  showMap = true,
  showSpeedLimit = true,
  compact = false,
  className = '',
} = Astro.props;

// Example data if none provided
const exampleCameras: SpeedCamera[] =
  cameras.length > 0
    ? cameras
    : [
        {
          id: '1',
          type: 'fixed',
          location: 'A1 km 42.5',
          street: 'Richtung Hamburg',
          speedLimit: 120,
          active: true,
        },
        {
          id: '2',
          type: 'section',
          location: 'B27 Tunnel',
          street: 'Heilbronn',
          speedLimit: 80,
          active: true,
        },
        {
          id: '3',
          type: 'redlight',
          location: 'Hauptstra√üe / Bahnhofstr.',
          street: 'Kreuzung',
          speedLimit: 50,
          active: true,
        },
        {
          id: '4',
          type: 'fixed',
          location: 'A8 km 128',
          street: 'Richtung M√ºnchen',
          speedLimit: 100,
          active: false,
        },
      ];

const displayCameras = cameras.length > 0 ? cameras : exampleCameras;

const typeInfo: Record<string, { label: string; icon: string; color: string }> =
  {
    fixed: {
      label: 'Station√§r',
      icon: 'üì∑',
      color: 'bg-red-500/20 text-red-300 border-red-500/30',
    },
    mobile: {
      label: 'Mobil',
      icon: 'üöî',
      color: 'bg-amber-500/20 text-amber-300 border-amber-500/30',
    },
    section: {
      label: 'Strecke',
      icon: 'üìè',
      color: 'bg-purple-500/20 text-purple-300 border-purple-500/30',
    },
    redlight: {
      label: 'Ampel',
      icon: 'üö¶',
      color: 'bg-orange-500/20 text-orange-300 border-orange-500/30',
    },
  };

const activeCount = displayCameras.filter((c) => c.active !== false).length;
---

<div
  class={cn(
    'rounded-2xl bg-gradient-to-br from-slate-800/90 to-slate-900/90 border border-slate-700/50 overflow-hidden',
    className
  )}
>
  <header class="px-5 py-4 border-b border-slate-700/50 bg-red-500/5">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div
          class="p-2.5 rounded-xl bg-gradient-to-br from-red-500 to-rose-600 shadow-lg shadow-red-500/25"
        >
          <svg
            class="w-5 h-5 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-slate-100 text-lg">Blitzer</h3>
          <p class="text-xs text-slate-400">{region}</p>
        </div>
      </div>

      <span
        class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-500/20 text-red-300 border border-red-500/30"
      >
        <span class="relative flex h-2 w-2">
          <span
            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
          ></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"
          ></span>
        </span>
        {activeCount} aktiv
      </span>
    </div>
  </header>

  <div class={cn('p-4', compact && 'p-3')}>
    {/* Warning Notice */}
    <div class="mb-4 p-3 rounded-xl bg-amber-500/10 border border-amber-500/30">
      <div class="flex items-start gap-2">
        <span class="text-amber-400">‚ö†Ô∏è</span>
        <p class="text-xs text-amber-200">
          <strong>Hinweis:</strong> Diese Daten dienen nur zur Information. F√ºr aktuelle
          Blitzer-Warnungen nutzen Sie die
          <a
            href="https://blitzer.de"
            target="_blank"
            rel="noopener"
            class="underline hover:text-amber-100">Blitzer.de App</a
          >.
        </p>
      </div>
    </div>

    <div class={cn('space-y-3', compact && 'space-y-2')}>
      {
        displayCameras.map((camera) => {
          const info = typeInfo[camera.type] || typeInfo.fixed;
          const isActive = camera.active !== false;

          return (
            <article
              class={cn(
                'flex items-center gap-4 p-3 rounded-xl border transition-all',
                isActive
                  ? 'bg-red-950/20 border-red-500/30'
                  : 'bg-slate-800/30 border-slate-700/30 opacity-60',
                compact && 'p-2'
              )}
            >
              {/* Icon */}
              <div
                class={cn(
                  'shrink-0 w-10 h-10 rounded-lg flex items-center justify-center text-lg',
                  isActive ? 'bg-red-500/20' : 'bg-slate-700/50'
                )}
              >
                {info.icon}
              </div>

              {/* Info */}
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span
                    class={cn(
                      'px-2 py-0.5 text-xs font-semibold rounded border',
                      info.color
                    )}
                  >
                    {info.label}
                  </span>
                  {!isActive && (
                    <span class="px-2 py-0.5 text-xs bg-slate-700/50 text-slate-400 rounded">
                      Inaktiv
                    </span>
                  )}
                </div>
                <h4 class="font-semibold text-slate-100 mt-1">
                  {camera.location}
                </h4>
                {camera.street && !compact && (
                  <p class="text-xs text-slate-500">{camera.street}</p>
                )}
              </div>

              {/* Speed Limit */}
              {showSpeedLimit && (
                <div
                  class={cn(
                    'shrink-0 w-12 h-12 rounded-full border-4 flex items-center justify-center font-black',
                    isActive
                      ? 'border-red-500 text-red-400'
                      : 'border-slate-600 text-slate-500',
                    compact && 'w-10 h-10 border-2 text-sm'
                  )}
                >
                  {camera.speedLimit}
                </div>
              )}

              {/* Map Link */}
              {showMap && camera.lat && camera.lng && (
                <a
                  href={`https://www.google.com/maps?q=${camera.lat},${camera.lng}`}
                  target="_blank"
                  rel="noopener"
                  class="shrink-0 p-2 rounded-lg bg-slate-700/50 hover:bg-blue-500/20 text-slate-400 hover:text-blue-400 transition-colors"
                  title="Auf Karte anzeigen"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                </a>
              )}
            </article>
          );
        })
      }
    </div>

    {/* Legend */}
    {
      !compact && (
        <div class="mt-4 pt-4 border-t border-slate-700/50">
          <div class="flex flex-wrap gap-3 text-xs">
            {Object.entries(typeInfo).map(([, info]) => (
              <span class="flex items-center gap-1 text-slate-400">
                <span>{info.icon}</span>
                {info.label}
              </span>
            ))}
          </div>
        </div>
      )
    }
  </div>

  <footer
    class="px-5 py-3 border-t border-slate-700/50 bg-slate-800/30 flex items-center justify-between text-xs text-slate-500"
  >
    <span>Beispieldaten</span>
    <a
      href="https://blitzer.de"
      target="_blank"
      rel="noopener"
      class="text-blue-400 hover:text-blue-300"
    >
      Live-Daten auf blitzer.de ‚Üí
    </a>
  </footer>
</div>

<style>
  @keyframes ping {
    75%,
    100% {
      transform: scale(2);
      opacity: 0;
    }
  }
  .animate-ping {
    animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
  }
</style>
