---
/**
 * Alert - status message
 */
interface Props {
  title?: string;
  message?: string;
  /** Custom icon (emoji or text) - overrides default icon */
  icon?: string;
  variant?: 'info' | 'success' | 'warning' | 'error';
  dismissible?: boolean;
  dismissLabel?: string;
  className?: string;
}

const {
  title,
  message,
  icon: customIcon,
  variant = 'info',
  dismissible = false,
  dismissLabel = 'Dismiss alert',
  className = '',
} = Astro.props as Props;

import { tv } from 'tailwind-variants';
import Icon from './Icon.astro';

export const baseWrap =
  'relative flex items-start gap-4 rounded-xl border px-4 py-4 text-base leading-relaxed shadow-sm transition-colors duration-150 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-offset-white focus-within:ring-current dark:focus-within:ring-offset-slate-950 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950 motion-reduce:transition-none sm:px-5 sm:py-5';

export const alertVariants = tv({
  base: baseWrap,
  variants: {
    variant: {
      info: 'bg-blue-50 text-blue-950 accent-blue-800 border-blue-200 hover:border-blue-400 hover:bg-blue-100 dark:bg-blue-950 dark:text-blue-50 dark:accent-blue-200 dark:border-blue-900 dark:hover:border-blue-400 dark:hover:bg-blue-900 focus-visible:ring-blue-200 dark:focus-visible:ring-blue-300',
      success:
        'bg-emerald-50 text-emerald-950 accent-emerald-800 border-emerald-200 hover:border-emerald-500 hover:bg-emerald-100 dark:bg-emerald-950 dark:text-emerald-50 dark:accent-emerald-200 dark:border-emerald-900 dark:hover:border-emerald-400 dark:hover:bg-emerald-900 focus-visible:ring-emerald-200 dark:focus-visible:ring-emerald-300',
      warning:
        'bg-amber-50 text-amber-950 accent-amber-800 border-amber-200 hover:border-amber-500 hover:bg-amber-100 dark:bg-amber-950 dark:text-amber-50 dark:accent-amber-200 dark:border-amber-900 dark:hover:border-amber-400 dark:hover:bg-amber-900 focus-visible:ring-amber-200 dark:focus-visible:ring-amber-300',
      error:
        'bg-rose-50 text-rose-950 accent-rose-800 border-rose-200 hover:border-rose-500 hover:bg-rose-100 dark:bg-rose-950 dark:text-rose-50 dark:accent-rose-200 dark:border-rose-900 dark:hover:border-rose-400 dark:hover:bg-rose-900 focus-visible:ring-rose-200 dark:focus-visible:ring-rose-300',
    },
  },
  defaultVariants: {
    variant: 'info',
  },
});

const iconColor = {
  info: 'text-blue-800 dark:text-blue-200',
  success: 'text-emerald-800 dark:text-emerald-200',
  warning: 'text-amber-800 dark:text-amber-200',
  error: 'text-rose-800 dark:text-rose-200',
} as const;

const roleMap = {
  info: { role: 'status', ariaLive: 'polite', label: 'Information' },
  success: { role: 'status', ariaLive: 'polite', label: 'Success' },
  warning: { role: 'alert', ariaLive: 'assertive', label: 'Warning' },
  error: { role: 'alert', ariaLive: 'assertive', label: 'Error' },
} as const;

const iconName = {
  info: 'info',
  success: 'check-circle',
  warning: 'exclamation',
  error: 'x-circle',
} as const;

// Default emoji icons for custom icon usage (Callout compatibility)
const defaultEmoji = {
  info: 'ℹ️',
  success: '✅',
  warning: '⚠️',
  error: '❌',
} as const;

// Ensure we always map to a known variant even if input is unexpected
const safeVariant =
  variant in roleMap ? (variant as keyof typeof roleMap) : 'info';
const useCustomIcon = customIcon !== undefined;
const displayIcon = customIcon ?? defaultEmoji[safeVariant];

const variantClass = `Alert--${safeVariant}`;
---

<div
  class={`${variantClass} ${alertVariants({ variant: safeVariant })} ${className} Alert`.trim()}
  role={roleMap[safeVariant].role}
  aria-live={roleMap[safeVariant].ariaLive}
  aria-atomic="true"
  data-variant={safeVariant}
  data-state="open"
  aria-hidden="false"
>
  <div class="flex w-full items-start gap-4 sm:gap-5 Alert__Inner">
    <div
      class={`mt-1 flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-white/80 text-lg font-semibold shadow-inner ${iconColor[safeVariant]} dark:bg-white/10 Alert__Icon`}
      aria-hidden="true"
    >
      {
        useCustomIcon ? (
          <span class="text-2xl Alert__IconEmoji" aria-hidden="true">
            {displayIcon}
          </span>
        ) : (
          <Icon
            name={iconName[safeVariant]}
            size="md"
            decorative={false}
            ariaLabel={roleMap[safeVariant].label}
            className="h-5 w-5 Alert__IconSvg"
          />
        )
      }
    </div>
    <div class="min-w-0 space-y-2 text-current Alert__Body">
      <span class="sr-only Alert__Label">{roleMap[safeVariant].label}</span>
      {
        title && (
          <div class="text-base font-semibold text-current Alert__Title">
            {title}
          </div>
        )
      }
      {
        message && (
          <div class="text-sm leading-relaxed text-current Alert__Message">
            {message}
          </div>
        )
      }
      <slot class="Alert__Slot" />
    </div>
    {
      dismissible && (
        <button
          type="button"
          class=" absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-md border border-transparent text-sm font-semibold text-current transition-colors hover:border-current hover:bg-current/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-current focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950 motion-reduce:transition-none Alert__CloseButton"
          data-close
          aria-label={dismissLabel}
        >
          <span class="Alert__CloseIcon" aria-hidden="true">
            ×
          </span>
          <span class="sr-only Alert__CloseLabel">{dismissLabel}</span>
        </button>
      )
    }
  </div>
</div>

<script is:inline>
  (() => {
    const script = document.currentScript;
    if (!(script instanceof HTMLScriptElement)) return;
    const root = script.previousElementSibling;
    if (!(root instanceof HTMLElement)) return;
    const btn = root.querySelector('[data-close]');
    if (!(btn instanceof HTMLElement)) return;
    root.dataset.state =
      root.getAttribute('hidden') === 'true' ? 'closed' : 'open';
    btn.addEventListener(
      'click',
      () => {
        root.setAttribute('hidden', 'true');
        root.setAttribute('aria-hidden', 'true');
        root.dataset.state = 'closed';
      },
      { passive: true }
    );
  })();
</script>
