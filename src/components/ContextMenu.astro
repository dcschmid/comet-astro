---
/**
 * ContextMenu - accessible right-click context menu with keyboard navigation
 */
interface MenuItem {
  label: string;
  action?: string;
  icon?: string;
  divider?: boolean;
  disabled?: boolean;
  danger?: boolean;
}

interface Props {
  items: MenuItem[];
  targetId: string;
  className?: string;
}

const { items, targetId, className = '' } = Astro.props;
---

<div
  class={`fixed z-50 min-w-60 max-w-80 rounded-lg border border-slate-300/80 bg-white py-2 shadow-2xl ring-1 ring-black/10 transition-all duration-500 ease-out invisible opacity-0 scale-95 backdrop-blur-sm dark:border-slate-600/80 dark:bg-slate-800 dark:ring-white/10 ${className}`}
  data-context-menu
  data-context-target={targetId}
  role="menu"
  aria-hidden="true"
  aria-label="Context menu"
>
  {
    items.map((item) =>
      item.divider ? (
        <hr class="my-2 border-slate-300/60 dark:border-slate-600/60" />
      ) : (
        <button
          type="button"
          class={`flex w-full items-center gap-3 px-4 py-2.5 text-sm text-left font-medium transition-colors duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset ${
            item.disabled
              ? 'cursor-not-allowed text-slate-400 dark:text-slate-500'
              : item.danger
                ? 'text-red-700 hover:bg-red-50 hover:text-red-800 focus-visible:bg-red-50 focus-visible:ring-red-600 dark:text-red-300 dark:hover:bg-red-500/20 dark:hover:text-red-200 dark:focus-visible:bg-red-500/20 dark:focus-visible:ring-red-400'
                : 'text-slate-800 hover:bg-blue-50 hover:text-blue-800 focus-visible:bg-blue-50 focus-visible:ring-blue-600 dark:text-slate-100 dark:hover:bg-blue-500/20 dark:hover:text-blue-200 dark:focus-visible:bg-blue-500/20 dark:focus-visible:ring-blue-400'
          }`}
          data-context-action={item.action}
          disabled={item.disabled}
          role="menuitem"
          tabindex="-1"
          aria-selected="false"
        >
          {item.icon && <span class="text-base shrink-0" aria-hidden="true">{item.icon}</span>}
          <span class="truncate">{item.label}</span>
        </button>
      )
    )
  }
</div>

<script is:inline>
  (function () {
    const menus = Array.from(
      document.querySelectorAll('[data-context-menu]')
    ).filter((el) => el instanceof HTMLElement);
    if (!menus.length) return;

    let openMenu = null;

    const hideMenu = (menu) => {
      if (!menu) return;
      menu.classList.add('opacity-0', 'scale-95');
      menu.setAttribute('aria-hidden', 'true');
      window.setTimeout(() => {
        menu.classList.add('invisible');
      }, 500);
      menu.querySelectorAll('[data-context-action]').forEach((item) => {
        if (item instanceof HTMLElement) {
          item.tabIndex = -1;
          item.setAttribute('aria-selected', 'false');
        }
      });
      openMenu = null;
    };

    const hideAllMenus = () => {
      menus.forEach((menu) => hideMenu(menu));
    };

    const positionMenu = (menu, x, y) => {
      const { innerWidth, innerHeight } = window;
      const width = menu.offsetWidth;
      const height = menu.offsetHeight;
      const left = Math.min(x, innerWidth - width - 8);
      const top = Math.min(y, innerHeight - height - 8);
      menu.style.left = `${left}px`;
      menu.style.top = `${top}px`;
    };

    const focusFirstItem = (menu) => {
      const candidates = Array.from(
        menu.querySelectorAll('[data-context-action]')
      ).filter(
        (el) => el instanceof HTMLElement && !el.hasAttribute('disabled')
      );
      if (!candidates.length) return;
      const first = candidates[0];
      first.tabIndex = 0;
      first.setAttribute('aria-selected', 'true');
      first.focus({ preventScroll: true });
    };

    menus.forEach((menu) => {
      const targetId = menu.getAttribute('data-context-target');
      if (!targetId) return;
      const target = document.getElementById(targetId);
      if (!(target instanceof HTMLElement)) return;

      target.addEventListener('contextmenu', (event) => {
        event.preventDefault();
        event.stopPropagation();
        hideAllMenus();
        
        // Show menu with animation
        menu.classList.remove('invisible');
        menu.style.pointerEvents = 'auto';
        requestAnimationFrame(() => {
          menu.classList.remove('opacity-0', 'scale-95');
        });
        menu.setAttribute('aria-hidden', 'false');
        positionMenu(menu, event.pageX, event.pageY);
        openMenu = menu;
        
        // Focus first item after animation completes
        setTimeout(() => {
          focusFirstItem(menu);
        }, 250);
      });

      menu.addEventListener('click', (event) => {
        event.stopPropagation();
        const button =
          event.target instanceof HTMLElement
            ? event.target.closest('[data-context-action]')
            : null;
        if (!(button instanceof HTMLElement) || button.hasAttribute('disabled'))
          return;
        const action = button.getAttribute('data-context-action');
        if (action) {
          target.dispatchEvent(
            new CustomEvent('contextaction', { detail: { action } })
          );
        }
        // Close immediately after clicking an item
        hideMenu(menu);
      });

      menu.addEventListener('keydown', (event) => {
        const items = Array.from(
          menu.querySelectorAll('[data-context-action]')
        ).filter(
          (el) => el instanceof HTMLElement && !el.hasAttribute('disabled')
        );
        if (!items.length) return;
        const currentIndex = items.findIndex(
          (el) => el === document.activeElement
        );
        if (event.key === 'ArrowDown') {
          event.preventDefault();
          const next = items[(currentIndex + 1) % items.length];
          items.forEach((el) => {
            el.tabIndex = -1;
            el.setAttribute('aria-selected', 'false');
          });
          next.tabIndex = 0;
          next.focus({ preventScroll: true });
          next.setAttribute('aria-selected', 'true');
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          const prev = items[(currentIndex - 1 + items.length) % items.length];
          items.forEach((el) => {
            el.tabIndex = -1;
            el.setAttribute('aria-selected', 'false');
          });
          prev.tabIndex = 0;
          prev.focus({ preventScroll: true });
          prev.setAttribute('aria-selected', 'true');
        } else if (event.key === 'Home') {
          event.preventDefault();
          const first = items[0];
          items.forEach((el) => {
            el.tabIndex = -1;
            el.setAttribute('aria-selected', 'false');
          });
          first.tabIndex = 0;
          first.focus({ preventScroll: true });
          first.setAttribute('aria-selected', 'true');
        } else if (event.key === 'End') {
          event.preventDefault();
          const last = items[items.length - 1];
          items.forEach((el) => {
            el.tabIndex = -1;
            el.setAttribute('aria-selected', 'false');
          });
          last.tabIndex = 0;
          last.focus({ preventScroll: true });
          last.setAttribute('aria-selected', 'true');
        } else if (event.key === 'Escape') {
          event.preventDefault();
          hideMenu(menu);
          // Return focus to target element
          target.focus();
        } else if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          if (document.activeElement instanceof HTMLElement) {
            document.activeElement.click();
          }
        }
      });
    });

    document.addEventListener('click', (event) => {
      if (openMenu && event.target && !openMenu.contains(event.target)) {
        hideMenu(openMenu);
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && openMenu) {
        hideMenu(openMenu);
      }
    });
  })();
</script>
