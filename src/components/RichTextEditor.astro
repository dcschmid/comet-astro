---
import { cn } from '../utils/cn';

/**
 * RichTextEditor - Accessible WYSIWYG editor built on contenteditable with WCAG AAA compliance
 */
export interface Props {
  /** Initial HTML content value */
  value?: string;
  /** Placeholder text for empty editor */
  placeholder?: string;
  /** Label text for the editor */
  label?: string;
  /** Help text displayed below the editor */
  helpText?: string;
  /** Whether the editor is read-only */
  readOnly?: boolean;
  /** Whether the editor is disabled */
  disabled?: boolean;
  /** Whether the editor is required */
  required?: boolean;
  /** Whether the editor has an error state */
  error?: boolean;
  /** Visual variant of the editor */
  variant?: 'default' | 'minimal' | 'bordered' | 'elevated';
  /** Size of the editor */
  size?: 'sm' | 'md' | 'lg';
  /** Maximum character count */
  maxLength?: number;
  /** Show character count */
  showCharCount?: boolean;
  /** Custom toolbar configuration */
  toolbar?: Array<
    | 'bold'
    | 'italic'
    | 'underline'
    | 'strike'
    | 'code'
    | 'quote'
    | 'link'
    | 'ordered-list'
    | 'unordered-list'
    | 'heading'
    | 'clear'
    | 'undo'
    | 'redo'
  >;
  /** Form name attribute */
  name?: string;
  /** Custom ID for the editor */
  id?: string;
  /** Custom aria-label for accessibility */
  ariaLabel?: string;
  /** ID of element that describes the editor */
  ariaDescribedBy?: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  value = '',
  placeholder = 'Start typing‚Ä¶',
  label,
  helpText,
  readOnly = false,
  disabled = false,
  required = false,
  error = false,
  variant = 'default',
  size = 'md',
  maxLength,
  showCharCount = false,
  toolbar = [
    'bold',
    'italic',
    'underline',
    'strike',
    'quote',
    'code',
    'link',
    'heading',
    'ordered-list',
    'unordered-list',
    'undo',
    'redo',
    'clear',
  ],
  name,
  id: propId,
  ariaLabel,
  ariaDescribedBy,
  class: className = '',
} = Astro.props;

const id = propId || `rich-text-${Math.random().toString(36).slice(2, 10)}`;
const helpId = helpText ? `${id}-help` : undefined;
const errorId = error ? `${id}-error` : undefined;
const charCountId = showCharCount ? `${id}-char-count` : undefined;
const finalAriaDescribedBy = [ariaDescribedBy, helpId, errorId, charCountId].filter(Boolean).join(' ') || undefined;

// Size configurations
const sizeClasses = {
  sm: {
    editor: 'min-h-[120px] px-3 py-2 text-sm',
    toolbar: 'p-1.5 gap-0.5',
    button: 'px-1.5 py-1 text-xs',
    label: 'text-sm',
    help: 'text-xs',
  },
  md: {
    editor: 'min-h-[180px] px-4 py-3 text-sm',
    toolbar: 'p-2 gap-1',
    button: 'px-2 py-1 text-sm',
    label: 'text-sm',
    help: 'text-xs',
  },
  lg: {
    editor: 'min-h-[240px] px-5 py-4 text-base',
    toolbar: 'p-3 gap-1.5',
    button: 'px-3 py-1.5 text-sm',
    label: 'text-base',
    help: 'text-sm',
  },
};

// Variant styles
const variantClasses = {
  default: {
    toolbar: 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900',
    editor: cn(
      'border-gray-300 dark:border-gray-700',
      'bg-white dark:bg-gray-950',
      'focus-within:border-blue-500 dark:focus-within:border-blue-400',
      'focus-within:ring-blue-500 dark:focus-within:ring-blue-400',
      error && 'border-red-500 dark:border-red-400 focus-within:border-red-500 dark:focus-within:border-red-400 focus-within:ring-red-500 dark:focus-within:ring-red-400'
    ),
    button: 'text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-blue-500/20 focus-visible:ring-blue-600 dark:focus-visible:ring-blue-400',
  },
  minimal: {
    toolbar: 'border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800',
    editor: cn(
      'border-gray-200 dark:border-gray-600',
      'bg-gray-50 dark:bg-gray-800',
      'focus-within:border-gray-400 dark:focus-within:border-gray-500',
      'focus-within:ring-gray-400 dark:focus-within:ring-gray-500',
      error && 'border-red-500 dark:border-red-400 focus-within:border-red-500 dark:focus-within:border-red-400 focus-within:ring-red-500 dark:focus-within:ring-red-400'
    ),
    button: 'text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus-visible:ring-gray-500 dark:focus-visible:ring-gray-400',
  },
  bordered: {
    toolbar: 'border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900',
    editor: cn(
      'border-2 border-gray-300 dark:border-gray-600',
      'bg-white dark:bg-gray-950',
      'focus-within:border-blue-600 dark:focus-within:border-blue-400',
      'focus-within:ring-blue-600 dark:focus-within:ring-blue-400',
      error && 'border-red-600 dark:border-red-400 focus-within:border-red-600 dark:focus-within:border-red-400 focus-within:ring-red-600 dark:focus-within:ring-red-400'
    ),
    button: 'text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-blue-500/20 focus-visible:ring-blue-600 dark:focus-visible:ring-blue-400',
  },
  elevated: {
    toolbar: 'border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 shadow-md',
    editor: cn(
      'border border-gray-300 dark:border-gray-700',
      'bg-white dark:bg-gray-950 shadow-sm',
      'focus-within:border-blue-500 dark:focus-within:border-blue-400',
      'focus-within:ring-blue-500 dark:focus-within:ring-blue-400',
      'focus-within:shadow-md',
      error && 'border-red-500 dark:border-red-400 focus-within:border-red-500 dark:focus-within:border-red-400 focus-within:ring-red-500 dark:focus-within:ring-red-400'
    ),
    button: 'text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-blue-500/20 focus-visible:ring-blue-600 dark:focus-visible:ring-blue-400',
  },
};

const toolbarClasses = cn(
  'flex flex-wrap items-center rounded-lg text-sm',
  sizeClasses[size].toolbar,
  variantClasses[variant].toolbar,
  disabled && 'opacity-50 cursor-not-allowed'
);

const toolbarButtonClasses = cn(
  'rounded-md transition-all duration-200 ease-in-out',
  'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2',
  'focus-visible:ring-offset-white dark:focus-visible:ring-offset-gray-900',
  'disabled:opacity-50 disabled:cursor-not-allowed',
  sizeClasses[size].button,
  variantClasses[variant].button
);

const editorClasses = cn(
  'rounded-xl leading-relaxed text-gray-900 dark:text-gray-100',
  'focus-within:ring-2 transition-all duration-200',
  sizeClasses[size].editor,
  variantClasses[variant].editor,
  disabled && 'opacity-50 cursor-not-allowed bg-gray-100 dark:bg-gray-800'
);

const labelClasses = cn(
  'block font-medium text-gray-900 dark:text-gray-100',
  sizeClasses[size].label,
  disabled && 'opacity-50',
  required && 'after:content-["*"] after:ml-1 after:text-red-500 dark:after:text-red-400'
);

const helpClasses = cn(
  'text-gray-600 dark:text-gray-300',
  sizeClasses[size].help,
  error && 'text-red-600 dark:text-red-300'
);

const charCountClasses = cn(
  'text-right tabular-nums',
  sizeClasses[size].help,
  'text-gray-500 dark:text-gray-400'
);
---

<div
  id={id}
  class={cn('space-y-3 text-gray-900 dark:text-gray-100', className)}
  data-rich-text-root
  data-max-length={maxLength}
  data-show-char-count={showCharCount}
>
  {label && (
    <label
      class={labelClasses}
      for={`${id}-content`}
    >
      {label}
    </label>
  )}
  
  {!readOnly && !disabled && (
    <div
      class={toolbarClasses}
      data-rich-text-toolbar
      role="toolbar"
      aria-label="Text formatting options"
    >
      {toolbar.includes('bold') && (
        <button
          type="button"
          class={cn(toolbarButtonClasses, 'font-bold')}
          data-rich-text-action="bold"
          aria-label="Bold"
          title="Bold (Ctrl+B)"
          disabled={disabled}
        >
          B
        </button>
      )}
      {toolbar.includes('italic') && (
        <button
          type="button"
          class={cn(toolbarButtonClasses, 'italic')}
          data-rich-text-action="italic"
          aria-label="Italic"
          title="Italic (Ctrl+I)"
          disabled={disabled}
        >
          I
        </button>
      )}
      {toolbar.includes('underline') && (
        <button
          type="button"
          class={cn(toolbarButtonClasses, 'underline')}
          data-rich-text-action="underline"
          aria-label="Underline"
          title="Underline (Ctrl+U)"
          disabled={disabled}
        >
          U
        </button>
      )}
      {toolbar.includes('strike') && (
        <button
          type="button"
          class={cn(toolbarButtonClasses, 'line-through')}
          data-rich-text-action="strikeThrough"
          aria-label="Strikethrough"
          title="Strikethrough"
          disabled={disabled}
        >
          S
        </button>
      )}
      {toolbar.includes('heading') && (
        <button
          type="button"
          class={cn(toolbarButtonClasses, 'font-bold')}
          data-rich-text-action="formatBlock"
          data-arg="h3"
          aria-label="Heading"
          title="Heading"
          disabled={disabled}
        >
          H
        </button>
      )}
      {toolbar.includes('quote') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="formatBlock"
          data-arg="blockquote"
          aria-label="Quote"
          title="Quote"
          disabled={disabled}
        >
          ‚ùù
        </button>
      )}
      {toolbar.includes('code') && (
        <button
          type="button"
          class={cn(toolbarButtonClasses, 'font-mono')}
          data-rich-text-action="formatBlock"
          data-arg="pre"
          aria-label="Code"
          title="Code block"
          disabled={disabled}
        >
          {'</>'}
        </button>
      )}
      {toolbar.includes('link') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="link"
          aria-label="Insert link"
          title="Insert link"
          disabled={disabled}
        >
          üîó
        </button>
      )}
      {toolbar.includes('ordered-list') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="insertOrderedList"
          aria-label="Numbered list"
          title="Numbered list"
          disabled={disabled}
        >
          1.
        </button>
      )}
      {toolbar.includes('unordered-list') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="insertUnorderedList"
          aria-label="Bullet list"
          title="Bullet list"
          disabled={disabled}
        >
          ‚Ä¢
        </button>
      )}
      <div class="h-5 w-px bg-gray-300 dark:bg-gray-600 mx-1" aria-hidden="true"></div>
      {toolbar.includes('undo') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="undo"
          aria-label="Undo"
          title="Undo (Ctrl+Z)"
          disabled={disabled}
        >
          ‚Ü∫
        </button>
      )}
      {toolbar.includes('redo') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="redo"
          aria-label="Redo"
          title="Redo (Ctrl+Y)"
          disabled={disabled}
        >
          ‚Üª
        </button>
      )}
      {toolbar.includes('clear') && (
        <button
          type="button"
          class={toolbarButtonClasses}
          data-rich-text-action="clear"
          aria-label="Clear formatting"
          title="Clear formatting"
          disabled={disabled}
        >
          Clear
        </button>
      )}
    </div>
  )}
  
  <div
    id={`${id}-content`}
    class={editorClasses}
    data-rich-text-editor
    data-placeholder={placeholder}
    contenteditable={!readOnly && !disabled}
    role="textbox"
    aria-multiline="true"
    aria-label={ariaLabel || placeholder}
    aria-describedby={finalAriaDescribedBy}
    aria-readonly={readOnly ? 'true' : 'false'}
    aria-disabled={disabled ? 'true' : 'false'}
    aria-required={required ? 'true' : 'false'}
    aria-invalid={error ? 'true' : 'false'}
    spellcheck="true"
    data-testid="rich-text-editor"
  >
    {value ? <Fragment set:html={value} /> : ''}
  </div>
  
  <textarea 
    name={name ?? undefined} 
    hidden 
    data-rich-text-input
    required={required}
    disabled={disabled}
    aria-hidden="true"
  >{value}</textarea>
  
  <div class="flex justify-between items-start gap-4">
    <div class="flex-1">
      {helpText && (
        <p id={helpId} class={helpClasses}>
          {helpText}
        </p>
      )}
      {error && (
        <p id={errorId} class={cn(helpClasses, 'mt-1')} role="alert">
          {typeof error === 'string' ? error : 'Please correct the errors above.'}
        </p>
      )}
    </div>
    
    {showCharCount && (
      <div id={charCountId} class={charCountClasses} aria-live="polite">
        <span data-char-count>0</span>{maxLength && <span>/{maxLength}</span>}
      </div>
    )}
  </div>
</div>

<style is:inline>
  [data-rich-text-editor][contenteditable='true']:empty::before,
  [data-rich-text-editor][data-empty='true']::before {
    content: attr(data-placeholder);
    color: rgb(107 114 128 / 0.7);
    pointer-events: none;
  }

  @media (prefers-color-scheme: dark) {
    [data-rich-text-editor][contenteditable='true']:empty::before,
    [data-rich-text-editor][data-empty='true']::before {
      color: rgb(156 163 175 / 0.75);
    }
  }

  [data-rich-text-editor] h1,
  [data-rich-text-editor] h2,
  [data-rich-text-editor] h3,
  [data-rich-text-editor] h4,
  [data-rich-text-editor] h5,
  [data-rich-text-editor] h6 {
    font-weight: 600;
    margin: 0.5em 0;
    line-height: 1.3;
  }

  [data-rich-text-editor] h3 {
    font-size: 1.125em;
  }

  [data-rich-text-editor] blockquote {
    border-left: 4px solid rgb(59 130 246);
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: rgb(75 85 99);
  }

  @media (prefers-color-scheme: dark) {
    [data-rich-text-editor] blockquote {
      border-left-color: rgb(147 197 253);
      color: rgb(156 163 175);
    }
  }

  [data-rich-text-editor] pre {
    background-color: rgb(243 244 246);
    border: 1px solid rgb(209 213 219);
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin: 1rem 0;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.875em;
    overflow-x: auto;
  }

  @media (prefers-color-scheme: dark) {
    [data-rich-text-editor] pre {
      background-color: rgb(31 41 55);
      border-color: rgb(75 85 99);
      color: rgb(209 213 219);
    }
  }

  [data-rich-text-editor] ul,
  [data-rich-text-editor] ol {
    margin: 1rem 0;
    padding-left: 2rem;
  }

  [data-rich-text-editor] li {
    margin: 0.25rem 0;
  }

  [data-rich-text-editor] a {
    color: rgb(59 130 246);
    text-decoration: underline;
  }

  @media (prefers-color-scheme: dark) {
    [data-rich-text-editor] a {
      color: rgb(147 197 253);
    }
  }

  [data-rich-text-editor] a:hover {
    color: rgb(37 99 235);
  }

  @media (prefers-color-scheme: dark) {
    [data-rich-text-editor] a:hover {
      color: rgb(96 165 250);
    }
  }

  [data-rich-text-editor]:focus {
    outline: none;
  }
</style>

<script is:inline define:vars={{ id, maxLength, showCharCount }}>
  (function setupRichTextEditor() {
    const root = document.getElementById(id);
    if (!(root instanceof HTMLElement)) return;

    const editor = root.querySelector('[data-rich-text-editor]');
    const input = root.querySelector('[data-rich-text-input]');
    const toolbar = root.querySelector('[data-rich-text-toolbar]');
    const charCountElement = root.querySelector('[data-char-count]');

    if (
      !(editor instanceof HTMLElement) ||
      !(input instanceof HTMLTextAreaElement)
    )
      return;

    const updateEmptyState = () => {
      const text = editor.innerText.trim();
      editor.setAttribute('data-empty', String(text.length === 0));
    };

    const updateCharCount = () => {
      if (!showCharCount || !charCountElement) return;
      const text = editor.innerText.trim();
      const count = text.length;
      charCountElement.textContent = count.toString();
      
      if (maxLength && count > maxLength) {
        charCountElement.style.color = 'rgb(239 68 68)'; // red-500
        editor.setAttribute('aria-invalid', 'true');
      } else {
        charCountElement.style.color = '';
        editor.setAttribute('aria-invalid', 'false');
      }
    };

    const sync = (emit = true) => {
      const html = editor.innerHTML.trim();
      input.value = html;
      if (emit) {
        root.dispatchEvent(
          new CustomEvent('rich-text:change', {
            bubbles: true,
            detail: { value: html },
          })
        );
      }
      updateEmptyState();
      updateCharCount();
    };

    const exec = (command, value) => {
      if (command === 'clear') {
        document.execCommand('removeFormat');
        document.execCommand('unlink');
        return;
      }
      if (command === 'link') {
        const url = window.prompt('Enter URL');
        if (url) {
          document.execCommand('createLink', false, url);
        }
        return;
      }
      const formatValue = command === 'formatBlock' && !value ? 'p' : value;
      document.execCommand(command, false, formatValue);
    };

    // Keyboard shortcuts
    editor.addEventListener('keydown', (event) => {
      if (event.ctrlKey || event.metaKey) {
        switch (event.key.toLowerCase()) {
          case 'b':
            event.preventDefault();
            exec('bold');
            sync();
            break;
          case 'i':
            event.preventDefault();
            exec('italic');
            sync();
            break;
          case 'u':
            event.preventDefault();
            exec('underline');
            sync();
            break;
          case 'z':
            if (event.shiftKey) {
              event.preventDefault();
              exec('redo');
            } else {
              event.preventDefault();
              exec('undo');
            }
            sync();
            break;
          case 'y':
            event.preventDefault();
            exec('redo');
            sync();
            break;
        }
      }
      
      // Character limit enforcement
      if (maxLength && !event.ctrlKey && !event.metaKey) {
        const text = editor.innerText;
        if (text.length >= maxLength && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
          event.preventDefault();
        }
      }
    });

    if (toolbar instanceof HTMLElement) {
      toolbar.addEventListener('click', (event) => {
        const target =
          event.target instanceof HTMLElement
            ? event.target.closest('[data-rich-text-action]')
            : null;
        if (!(target instanceof HTMLElement)) return;
        const action = target.getAttribute('data-rich-text-action');
        if (!action) return;
        const arg = target.getAttribute('data-arg') || undefined;
        exec(action, arg);
        editor.focus();
        sync();
      });
    }

    editor.addEventListener('input', () => sync());
    editor.addEventListener('blur', () => sync());
    editor.addEventListener('paste', () => {
      // Clean up pasted content after a delay
      setTimeout(() => sync(), 10);
    });

    root.addEventListener('rich-text:set', (event) => {
      const detail = event && 'detail' in event ? event.detail : null;
      const value =
        detail && typeof detail.value === 'string' ? detail.value : '';
      editor.innerHTML = value || '';
      sync(false);
    });

    // Observe mutations caused by external scripts formatting content
    const observer = new MutationObserver(() => sync(false));
    observer.observe(editor, { childList: true, subtree: true });

    // Initialize
    updateEmptyState();
    updateCharCount();
  })();
</script>

<style is:inline>
  [data-rich-text-editor][contenteditable='true']:empty::before,
  [data-rich-text-editor][data-empty='true']::before {
    content: attr(data-placeholder);
    color: rgba(51, 65, 85, 0.7);
    pointer-events: none;
  }

  @media (prefers-color-scheme: dark) {
    [data-rich-text-editor][contenteditable='true']:empty::before,
    [data-rich-text-editor][data-empty='true']::before {
      color: rgba(148, 163, 184, 0.75);
    }
  }
</style>

<script is:inline>
  (function setupRichTextEditor() {
    const root = document.getElementById('${id}');
    if (!(root instanceof HTMLElement)) return;

    const editor = root.querySelector('[data-rich-text-editor]');
    const input = root.querySelector('[data-rich-text-input]');
    const toolbar = root.querySelector('[data-rich-text-toolbar]');

    if (
      !(editor instanceof HTMLElement) ||
      !(input instanceof HTMLTextAreaElement)
    )
      return;

    const updateEmptyState = () => {
      const text = editor.innerText.trim();
      editor.setAttribute('data-empty', String(text.length === 0));
    };

    const sync = (emit = true) => {
      const html = editor.innerHTML.trim();
      input.value = html;
      if (emit) {
        root.dispatchEvent(
          new CustomEvent('rich-text:change', {
            bubbles: true,
            detail: { value: html },
          })
        );
      }
      updateEmptyState();
    };

    const exec = (command, value) => {
      if (command === 'clear') {
        document.execCommand('removeFormat');
        document.execCommand('unlink');
        return;
      }
      if (command === 'link') {
        const url = window.prompt('Enter URL');
        if (url) {
          document.execCommand('createLink', false, url);
        }
        return;
      }
      const formatValue = command === 'formatBlock' && !value ? 'p' : value;
      document.execCommand(command, false, formatValue);
    };

    if (toolbar instanceof HTMLElement) {
      toolbar.addEventListener('click', (event) => {
        const target =
          event.target instanceof HTMLElement
            ? event.target.closest('[data-rich-text-action]')
            : null;
        if (!(target instanceof HTMLElement)) return;
        const action = target.getAttribute('data-rich-text-action');
        if (!action) return;
        const arg = target.getAttribute('data-arg') || undefined;
        exec(action, arg);
        editor.focus();
        sync();
      });
    }

    editor.addEventListener('input', () => sync());
    editor.addEventListener('blur', () => sync());

    root.addEventListener('rich-text:set', (event) => {
      const detail = event && 'detail' in event ? event.detail : null;
      const value =
        detail && typeof detail.value === 'string' ? detail.value : '';
      editor.innerHTML = value || '';
      sync(false);
    });

    // Observe mutations caused by external scripts formatting content
    const observer = new MutationObserver(() => sync(false));
    observer.observe(editor, { childList: true, subtree: true });

    updateEmptyState();
  })();
</script>
