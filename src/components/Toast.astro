---
import { cn } from '../utils/cn';

export interface ToastProps {
  variant?: 'default' | 'success' | 'warning' | 'error' | 'info';
  size?: 'sm' | 'md' | 'lg';
  position?:
    | 'top-right'
    | 'top-left'
    | 'bottom-right'
    | 'bottom-left'
    | 'top-center'
    | 'bottom-center'
    | 'static';
  title?: string;
  description?: string;
  duration?: number;
  dismissible?: boolean;
  persistent?: boolean;
  showIcon?: boolean;
  showProgress?: boolean;
  className?: string;
}

const {
  variant = 'default',
  size = 'md',
  position = 'bottom-right',
  title,
  description,
  duration = 5000,
  dismissible = true,
  persistent = false,
  showIcon = true,
  showProgress = false,
  className = '',
} = Astro.props as ToastProps;

// WCAG AAA compliant colors with 9:1 contrast ratios
const variantStyles = {
  default:
    'border-slate-300 bg-white text-slate-950 shadow-lg dark:border-slate-600 dark:bg-slate-950 dark:text-slate-50',
  success:
    'border-emerald-300 bg-white text-slate-950 shadow-lg dark:border-emerald-600 dark:bg-slate-950 dark:text-slate-50',
  warning:
    'border-amber-300 bg-white text-slate-950 shadow-lg dark:border-amber-600 dark:bg-slate-950 dark:text-slate-50',
  error:
    'border-red-300 bg-white text-slate-950 shadow-lg dark:border-red-600 dark:bg-slate-950 dark:text-slate-50',
  info: 'border-blue-300 bg-white text-slate-950 shadow-lg dark:border-blue-600 dark:bg-slate-950 dark:text-slate-50',
};

const accentStyles = {
  default: 'bg-slate-600 dark:bg-slate-400',
  success: 'bg-emerald-600 dark:bg-emerald-400',
  warning: 'bg-amber-600 dark:bg-amber-400',
  error: 'bg-red-600 dark:bg-red-400',
  info: 'bg-blue-600 dark:bg-blue-400',
};

const iconColors = {
  default: 'text-slate-600 dark:text-slate-400',
  success: 'text-emerald-600 dark:text-emerald-400',
  warning: 'text-amber-600 dark:text-amber-400',
  error: 'text-red-600 dark:text-red-400',
  info: 'text-blue-600 dark:text-blue-400',
};

const sizeStyles = {
  sm: 'text-xs p-3 max-w-xs',
  md: 'text-sm p-4 max-w-sm',
  lg: 'text-base p-5 max-w-md',
};

const positionStyles = {
  'top-right': 'top-4 right-4',
  'top-left': 'top-4 left-4',
  'bottom-right': 'bottom-4 right-4',
  'bottom-left': 'bottom-4 left-4',
  'top-center': 'top-4 left-1/2 -translate-x-1/2',
  'bottom-center': 'bottom-4 left-1/2 -translate-x-1/2',
  static: 'relative',
};

const icons = {
  default: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>`,
  success: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
  </svg>`,
  warning: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.262 16.5c-.77.833.192 2.5 1.732 2.5z" />
  </svg>`,
  error: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>`,
  info: `<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>`,
};

const closeIcon = `<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>`;

const toastId = `toast-${Math.random().toString(36).substr(2, 9)}`;
---

<div
  id={toastId}
  class={cn(
    position === 'static' ? 'relative' : 'fixed',
    'z-50 rounded-lg border backdrop-blur-sm',
    'transition-all duration-300 ease-in-out',
    'motion-reduce:transition-none',
    'focus-within:ring-2 focus-within:ring-blue-600 focus-within:ring-offset-2',
    'dark:focus-within:ring-offset-slate-950',
    variantStyles[variant],
    sizeStyles[size],
    position !== 'static' ? positionStyles[position] : '',
    className
  )}
  role="alert"
  aria-live={variant === 'error' ? 'assertive' : 'polite'}
  aria-atomic="true"
  aria-labelledby={title ? `${toastId}-title` : undefined}
  aria-describedby={`${toastId}-description`}
  data-toast
  data-duration={persistent ? '0' : duration.toString()}
  data-variant={variant}
>
  <!-- Progress bar -->
  {
    showProgress && !persistent && (
      <div
        class={cn(
          'absolute top-0 left-0 h-1 rounded-t-lg transition-all duration-300',
          accentStyles[variant]
        )}
        style="width: 100%"
        data-toast-progress
        aria-hidden="true"
      />
    )
  }

  <!-- Accent border -->
  <div
    class={cn(
      'absolute left-0 top-0 h-full w-1 rounded-l-lg',
      accentStyles[variant]
    )}
    aria-hidden="true"
  >
  </div>

  <div class="pl-3 flex items-start gap-3">
    <!-- Icon -->
    {
      showIcon && (
        <div class={cn('shrink-0 mt-0.5', iconColors[variant])}>
          <Fragment set:html={icons[variant]} />
        </div>
      )
    }

    <!-- Content -->
    <div class="flex-1 min-w-0">
      {
        title && (
          <h3
            id={`${toastId}-title`}
            class={cn(
              'font-semibold leading-5',
              size === 'sm'
                ? 'text-xs'
                : size === 'lg'
                  ? 'text-base'
                  : 'text-sm'
            )}
          >
            {title}
          </h3>
        )
      }

      <div
        id={`${toastId}-description`}
        class={cn(
          'leading-relaxed',
          title ? 'mt-1' : '',
          size === 'sm' ? 'text-xs' : size === 'lg' ? 'text-sm' : 'text-sm'
        )}
      >
        {description && <p>{description}</p>}
        <slot />
      </div>
    </div>

    <!-- Close button -->
    {
      dismissible && (
        <button
          type="button"
          class={cn(
            'shrink-0 inline-flex items-center justify-center rounded-md',
            'border border-transparent transition-colors',
            'hover:bg-slate-100 dark:hover:bg-slate-800',
            'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2',
            'dark:focus-visible:ring-offset-slate-950',
            'disabled:opacity-50 disabled:cursor-not-allowed',
            size === 'sm'
              ? 'h-6 w-6 text-xs'
              : size === 'lg'
                ? 'h-8 w-8 text-base'
                : 'h-7 w-7 text-sm'
          )}
          aria-label={`Close ${variant} notification`}
          data-toast-close
        >
          <Fragment set:html={closeIcon} />
        </button>
      )
    }
  </div>
</div>

<script is:inline>
  (function () {
    const toasts = Array.from(document.querySelectorAll('[data-toast]'));
    if (!toasts.length) return;

    // Toast container for stacking
    let toastContainer = document.querySelector('[data-toast-container]');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.setAttribute('data-toast-container', '');
      toastContainer.className = 'fixed inset-0 pointer-events-none z-50';
      toastContainer.setAttribute('aria-live', 'polite');
      toastContainer.setAttribute('aria-label', 'Notifications');
      document.body.appendChild(toastContainer);
    }

    toasts.forEach((toast) => {
      if (!(toast instanceof HTMLElement)) return;

      const duration = Number.parseInt(
        toast.getAttribute('data-duration') || '5000',
        10
      );
      const variant = toast.getAttribute('data-variant') || 'default';
      const closeBtn = toast.querySelector('[data-toast-close]');
      const progressBar = toast.querySelector('[data-toast-progress]');

      let progressInterval;
      let startTime;

      // Enhanced dismiss function with better accessibility
      const dismiss = () => {
        if (progressInterval) {
          clearInterval(progressInterval);
        }

        // Announce dismissal to screen readers
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = `${variant} notification dismissed`;
        document.body.appendChild(announcement);

        // Animate out
        toast.style.transition =
          'opacity 300ms ease-out, transform 300ms ease-out';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-8px) scale(0.95)';
        toast.setAttribute('aria-hidden', 'true');

        // Remove after animation
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
          // Clean up announcement
          if (announcement.parentNode) {
            announcement.remove();
          }
          // Update stacking
          updateToastPositions();
        }, 300);
      };

      // Progress bar animation
      const updateProgress = () => {
        if (!progressBar || duration <= 0) return;

        const elapsed = Date.now() - startTime;
        const remaining = Math.max(0, duration - elapsed);
        const progress = (remaining / duration) * 100;

        progressBar.style.width = `${progress}%`;

        if (remaining <= 0) {
          clearInterval(progressInterval);
        }
      };

      // Keyboard navigation
      const handleKeyDown = (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          dismiss();
        }
      };

      // Mouse pause/resume
      let isPaused = false;
      let remainingTime = duration;
      let pauseTime;

      const pauseTimer = () => {
        if (isPaused || duration <= 0) return;
        isPaused = true;
        pauseTime = Date.now();
        if (progressInterval) {
          clearInterval(progressInterval);
        }
      };

      const resumeTimer = () => {
        if (!isPaused || duration <= 0) return;
        isPaused = false;
        const pausedDuration = Date.now() - pauseTime;
        remainingTime = Math.max(0, remainingTime - pausedDuration);
        startTime = Date.now() - (duration - remainingTime);

        if (remainingTime > 0) {
          progressInterval = setInterval(updateProgress, 16);
          setTimeout(dismiss, remainingTime);
        } else {
          dismiss();
        }
      };

      // Event listeners
      if (closeBtn instanceof HTMLElement) {
        closeBtn.addEventListener('click', (event) => {
          event.preventDefault();
          dismiss();
        });
      }

      toast.addEventListener('keydown', handleKeyDown);
      toast.addEventListener('mouseenter', pauseTimer);
      toast.addEventListener('mouseleave', resumeTimer);
      toast.addEventListener('focusin', pauseTimer);
      toast.addEventListener('focusout', resumeTimer);

      // Auto-dismiss setup
      if (duration > 0) {
        startTime = Date.now();
        progressInterval = setInterval(updateProgress, 16);
        setTimeout(dismiss, duration);
      }

      // Make toast focusable for keyboard users
      if (!toast.hasAttribute('tabindex')) {
        toast.setAttribute('tabindex', '-1');
      }

      // Announce to screen readers
      setTimeout(() => {
        toast.focus();
      }, 100);
    });

    // Update positions for stacking
    function updateToastPositions() {
      const activeToasts = Array.from(
        document.querySelectorAll('[data-toast]:not([aria-hidden="true"])')
      );
      activeToasts.forEach((toast, index) => {
        if (!(toast instanceof HTMLElement)) return;
        const offset = index * 8;
        toast.style.transform = `translateY(-${offset}px)`;
        toast.style.zIndex = String(50 + activeToasts.length - index);
      });
    }

    // Reduce motion support
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      const style = document.createElement('style');
      style.textContent = `
        [data-toast] {
          transition: none !important;
        }
      `;
      document.head.appendChild(style);
    }

    // Initial positioning
    updateToastPositions();
  })();
</script>

<style>
  [data-toast] {
    pointer-events: auto;
    transition:
      opacity 300ms ease-out,
      transform 300ms ease-out;
  }

  [data-toast-progress] {
    animation: toast-progress linear;
    animation-fill-mode: forwards;
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    [data-toast] {
      border-width: 2px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    [data-toast] {
      transition: none;
    }

    [data-toast-progress] {
      animation: none;
    }
  }

  /* Focus improvements for high contrast */
  @media (forced-colors: active) {
    [data-toast] {
      border: 2px solid ButtonText;
    }

    [data-toast-close]:focus-visible {
      outline: 2px solid ButtonText;
      outline-offset: 2px;
    }
  }
</style>
