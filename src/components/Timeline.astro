---
import { cn } from '../utils/cn';

export interface Event {
  date: string;
  title: string;
  description?: string;
  icon?: string;
  variant?: 'default' | 'success' | 'warning' | 'error' | 'info';
  href?: string;
  target?: '_blank' | '_self';
}

interface Props {
  events: Event[];
  variant?: 'default' | 'minimal' | 'bordered' | 'filled';
  size?: 'sm' | 'md' | 'lg';
  orientation?: 'vertical' | 'horizontal';
  showConnector?: boolean;
  dense?: boolean;
  className?: string;
  ariaLabel?: string;
}

const {
  events,
  variant = 'default',
  size = 'md',
  orientation = 'vertical',
  showConnector = true,
  dense = false,
  className = '',
  ariaLabel = 'Timeline of events',
} = Astro.props;

// Validate events
if (!events || !Array.isArray(events) || events.length === 0) {
  throw new Error('Timeline: events array is required and must not be empty');
}

// Size configurations
const sizeConfig = {
  sm: {
    marker: 'w-6 h-6 border-2',
    markerIcon: 'text-xs',
    content: 'p-3',
    spacing: dense ? 'space-y-4' : 'space-y-6',
    offset: orientation === 'vertical' ? 'pl-8' : 'pt-8',
    connector: orientation === 'vertical' ? 'left-3 w-0.5' : 'top-3 h-0.5',
    date: 'text-xs',
    title: 'text-sm',
    description: 'text-xs',
  },
  md: {
    marker: 'w-8 h-8 border-4',
    markerIcon: 'text-sm',
    content: 'p-4',
    spacing: dense ? 'space-y-6' : 'space-y-8',
    offset: orientation === 'vertical' ? 'pl-12' : 'pt-12',
    connector: orientation === 'vertical' ? 'left-4 w-0.5' : 'top-4 h-0.5',
    date: 'text-xs',
    title: 'text-base',
    description: 'text-sm',
  },
  lg: {
    marker: 'w-10 h-10 border-4',
    markerIcon: 'text-base',
    content: 'p-5',
    spacing: dense ? 'space-y-8' : 'space-y-10',
    offset: orientation === 'vertical' ? 'pl-16' : 'pt-16',
    connector: orientation === 'vertical' ? 'left-5 w-1' : 'top-5 h-1',
    date: 'text-sm',
    title: 'text-lg',
    description: 'text-base',
  },
};

// Variant configurations with WCAG AAA contrast
const timelineVariantConfig = {
  default: {
    connector: [
      'bg-slate-200 dark:bg-slate-700',
      'contrast-more:bg-slate-800 contrast-more:dark:bg-slate-200',
    ],
    content: [
      'border border-slate-200 dark:border-slate-700',
      'bg-white dark:bg-slate-950',
      'shadow-sm',
      'contrast-more:border-slate-800 contrast-more:dark:border-slate-200',
      'contrast-more:bg-white contrast-more:dark:bg-slate-900',
    ],
  },
  minimal: {
    connector: [
      'bg-slate-300 dark:bg-slate-600',
      'contrast-more:bg-slate-800 contrast-more:dark:bg-slate-200',
    ],
    content: ['border-0', 'bg-transparent', 'shadow-none'],
  },
  bordered: {
    connector: [
      'bg-slate-300 dark:bg-slate-600',
      'contrast-more:bg-slate-800 contrast-more:dark:bg-slate-200',
    ],
    content: [
      'border-2 border-slate-300 dark:border-slate-600',
      'bg-white dark:bg-slate-950',
      'shadow-md',
      'contrast-more:border-slate-800 contrast-more:dark:border-slate-200',
      'contrast-more:bg-white contrast-more:dark:bg-slate-900',
    ],
  },
  filled: {
    connector: [
      'bg-slate-400 dark:bg-slate-500',
      'contrast-more:bg-slate-800 contrast-more:dark:bg-slate-200',
    ],
    content: [
      'border border-slate-200 dark:border-slate-700',
      'bg-slate-50 dark:bg-slate-900',
      'shadow-sm',
      'contrast-more:border-slate-800 contrast-more:dark:border-slate-200',
      'contrast-more:bg-slate-100 contrast-more:dark:bg-slate-800',
    ],
  },
};

// Event variant configurations with enhanced contrast
const eventVariantConfig = {
  default: {
    marker: [
      'bg-blue-600 dark:bg-blue-500',
      'text-white dark:text-slate-950',
      'border-white dark:border-slate-950',
      'contrast-more:bg-blue-800 contrast-more:dark:bg-blue-400',
      'contrast-more:text-white contrast-more:dark:text-slate-950',
    ],
  },
  success: {
    marker: [
      'bg-green-600 dark:bg-green-500',
      'text-white dark:text-slate-950',
      'border-white dark:border-slate-950',
      'contrast-more:bg-green-800 contrast-more:dark:bg-green-400',
      'contrast-more:text-white contrast-more:dark:text-slate-950',
    ],
  },
  warning: {
    marker: [
      'bg-amber-500 dark:bg-amber-400',
      'text-slate-950 dark:text-slate-950',
      'border-white dark:border-slate-950',
      'contrast-more:bg-amber-600 contrast-more:dark:bg-amber-300',
      'contrast-more:text-slate-950',
    ],
  },
  error: {
    marker: [
      'bg-red-600 dark:bg-red-500',
      'text-white dark:text-slate-950',
      'border-white dark:border-slate-950',
      'contrast-more:bg-red-800 contrast-more:dark:bg-red-400',
      'contrast-more:text-white contrast-more:dark:text-slate-950',
    ],
  },
  info: {
    marker: [
      'bg-cyan-600 dark:bg-cyan-500',
      'text-white dark:text-slate-950',
      'border-white dark:border-slate-950',
      'contrast-more:bg-cyan-800 contrast-more:dark:bg-cyan-400',
      'contrast-more:text-white contrast-more:dark:text-slate-950',
    ],
  },
};

const currentSize = sizeConfig[size];
const currentTimelineVariant = timelineVariantConfig[variant];

// Generate unique IDs for accessibility
const timelineId = `timeline-${Math.random().toString(36).substr(2, 9)}`;
---

<div
  id={timelineId}
  class={cn(
    // Base layout
    'relative text-slate-900 dark:text-slate-100',
    'contrast-more:text-slate-950 contrast-more:dark:text-white',

    // Orientation
    orientation === 'horizontal' ? 'flex overflow-x-auto' : 'block',

    className
  )}
  role="region"
  aria-label={ariaLabel}
  aria-orientation={orientation}
>
  {/* Timeline connector line */}
  {
    showConnector && (
      <div
        class={cn(
          'absolute',
          orientation === 'vertical' ? 'top-0 bottom-0' : 'left-0 right-0',
          currentSize.connector,
          currentTimelineVariant.connector
        )}
        aria-hidden="true"
      />
    )
  }

  {/* Events list */}
  <ol
    class={cn(
      orientation === 'vertical' ? currentSize.spacing : 'flex gap-8',
      'list-none m-0 p-0'
    )}
  >
    {
      events.map((event, index) => {
        const eventVariant = event.variant || 'default';
        const currentEventVariant = eventVariantConfig[eventVariant];
        const isLast = index === events.length - 1;

        const EventWrapper = event.href ? 'a' : 'div';
        const eventProps = event.href
          ? {
              href: event.href,
              target: event.target || '_self',
              rel:
                event.target === '_blank' ? 'noopener noreferrer' : undefined,
            }
          : {};

        return (
          <li
            class={cn(
              'relative',
              orientation === 'vertical' ? currentSize.offset : 'shrink-0'
            )}
            role="listitem"
          >
            {/* Event marker */}
            <div
              class={cn(
                // Position
                'absolute flex items-center justify-center rounded-full shadow-sm z-10',
                orientation === 'vertical' ? 'left-0' : 'top-0',

                // Size and styling
                currentSize.marker,
                currentEventVariant.marker,

                // Focus styles for interactive markers
                event.href && [
                  'focus-within:ring-2 focus-within:ring-blue-600 focus-within:ring-offset-2',
                  'focus-within:ring-offset-white dark:focus-within:ring-offset-slate-950',
                  'contrast-more:focus-within:ring-blue-800',
                ]
              )}
              role={event.href ? 'button' : 'presentation'}
              aria-label={event.href ? `Go to ${event.title}` : undefined}
              tabindex={event.href ? 0 : -1}
            >
              {event.icon ? (
                <span
                  class={cn(currentSize.markerIcon, 'select-none')}
                  aria-hidden="true"
                  role="img"
                  aria-label={`${eventVariant} event`}
                >
                  {event.icon}
                </span>
              ) : (
                <span
                  class={cn('w-2 h-2 rounded-full', 'bg-current opacity-80')}
                  aria-hidden="true"
                />
              )}
            </div>

            {/* Event content */}
            <EventWrapper
              {...eventProps}
              class={cn(
                // Base styles
                'block rounded-lg transition-all duration-150',

                // Size and spacing
                currentSize.content,

                // Variant styling
                currentTimelineVariant.content,

                // Interactive styles
                event.href && [
                  'cursor-pointer hover:shadow-md',
                  'focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600',
                  'focus-visible:ring-offset-2 focus-visible:ring-offset-white',
                  'dark:focus-visible:ring-offset-slate-950',
                  'contrast-more:focus-visible:ring-blue-800',
                  'hover:bg-slate-50 dark:hover:bg-slate-900',
                  'contrast-more:hover:bg-slate-100 contrast-more:dark:hover:bg-slate-800',
                ],

                // Motion preferences
                'motion-safe:transition-all motion-reduce:transition-none'
              )}
              role={event.href ? 'link' : 'article'}
              aria-describedby={`${timelineId}-event-${index}`}
            >
              {/* Event date */}
              <time
                class={cn(
                  currentSize.date,
                  'font-medium uppercase tracking-wide',
                  'text-slate-600 dark:text-slate-400',
                  'contrast-more:text-slate-950 contrast-more:dark:text-white',
                  'block'
                )}
                datetime={event.date}
              >
                {new Date(event.date).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })}
              </time>

              {/* Event title */}
              <h3
                class={cn(
                  currentSize.title,
                  'font-semibold mt-1',
                  'text-slate-900 dark:text-slate-100',
                  'contrast-more:text-slate-950 contrast-more:dark:text-white'
                )}
              >
                {event.title}
                {event.href && <span class="sr-only"> (link)</span>}
              </h3>

              {/* Event description */}
              {event.description && (
                <p
                  id={`${timelineId}-event-${index}`}
                  class={cn(
                    currentSize.description,
                    'mt-2 leading-relaxed',
                    'text-slate-700 dark:text-slate-300',
                    'contrast-more:text-slate-950 contrast-more:dark:text-white'
                  )}
                >
                  {event.description}
                </p>
              )}

              {/* External link indicator */}
              {event.href && event.target === '_blank' && (
                <span
                  class={cn(
                    'inline-flex items-center gap-1 mt-2',
                    currentSize.description,
                    'text-blue-600 dark:text-blue-400',
                    'contrast-more:text-blue-800 contrast-more:dark:text-blue-300'
                  )}
                >
                  <span>Open in new tab</span>
                  <svg
                    class="w-3 h-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    aria-hidden="true"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                    />
                  </svg>
                </span>
              )}
            </EventWrapper>

            {/* Screen reader position indicator */}
            <span class="sr-only">
              Event {index + 1} of {events.length}
              {isLast ? ' (final event)' : ''}
            </span>
          </li>
        );
      })
    }
  </ol>
</div>

{/* Enhanced keyboard navigation script */}
<script is:inline define:vars={{ timelineId }}>
  (function () {
    const timeline = document.getElementById(timelineId);
    if (!timeline) return;

    const interactiveElements = timeline.querySelectorAll(
      '[role="button"], [role="link"]'
    );
    if (interactiveElements.length === 0) return;

    // Enhanced keyboard navigation for timeline
    timeline.addEventListener('keydown', (event) => {
      const currentIndex = Array.from(interactiveElements).findIndex(
        (el) =>
          document.activeElement === el || el.contains(document.activeElement)
      );

      if (currentIndex === -1) return;

      let newIndex = currentIndex;

      switch (event.key) {
        case 'ArrowDown':
        case 'ArrowRight':
          event.preventDefault();
          newIndex = Math.min(currentIndex + 1, interactiveElements.length - 1);
          break;

        case 'ArrowUp':
        case 'ArrowLeft':
          event.preventDefault();
          newIndex = Math.max(currentIndex - 1, 0);
          break;

        case 'Home':
          event.preventDefault();
          newIndex = 0;
          break;

        case 'End':
          event.preventDefault();
          newIndex = interactiveElements.length - 1;
          break;

        default:
          return;
      }

      // Focus new element
      const newElement = interactiveElements[newIndex];
      if (newElement) {
        newElement.focus();

        // Announce position to screen readers
        const announcement = document.createElement('div');
        announcement.className = 'sr-only';
        announcement.setAttribute('aria-live', 'polite');
        announcement.textContent = `Focused on event ${newIndex + 1} of ${interactiveElements.length}`;
        timeline.appendChild(announcement);

        setTimeout(() => {
          if (announcement.parentNode) {
            announcement.parentNode.removeChild(announcement);
          }
        }, 1000);
      }
    });

    // Handle click events for marker buttons
    timeline.addEventListener('click', (event) => {
      const marker = event.target.closest('[role="button"]');
      if (!marker) return;

      const listItem = marker.closest('li');
      const link = listItem?.querySelector('a[href]');

      if (link) {
        event.preventDefault();
        link.click();
      }
    });
  })();
</script>
