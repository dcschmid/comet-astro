---
/**
 * PublicHolidays - Feiertage nach Land und Region
 *
 * Zeigt kommende Feiertage mit optionaler Filterung nach Bundesland.
 *
 * API: https://date.nager.at/
 */
import { cn } from '../utils/cn';

interface Holiday {
  date: string;
  localName: string;
  name: string;
  countryCode: string;
  global: boolean;
  counties: string[] | null;
  types: string[];
}

interface Props {
  country?: string;
  year?: number;
  region?: string; // e.g. "DE-BY" for Bayern
  maxItems?: number;
  showPast?: boolean;
  showCountdown?: boolean;
  compact?: boolean;
  className?: string;
}

const {
  country = 'DE',
  year = new Date().getFullYear(),
  region,
  maxItems = 10,
  showPast = false,
  showCountdown = true,
  compact = false,
  className = '',
} = Astro.props;

let holidays: Holiday[] = [];
let error: string | null = null;

const countryNames: Record<string, { name: string; flag: string }> = {
  DE: { name: 'Deutschland', flag: 'ğŸ‡©ğŸ‡ª' },
  AT: { name: 'Ã–sterreich', flag: 'ğŸ‡¦ğŸ‡¹' },
  CH: { name: 'Schweiz', flag: 'ğŸ‡¨ğŸ‡­' },
  US: { name: 'USA', flag: 'ğŸ‡ºğŸ‡¸' },
  GB: { name: 'GroÃŸbritannien', flag: 'ğŸ‡¬ğŸ‡§' },
  FR: { name: 'Frankreich', flag: 'ğŸ‡«ğŸ‡·' },
  IT: { name: 'Italien', flag: 'ğŸ‡®ğŸ‡¹' },
  ES: { name: 'Spanien', flag: 'ğŸ‡ªğŸ‡¸' },
  NL: { name: 'Niederlande', flag: 'ğŸ‡³ğŸ‡±' },
  PL: { name: 'Polen', flag: 'ğŸ‡µğŸ‡±' },
};

const regionNames: Record<string, string> = {
  'DE-BW': 'Baden-WÃ¼rttemberg',
  'DE-BY': 'Bayern',
  'DE-BE': 'Berlin',
  'DE-BB': 'Brandenburg',
  'DE-HB': 'Bremen',
  'DE-HH': 'Hamburg',
  'DE-HE': 'Hessen',
  'DE-MV': 'Mecklenburg-Vorpommern',
  'DE-NI': 'Niedersachsen',
  'DE-NW': 'Nordrhein-Westfalen',
  'DE-RP': 'Rheinland-Pfalz',
  'DE-SL': 'Saarland',
  'DE-SN': 'Sachsen',
  'DE-ST': 'Sachsen-Anhalt',
  'DE-SH': 'Schleswig-Holstein',
  'DE-TH': 'ThÃ¼ringen',
};

try {
  const res = await fetch(
    `https://date.nager.at/api/v3/PublicHolidays/${year}/${country}`
  );
  if (res.ok) {
    let data: Holiday[] = await res.json();

    // Filter by region if specified
    if (region) {
      data = data.filter(
        (h) => h.global || (h.counties && h.counties.includes(region))
      );
    }

    // Filter past holidays
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (!showPast) {
      data = data.filter((h) => new Date(h.date) >= today);
    }

    holidays = data.slice(0, maxItems);
  } else {
    error = `Fehler (${res.status})`;
  }
} catch {
  error = 'Verbindungsfehler';
}

function getDaysUntil(dateStr: string): number {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const target = new Date(dateStr);
  return Math.ceil(
    (target.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)
  );
}

function isToday(dateStr: string): boolean {
  return getDaysUntil(dateStr) === 0;
}

function isTomorrow(dateStr: string): boolean {
  return getDaysUntil(dateStr) === 1;
}

function isThisWeek(dateStr: string): boolean {
  const days = getDaysUntil(dateStr);
  return days > 1 && days <= 7;
}

// Date formatting utility
// const _formatDate = (dateStr: string): string => {
//   return new Date(dateStr).toLocaleDateString('de-DE', {
//     weekday: 'short',
//     day: 'numeric',
//     month: 'short'
//   });
// };

const countryInfo = countryNames[country] || { name: country, flag: 'ğŸ³ï¸' };
const regionName = region ? regionNames[region] || region : null;
---

<div
  class={cn(
    'rounded-2xl bg-gradient-to-br from-slate-800/90 to-slate-900/90 border border-slate-700/50 overflow-hidden',
    className
  )}
>
  <header class="px-5 py-4 border-b border-slate-700/50 bg-rose-500/5">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div
          class="p-2.5 rounded-xl bg-gradient-to-br from-rose-500 to-pink-600 shadow-lg shadow-rose-500/25"
        >
          <svg
            class="w-5 h-5 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-slate-100 text-lg">
            Feiertage {countryInfo.flag}
          </h3>
          <p class="text-xs text-slate-400">
            {regionName || countryInfo.name}
            {year}
          </p>
        </div>
      </div>

      {
        holidays.length > 0 && (
          <span class="px-3 py-1.5 rounded-full text-xs font-semibold bg-rose-500/20 text-rose-300 border border-rose-500/30">
            {holidays.length} kommend
          </span>
        )
      }
    </div>
  </header>

  <div class={cn('p-4', compact && 'p-3')}>
    {
      error ? (
        <div class="p-4 rounded-xl bg-red-950/50 border border-red-500/30 text-red-300 text-sm flex items-center gap-2">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          {error}
        </div>
      ) : holidays.length === 0 ? (
        <div class="py-8 text-center">
          <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-slate-700/50 flex items-center justify-center">
            <svg
              class="w-7 h-7 text-slate-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </div>
          <p class="text-slate-400 font-medium">Keine Feiertage</p>
          <p class="text-slate-500 text-sm mt-1">FÃ¼r diesen Zeitraum</p>
        </div>
      ) : (
        <div class={cn('space-y-2', compact && 'space-y-1.5')}>
          {holidays.map((holiday) => (
            <article
              class={cn(
                'flex items-center gap-4 p-3 rounded-xl border transition-all',
                isToday(holiday.date)
                  ? 'bg-rose-950/30 border-rose-500/30'
                  : 'bg-slate-800/30 border-slate-700/30 hover:border-slate-600/50'
              )}
            >
              <div
                class={cn(
                  'shrink-0 w-14 text-center p-2 rounded-lg',
                  isToday(holiday.date) ? 'bg-rose-500/30' : 'bg-slate-700/50'
                )}
              >
                <div
                  class={cn(
                    'text-xs uppercase',
                    isToday(holiday.date) ? 'text-rose-300' : 'text-slate-500'
                  )}
                >
                  {new Date(holiday.date).toLocaleDateString('de-DE', {
                    weekday: 'short',
                  })}
                </div>
                <div
                  class={cn(
                    'text-lg font-bold',
                    isToday(holiday.date) ? 'text-rose-200' : 'text-slate-200'
                  )}
                >
                  {new Date(holiday.date).getDate()}
                </div>
                <div
                  class={cn(
                    'text-xs',
                    isToday(holiday.date) ? 'text-rose-300' : 'text-slate-500'
                  )}
                >
                  {new Date(holiday.date).toLocaleDateString('de-DE', {
                    month: 'short',
                  })}
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-slate-100">
                  {holiday.localName}
                </h4>
                {!compact && holiday.localName !== holiday.name && (
                  <p class="text-xs text-slate-500 mt-0.5">{holiday.name}</p>
                )}
                {!compact && !holiday.global && holiday.counties && (
                  <p class="text-xs text-slate-600 mt-1">
                    Nur in:{' '}
                    {holiday.counties
                      .slice(0, 3)
                      .map((c) => regionNames[c] || c)
                      .join(', ')}
                    {holiday.counties.length > 3 &&
                      ` +${holiday.counties.length - 3}`}
                  </p>
                )}
              </div>

              {showCountdown && (
                <div class="shrink-0 text-right">
                  {isToday(holiday.date) ? (
                    <span class="px-2 py-1 text-xs font-bold bg-rose-500/30 text-rose-200 rounded">
                      HEUTE
                    </span>
                  ) : isTomorrow(holiday.date) ? (
                    <span class="px-2 py-1 text-xs font-semibold bg-amber-500/20 text-amber-300 rounded">
                      Morgen
                    </span>
                  ) : isThisWeek(holiday.date) ? (
                    <span class="text-sm font-semibold text-amber-400">
                      in {getDaysUntil(holiday.date)} Tagen
                    </span>
                  ) : (
                    <span class="text-sm text-slate-500">
                      in {getDaysUntil(holiday.date)} Tagen
                    </span>
                  )}
                </div>
              )}
            </article>
          ))}
        </div>
      )
    }
  </div>

  <footer
    class="px-5 py-3 border-t border-slate-700/50 bg-slate-800/30 flex items-center justify-between text-xs text-slate-500"
  >
    <span>Daten: Nager.Date API</span>
    <a
      href="https://date.nager.at"
      target="_blank"
      rel="noopener"
      class="text-blue-400 hover:text-blue-300"
    >
      date.nager.at â†’
    </a>
  </footer>
</div>
