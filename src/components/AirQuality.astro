---
/**
 * AirQuality - Accessible air quality monitoring component
 * WCAG AAA compliant air quality display with real-time data
 */

interface Props {
  latitude?: number;
  longitude?: number;
  location?: string;
  aqiSystem?: 'european' | 'us' | 'both';
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
  variant?: 'default' | 'minimal' | 'dashboard';
  showHealthAdvice?: boolean;
  class?: string;
}

const {
  latitude,
  longitude,
  location,
  aqiSystem = 'both',
  size = 'md',
  showHealthAdvice = true,
  language = 'en',
  domain = 'both',
  class: className = '',
  ...rest
} = Astro.props;

// Server-side translations used for template rendering
const TRANSLATIONS = {
  en: {
    aria_for: 'Air quality information for',
    air_quality: 'Air Quality',
    updating: 'Updating...',
    loading_data: 'Loading air quality data...',
    error_title: 'Air quality data unavailable',
    try_again: 'Try again',
    eu_aqi: 'European AQI',
    us_aqi: 'US AQI',
    health_recommendations: 'Health Recommendations',
    general_population: 'General Population',
    sensitive_individuals: 'Sensitive Individuals',
    assessing: 'Air quality is being assessed...',
    no_pollutant_data: 'No pollutant concentration data available for this location.',
    legend_text: 'Values are latest hourly concentrations. Badges are colored by indicative severity vs. typical thresholds (e.g. PM2.5 35 ¬µg/m¬≥).',
    explainer_summary: 'What do these abbreviations mean?',
    explainer_pm2_5: 'PM2.5: Particulate Matter ‚â§2.5 ¬µm (fine particles) ‚Äî penetrates deep into lungs.',
    explainer_pm10: 'PM10: Particulate Matter ‚â§10 ¬µm (coarse particles) ‚Äî respiratory irritation risk.',
    explainer_no2: 'NO2: Nitrogen Dioxide ‚Äî from traffic and combustion; can irritate airways.',
    explainer_o3: 'O3: Ozone (ground-level) ‚Äî formed by reactions in sunlight; affects breathing.',
    explainer_so2: 'SO2: Sulfur Dioxide ‚Äî from burning sulfur-containing fuels; respiratory effects.',
    explainer_co: 'CO: Carbon Monoxide ‚Äî reduces oxygen delivery in the body at high levels.',
    updated: 'Updated:',
  measured_label: 'Measured:',
    location_denied: 'Location access denied. Please provide coordinates.',
    fetch_failed: 'Failed to fetch air quality data.'
    ,
    advice_excellent_general: 'Air quality is excellent. Perfect for outdoor activities.',
    advice_excellent_sensitive: 'Air quality is safe for everyone.',
    advice_acceptable_general: 'Air quality is acceptable for most people.',
    advice_acceptable_sensitive: 'Consider reducing prolonged outdoor exertion.',
    advice_moderate_general: 'Air quality is moderate ‚Äî some individuals may experience symptoms.',
    advice_moderate_sensitive: 'People with respiratory conditions should reduce prolonged or heavy outdoor exertion.',
    advice_poor_general: 'Air quality is poor. Reduce outdoor activities.',
    advice_poor_sensitive: 'Sensitive groups: avoid prolonged outdoor exertion; consider staying indoors.',
    advice_very_poor_general: 'Air quality is very poor. Avoid outdoor activities.',
    advice_very_poor_sensitive: 'Sensitive groups: remain indoors and follow medical advice.',
    advice_hazardous_general: 'Air quality is hazardous. Stay indoors and limit exposure.',
    advice_hazardous_sensitive: 'Everyone should avoid outdoor activities; follow local health guidance.',
    elevated_note: 'Elevated pollutant levels detected:'
    , measured_others_not: '(others not available)'
  },
  de: {
    aria_for: 'Luftqualit√§tsinformationen f√ºr',
    air_quality: 'Luftqualit√§t',
    updating: 'Aktualisiere...',
    loading_data: 'Lade Luftqualit√§tsdaten...',
    error_title: 'Luftdaten nicht verf√ºgbar',
    try_again: 'Erneut versuchen',
    eu_aqi: 'EU‚ÄëAQI',
    us_aqi: 'US‚ÄëAQI',
    health_recommendations: 'Gesundheitsempfehlungen',
    general_population: 'Allgemeine Bev√∂lkerung',
    sensitive_individuals: 'Empfindliche Personen',
    assessing: 'Die Luftqualit√§t wird gepr√ºft...',
    no_pollutant_data: 'F√ºr diesen Ort liegen keine Schadstoffkonzentrationen vor.',
    legend_text: 'Werte sind aktuelle Stundenmittel. Badges zeigen die indizielle Schwere im Vergleich zu typischen Schwellen (z. B. PM2.5 35 ¬µg/m¬≥).',
    explainer_summary: 'Was bedeuten die Abk√ºrzungen?',
    explainer_pm2_5: 'PM2.5: Partikel ‚â§2.5 ¬µm (fein) ‚Äî dringen tief in die Lunge ein.',
    explainer_pm10: 'PM10: Partikel ‚â§10 ¬µm (grob) ‚Äî kann Atemwege reizen.',
    explainer_no2: 'NO2: Stickstoffdioxid ‚Äî aus Verkehr/Verbrennung; reizt die Atemwege.',
    explainer_o3: 'O3: Bodennahes Ozon ‚Äî entsteht in Sonnenlicht; belastet die Atmung.',
    explainer_so2: 'SO2: Schwefeldioxid ‚Äî aus schwefelhaltigen Brennstoffen; Atemwege betroffen.',
    explainer_co: 'CO: Kohlenmonoxid ‚Äî verringert Sauerstofftransport im K√∂rper.',
    updated: 'Aktualisiert:',
  measured_label: 'Gemessen:',
    location_denied: 'Standortzugriff verweigert. Bitte Koordinaten angeben.',
    fetch_failed: 'Abruf der Luftdaten fehlgeschlagen.'
    ,
    advice_excellent_general: 'Die Luftqualit√§t ist ausgezeichnet. Ideal f√ºr Aktivit√§ten im Freien.',
    advice_excellent_sensitive: 'Die Luftqualit√§t ist f√ºr alle sicher.',
    advice_acceptable_general: 'Die Luftqualit√§t ist f√ºr die meisten Menschen akzeptabel.',
    advice_acceptable_sensitive: 'Reduzieren Sie l√§ngere k√∂rperliche Aktivit√§ten im Freien.',
    advice_moderate_general: 'Die Luftqualit√§t ist m√§√üig ‚Äî einige Personen k√∂nnen Symptome haben.',
    advice_moderate_sensitive: 'Personen mit Atemwegserkrankungen sollten l√§ngere oder anstrengende Aktivit√§ten im Freien reduzieren.',
    advice_poor_general: 'Die Luftqualit√§t ist schlecht. Reduzieren Sie Aktivit√§ten im Freien.',
    advice_poor_sensitive: 'Empfindliche Gruppen: Vermeiden Sie l√§ngere Aktivit√§ten im Freien; bleiben Sie wenn m√∂glich drinnen.',
    advice_very_poor_general: 'Die Luftqualit√§t ist sehr schlecht. Vermeiden Sie Aktivit√§ten im Freien.',
    advice_very_poor_sensitive: 'Empfindliche Gruppen: Bleiben Sie drinnen und befolgen Sie medizinische Anweisungen.',
    advice_hazardous_general: 'Die Luftqualit√§t ist gef√§hrlich. Bleiben Sie drinnen und begrenzen Sie die Exposition.',
    advice_hazardous_sensitive: 'Alle sollten Aktivit√§ten im Freien vermeiden; befolgen Sie lokale Gesundheitsanweisungen.',
    elevated_note: 'Erh√∂hte Schadstoffwerte festgestellt:'
    , measured_others_not: '(andere nicht verf√ºgbar)'
  },
  es: {
    aria_for: 'Informaci√≥n de la calidad del aire para',
    air_quality: 'Calidad del aire',
    updating: 'Actualizando...',
    loading_data: 'Cargando datos de calidad del aire...',
    error_title: 'Datos de calidad del aire no disponibles',
    try_again: 'Reintentar',
    eu_aqi: 'AQI Europeo',
    us_aqi: 'AQI EE. UU.',
    health_recommendations: 'Recomendaciones de salud',
    general_population: 'Poblaci√≥n general',
    sensitive_individuals: 'Personas sensibles',
    assessing: 'Se est√° evaluando la calidad del aire...',
    no_pollutant_data: 'No hay datos de concentraciones de contaminantes para esta ubicaci√≥n.',
    legend_text: 'Los valores son concentraciones horarias m√°s recientes. Los badges se colorean seg√∫n la gravedad indicativa frente a umbrales t√≠picos (ej. PM2.5 35 ¬µg/m¬≥).',
    explainer_summary: '¬øQu√© significan estas abreviaturas?',
    explainer_pm2_5: 'PM2.5: Part√≠culas ‚â§2.5 ¬µm (finas) ‚Äî penetran profundamente en los pulmones.',
    explainer_pm10: 'PM10: Part√≠culas ‚â§10 ¬µm (gruesas) ‚Äî riesgo de irritaci√≥n respiratoria.',
    explainer_no2: 'NO2: Di√≥xido de nitr√≥geno ‚Äî de tr√°fico/combusti√≥n; irrita las v√≠as respiratorias.',
    explainer_o3: 'O3: Ozono troposf√©rico ‚Äî afecta la respiraci√≥n.',
    explainer_so2: 'SO2: Di√≥xido de azufre ‚Äî efectos respiratorios.',
    explainer_co: 'CO: Mon√≥xido de carbono ‚Äî reduce la entrega de ox√≠geno en el cuerpo.',
    updated: 'Actualizado:',
    location_denied: 'Acceso a la ubicaci√≥n denegado. Proporcione coordenadas.',
    fetch_failed: 'Error al obtener datos de calidad del aire.'
  , measured_label: 'Medido:'
  , measured_others_not: '(otros no disponibles)'
  },
  fr: {
    aria_for: 'Informations sur la qualit√© de l‚Äôair pour',
    air_quality: 'Qualit√© de l‚Äôair',
    updating: 'Mise √† jour...',
    loading_data: 'Chargement des donn√©es de qualit√© de l‚Äôair...',
    error_title: 'Donn√©es de qualit√© de l‚Äôair non disponibles',
    try_again: 'R√©essayer',
    eu_aqi: 'AQI Europe',
    us_aqi: 'AQI US',
    health_recommendations: 'Recommandations de sant√©',
    general_population: 'Population g√©n√©rale',
    sensitive_individuals: 'Personnes sensibles',
    assessing: 'La qualit√© de l‚Äôair est en cours d‚Äô√©valuation...',
    no_pollutant_data: 'Aucune donn√©e de concentration des polluants pour cet emplacement.',
    legend_text: 'Les valeurs sont les concentrations horaires les plus r√©centes. Les badges sont color√©s selon la gravit√© indicative par rapport aux seuils typiques (ex. PM2.5 35 ¬µg/m¬≥).',
    explainer_summary: 'Que signifient ces abr√©viations?',
    explainer_pm2_5: 'PM2.5: Particules ‚â§2.5 ¬µm (fines) ‚Äî p√©n√®trent profond√©ment dans les poumons.',
    explainer_pm10: 'PM10: Particules ‚â§10 ¬µm (grossi√®res) ‚Äî irritation respiratoire possible.',
    explainer_no2: 'NO2: Dioxyde d‚Äôazote ‚Äî du trafic/combustion; irrite les voies respiratoires.',
    explainer_o3: 'O3: Ozone de surface ‚Äî affecte la respiration.',
    explainer_so2: 'SO2: Dioxyde de soufre ‚Äî effets respiratoires.',
    explainer_co: 'CO: Monoxyde de carbone ‚Äî r√©duit l‚Äôapport en oxyg√®ne dans le corps.',
    updated: 'Mis √† jour:',
    location_denied: 'Acc√®s √† la localisation refus√©. Veuillez fournir des coordonn√©es.',
    fetch_failed: '√âchec de la r√©cup√©ration des donn√©es de qualit√© de l‚Äôair.'
  , measured_label: 'Mesur√©:'
  , measured_others_not: "(autres non disponibles)"
  },
  it: {
    aria_for: 'Informazioni sulla qualit√† dell‚Äôaria per',
    air_quality: 'Qualit√† dell‚Äôaria',
    updating: 'Aggiornamento...',
    loading_data: 'Caricamento dati qualit√† dell‚Äôaria...',
    error_title: 'Dati qualit√† dell‚Äôaria non disponibili',
    try_again: 'Riprova',
    eu_aqi: 'AQI Europa',
    us_aqi: 'AQI USA',
    health_recommendations: 'Raccomandazioni per la salute',
    general_population: 'Popolazione generale',
    sensitive_individuals: 'Persone sensibili',
    assessing: "La qualit√† dell'aria √® in fase di valutazione...",
    no_pollutant_data: 'Nessun dato di concentrazione degli inquinanti per questa posizione.',
    legend_text: 'I valori sono le concentrazioni orarie pi√π recenti. I badge sono colorati in base alla gravit√† indicativa rispetto alle soglie tipiche (es. PM2.5 35 ¬µg/m¬≥).',
    explainer_summary: 'Cosa significano queste abbreviazioni?',
    explainer_pm2_5: 'PM2.5: Particelle ‚â§2.5 ¬µm (fini) ‚Äî penetrano in profondit√† nei polmoni.',
    explainer_pm10: 'PM10: Particelle ‚â§10 ¬µm (grossolane) ‚Äî rischio di irritazione respiratoria.',
    explainer_no2: 'NO2: Diossido di azoto ‚Äî da traffico/combustione; pu√≤ irritare le vie respiratorie.',
    explainer_o3: 'O3: Ozono troposferico ‚Äî influisce sulla respirazione.',
    explainer_so2: 'SO2: Diossido di zolfo ‚Äî effetti respiratori.',
    explainer_co: 'CO: Monossido di carbonio ‚Äî riduce il trasporto di ossigeno nel corpo.',
    updated: 'Aggiornato:',
    location_denied: "Accesso alla posizione negato. Fornisci le coordinate.",
    fetch_failed: 'Recupero dati qualit√† dell‚Äôaria non riuscito.'
  , measured_label: 'Misurato:'
  , measured_others_not: '(altri non disponibili)'
  },
  pt: {
    aria_for: 'Informa√ß√µes da qualidade do ar para',
    air_quality: 'Qualidade do ar',
    updating: 'A atualizar...',
    loading_data: 'A carregar dados da qualidade do ar...',
    error_title: 'Dados de qualidade do ar n√£o dispon√≠veis',
    try_again: 'Tentar novamente',
    eu_aqi: 'AQI Europa',
    us_aqi: 'AQI EUA',
    health_recommendations: 'Recomenda√ß√µes de sa√∫de',
    general_population: 'Popula√ß√£o geral',
    sensitive_individuals: 'Pessoas sens√≠veis',
    assessing: 'A qualidade do ar est√° a ser avaliada...',
    no_pollutant_data: 'Sem dados de concentra√ß√£o de poluentes para esta localiza√ß√£o.',
    legend_text: 'Os valores s√£o as concentra√ß√µes hor√°rias mais recentes. Os badges s√£o coloridos por gravidade indicativa vs. limites t√≠picos (ex. PM2.5 35 ¬µg/m¬≥).',
    explainer_summary: 'O que significam estas abreviaturas?',
    explainer_pm2_5: 'PM2.5: Part√≠culas ‚â§2.5 ¬µm (finas) ‚Äî penetram profundamente nos pulm√µes.',
    explainer_pm10: 'PM10: Part√≠culas ‚â§10 ¬µm (grossas) ‚Äî risco de irrita√ß√£o respirat√≥ria.',
    explainer_no2: 'NO2: Di√≥xido de azoto ‚Äî do tr√°fego/combust√£o; pode irritar as vias respirat√≥rias.',
    explainer_o3: 'O3: Ozono (a n√≠vel do solo) ‚Äî afeta a respira√ß√£o.',
    explainer_so2: 'SO2: Di√≥xido de enxofre ‚Äî efeitos respirat√≥rios.',
    explainer_co: 'CO: Mon√≥xido de carbono ‚Äî reduz o fornecimento de oxig√©nio no corpo.',
    updated: 'Atualizado:',
    location_denied: 'Acesso √† localiza√ß√£o negado. Forne√ßa coordenadas.',
    fetch_failed: 'Falha ao obter dados de qualidade do ar.'
    , measured_label: 'Medido:'
    , measured_others_not: '(outros n√£o dispon√≠veis)'
  }
};

const t = (key) => (TRANSLATIONS[language] && TRANSLATIONS[language][key]) || TRANSLATIONS.en[key] || key;

const sizeClasses = {
  xs: 'text-xs p-3',
  sm: 'text-sm p-4',
  md: 'text-base p-6',
  lg: 'text-lg p-8',
  xl: 'text-xl p-10',
};
---

<div
  class={`air-quality-widget bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-700 rounded-xl shadow-lg ${sizeClasses[size]} ${className}`}
  role="region"
  aria-label={`${t('aria_for')} ${location || 'your location'}`}
  data-air-quality-widget
  data-latitude={latitude}
  data-longitude={longitude}
  data-language={language}
  data-domain={domain}
  data-location={location}
  data-aqi-system={aqiSystem}
  {...rest}
>
  <div class="space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <h2
        class="flex items-center gap-3 text-xl font-bold text-gray-900 dark:text-gray-100"
      >
        <span class="text-2xl" aria-hidden="true">ü´Å</span>
        <span>{t('air_quality')}</span>
        {
          location && (
            <span class="text-lg font-medium text-gray-600 dark:text-gray-400">
              ‚Ä¢ {location}
            </span>
          )
        }
      </h2>
      <div
        class="text-sm text-gray-500 dark:text-gray-400 update-time"
        aria-live="polite"
      >
        {t('updating')}
      </div>
    </header>

    <!-- Loading State -->
    <div
      class="flex items-center justify-center gap-4 py-12 air-quality__loading"
      aria-live="polite"
    >
              <div
                class="w-8 h-8 border-4 border-gray-300 border-t-blue-600 rounded-full animate-spin dark:border-gray-600 dark:border-t-blue-400"
                aria-hidden="true"
              >
              </div>
              <span class="text-lg font-semibold text-gray-700 dark:text-gray-300"
        >{t('loading_data')}</span
      >
    </div>

    <!-- Error State -->
    <div
      class="text-center space-y-4 py-12 air-quality__error hidden"
      role="alert"
    >
      <div class="text-4xl" aria-hidden="true">‚ö†Ô∏è</div>
      <h3 class="text-lg font-bold text-red-800 dark:text-red-300">
        {t('error_title')}
      </h3>
      <p class="text-red-700 dark:text-red-400 error-message"></p>
        <button
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors retry-button"
        type="button"
      >
        {t('try_again')}
      </button>
    </div>

    <!-- Content -->
    <div class="space-y-6 air-quality__content hidden">
      <!-- AQI Display -->
      <div
        class={`grid gap-6 ${aqiSystem === 'both' ? 'grid-cols-1 lg:grid-cols-2' : 'grid-cols-1'}`}
      >
        {
          (aqiSystem === 'european' || aqiSystem === 'both') && (
            <div
              class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4"
              role="group"
              aria-labelledby="eu-aqi-label"
            >
              <h3
                id="eu-aqi-label"
                class="text-lg font-bold text-gray-900 dark:text-gray-100"
              >
                {t('eu_aqi')}
              </h3>
              <div
                class="text-4xl font-black text-center eu-aqi-value"
                aria-label="European Air Quality Index"
              >
                --
              </div>
              <div class="text-center text-gray-600 dark:text-gray-300 eu-aqi-desc">
                Loading...
              </div>
              <div class="h-3 bg-linear-to-r from-green-500 to-red-500 rounded-full relative">
                <div
                  class="absolute w-3 h-3 bg-white border-2 border-gray-800 rounded-full transform translate-y-0 eu-indicator"
                  style="left: 0%;"
                />
              </div>
            </div>
          )
        }

        {
          (aqiSystem === 'us' || aqiSystem === 'both') && (
            <div
              class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 space-y-4"
              role="group"
              aria-labelledby="us-aqi-label"
            >
              <h3
                id="us-aqi-label"
                class="text-lg font-bold text-gray-900 dark:text-gray-100"
              >
                {t('us_aqi')}
              </h3>
              <div
                class="text-4xl font-black text-center us-aqi-value"
                aria-label="US Air Quality Index"
              >
                --
              </div>
              <div class="text-center text-gray-600 dark:text-gray-300 us-aqi-desc">
                Loading...
              </div>
              <div class="h-3 bg-linear-to-r from-green-500 to-red-900 rounded-full relative">
                <div
                  class="absolute w-3 h-3 bg-white border-2 border-gray-800 rounded-full transform translate-y-0 us-indicator"
                  style="left: 0%;"
                />
              </div>
            </div>
          )
        }
      </div>

      <!-- Health Advice -->
      {
        showHealthAdvice && (
          <div class="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-4 space-y-4">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">
              Health Recommendations
            </h3>
            <div class="space-y-3">
              <div class="flex gap-3">
                <div class="text-lg mt-0.5" aria-hidden="true">
                  üë•
                </div>
                <div>
                  <div class="font-medium text-gray-900 dark:text-gray-100">
                    General Population
                  </div>
                  <div class="text-sm text-gray-700 dark:text-gray-300 general-text">
                    Air quality is being assessed...
                  </div>
                </div>
              </div>
              <div class="flex gap-3">
                <div class="text-lg mt-0.5" aria-hidden="true">
                  ü§ß
                </div>
                <div>
                  <div class="font-medium text-gray-900 dark:text-gray-100">
                    Sensitive Individuals
                  </div>
                      <div class="text-sm text-gray-700 dark:text-gray-300 sensitive-text">
                        Air quality is being assessed...
                      </div>
                      <!-- Pollutant badges will be rendered here -->
                      <div class="mt-2 pollutant-badges flex flex-wrap gap-2" aria-hidden="false"></div>
                      <!-- Short legend describing pollutant values -->
                      <div class="mt-2 pollutant-legend text-xs text-gray-600 dark:text-gray-400"></div>
                      <!-- Coverage label -->
                      <div class="mt-1 pollutant-coverage text-xs text-gray-600 dark:text-gray-400"></div>
                </div>
              </div>
            </div>
          </div>
        )
      }
    </div>
  </div>
</div>

<script>
  class AirQuality {
    constructor(element) {
      this.element = element;
      this.lang = element.dataset.language || 'en';
      this.domain = element.dataset.domain || 'auto';
      this.latitude = parseFloat(element.dataset.latitude) || null;
      this.longitude = parseFloat(element.dataset.longitude) || null;
      this.location = element.dataset.location || null;
      this.aqiSystem = element.dataset.aqiSystem || 'both';

      this.loadingEl = element.querySelector('.air-quality__loading');
      this.errorEl = element.querySelector('.air-quality__error');
      this.contentEl = element.querySelector('.air-quality__content');
      this.retryButton = element.querySelector('.retry-button');

      this.init();
    }

    // Detect which pollutant hourly endpoints are supported for this location
    async detectSupportedPollutants() {
      const pollutants = ['pm2_5', 'pm10', 'no2', 'o3', 'so2', 'co'];
      const cacheKey = `aq_supported_${this.latitude}_${this.longitude}_${this.domain || 'auto'}`;
      try {
        const raw = localStorage.getItem(cacheKey);
        if (raw) {
          const obj = JSON.parse(raw);
          // TTL 1 hour
          if (Date.now() - obj.t < 1000 * 60 * 60) return obj.payload;
        }
      } catch {
        // ignore cache parsing errors
      }

      // For each pollutant try hourly first; if hourly fails try current as fallback.
      const checks = await Promise.all(
        pollutants.map(async (p) => {
          // build base url with domain if provided
          const domainParam = this.domain && this.domain !== 'auto' ? `&domain=${this.domain}` : '';
          try {
            const hourlyUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${this.latitude}&longitude=${this.longitude}&hourly=${p}${domainParam}&timezone=auto`;
            const res = await fetch(hourlyUrl);
            if (res.ok) {
              const json = await res.json();
              if (json && json.hourly && Array.isArray(json.hourly[p])) return { p, method: 'hourly' };
            }
          } catch { /* ignore hourly attempt */ }

          // hourly failed ‚Äî try current as fallback
          try {
            const domainParam2 = this.domain && this.domain !== 'auto' ? `&domain=${this.domain}` : '';
            const currentUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${this.latitude}&longitude=${this.longitude}&current=${p}${domainParam2}&timezone=auto`;
            const cres = await fetch(currentUrl);
            if (cres.ok) {
              const cjson = await cres.json();
              if (cjson && cjson.current && cjson.current[p] != null) return { p, method: 'current' };
            }
          } catch { /* ignore current attempt */ }

          return { p, method: null };
        })
      );

      const supportedMap = {};
      checks.forEach((c) => {
        if (c.method) supportedMap[c.p] = c.method;
      });
      try {
        localStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), payload: supportedMap }));
  } catch { /* ignore localStorage set errors */ }
      return supportedMap;
    }

    async init() {
      this.retryButton?.addEventListener('click', () => this.fetchData());
      await this.getCoordinates();
      await this.fetchData();
    }

    // simple runtime translation helper for client-side strings
    tLang(key) {
      const TRANSLATIONS = {
        en: {
          updated: 'Updated:',
          location_denied: 'Location access denied. Please provide coordinates.',
          fetch_failed: 'Failed to fetch air quality data.',
          measured_label: 'Measured:',
          measured_others_not: '(others not available)',
          advice_excellent_general: 'Air quality is excellent. Perfect for outdoor activities.',
          advice_excellent_sensitive: 'Air quality is safe for everyone.',
          advice_acceptable_general: 'Air quality is acceptable for most people.',
          advice_acceptable_sensitive: 'Consider reducing prolonged outdoor exertion.',
          advice_moderate_general: 'Air quality is moderate ‚Äî some individuals may experience symptoms.',
          advice_moderate_sensitive: 'People with respiratory conditions should reduce prolonged or heavy outdoor exertion.',
          advice_poor_general: 'Air quality is poor. Reduce outdoor activities.',
          advice_poor_sensitive: 'Sensitive groups: avoid prolonged outdoor exertion; consider staying indoors.',
          advice_very_poor_general: 'Air quality is very poor. Avoid outdoor activities.',
          advice_very_poor_sensitive: 'Sensitive groups: remain indoors and follow medical advice.',
          advice_hazardous_general: 'Air quality is hazardous. Stay indoors and limit exposure.',
          advice_hazardous_sensitive: 'Everyone should avoid outdoor activities; follow local health guidance.',
          elevated_note: 'Elevated pollutant levels detected:',
          explainer_summary: 'What do these abbreviations mean?',
          explainer_pm2_5: 'PM2.5: Particulate Matter ‚â§2.5 ¬µm (fine particles) ‚Äî penetrates deep into lungs.',
          explainer_pm10: 'PM10: Particulate Matter ‚â§10 ¬µm (coarse particles) ‚Äî respiratory irritation risk.',
          explainer_no2: 'NO2: Nitrogen Dioxide ‚Äî from traffic and combustion; can irritate airways.',
          explainer_o3: 'O3: Ozone (ground-level) ‚Äî formed by reactions in sunlight; affects breathing.',
          explainer_so2: 'SO2: Sulfur Dioxide ‚Äî from burning sulfur-containing fuels; respiratory effects.',
          explainer_co: 'CO: Carbon Monoxide ‚Äî reduces oxygen delivery in the body at high levels.'
        },
        de: {
          updated: 'Aktualisiert:',
          location_denied: 'Standortzugriff verweigert. Bitte Koordinaten angeben.',
          fetch_failed: 'Abruf der Luftdaten fehlgeschlagen.',
          measured_label: 'Gemessen:',
          measured_others_not: '(andere nicht verf√ºgbar)',
          advice_excellent_general: 'Die Luftqualit√§t ist ausgezeichnet. Ideal f√ºr Aktivit√§ten im Freien.',
          advice_excellent_sensitive: 'Die Luftqualit√§t ist f√ºr alle sicher.',
          advice_acceptable_general: 'Die Luftqualit√§t ist f√ºr die meisten Menschen akzeptabel.',
          advice_acceptable_sensitive: 'Reduzieren Sie l√§ngere k√∂rperliche Aktivit√§ten im Freien.',
          advice_moderate_general: 'Die Luftqualit√§t ist m√§√üig ‚Äî einige Personen k√∂nnen Symptome haben.',
          advice_moderate_sensitive: 'Personen mit Atemwegserkrankungen sollten l√§ngere oder anstrengende Aktivit√§ten im Freien reduzieren.',
          advice_poor_general: 'Die Luftqualit√§t ist schlecht. Reduzieren Sie Aktivit√§ten im Freien.',
          advice_poor_sensitive: 'Empfindliche Gruppen: Vermeiden Sie l√§ngere Aktivit√§ten im Freien; bleiben Sie wenn m√∂glich drinnen.',
          advice_very_poor_general: 'Die Luftqualit√§t ist sehr schlecht. Vermeiden Sie Aktivit√§ten im Freien.',
          advice_very_poor_sensitive: 'Empfindliche Gruppen: Bleiben Sie drinnen und befolgen Sie medizinische Anweisungen.',
          advice_hazardous_general: 'Die Luftqualit√§t ist gef√§hrlich. Bleiben Sie drinnen und begrenzen Sie die Exposition.',
          advice_hazardous_sensitive: 'Alle sollten Aktivit√§ten im Freien vermeiden; befolgen Sie lokale Gesundheitsanweisungen.',
          elevated_note: 'Erh√∂hte Schadstoffwerte festgestellt:',
          explainer_summary: 'Was bedeuten die Abk√ºrzungen?',
          explainer_pm2_5: 'PM2.5: Partikel ‚â§2.5 ¬µm (fein) ‚Äî dringen tief in die Lunge ein.',
          explainer_pm10: 'PM10: Partikel ‚â§10 ¬µm (grob) ‚Äî kann Atemwege reizen.',
          explainer_no2: 'NO2: Stickstoffdioxid ‚Äî aus Verkehr/Verbrennung; reizt die Atemwege.',
          explainer_o3: 'O3: Bodennahes Ozon ‚Äî entsteht in Sonnenlicht; belastet die Atmung.',
          explainer_so2: 'SO2: Schwefeldioxid ‚Äî aus schwefelhaltigen Brennstoffen; Atemwege betroffen.',
          explainer_co: 'CO: Kohlenmonoxid ‚Äî verringert Sauerstofftransport im K√∂rper.'
        },
        es: {
          updated: 'Actualizado:',
          location_denied: 'Acceso a la ubicaci√≥n denegado. Proporcione coordenadas.',
          fetch_failed: 'Error al obtener datos de calidad del aire.',
          measured_label: 'Medido:',
          measured_others_not: '(otros no disponibles)',
          advice_excellent_general: 'La calidad del aire es excelente. Perfecta para actividades al aire libre.',
          advice_excellent_sensitive: 'La calidad del aire es segura para todos.',
          advice_acceptable_general: 'La calidad del aire es aceptable para la mayor√≠a de las personas.',
          advice_acceptable_sensitive: 'Considere reducir el esfuerzo prolongado al aire libre.',
          advice_moderate_general: 'La calidad del aire es moderada ‚Äî algunas personas pueden experimentar s√≠ntomas.',
          advice_moderate_sensitive: 'Personas con condiciones respiratorias deben reducir el esfuerzo prolongado o intenso al aire libre.',
          advice_poor_general: 'La calidad del aire es mala. Reduzca las actividades al aire libre.',
          advice_poor_sensitive: 'Grupos sensibles: evite el esfuerzo prolongado al aire libre; considere permanecer en interiores.',
          advice_very_poor_general: 'La calidad del aire es muy mala. Evite actividades al aire libre.',
          advice_very_poor_sensitive: 'Grupos sensibles: permanezca en interiores y siga el consejo m√©dico.',
          advice_hazardous_general: 'La calidad del aire es peligrosa. Permanezca en interiores y limite la exposici√≥n.',
          advice_hazardous_sensitive: 'Todos deben evitar actividades al aire libre; siga las recomendaciones locales de salud.',
          elevated_note: 'Niveles elevados de contaminantes detectados:',
          explainer_summary: '¬øQu√© significan estas abreviaturas?',
          explainer_pm2_5: 'PM2.5: Part√≠culas ‚â§2.5 ¬µm (finas) ‚Äî penetran profundamente en los pulmones.',
          explainer_pm10: 'PM10: Part√≠culas ‚â§10 ¬µm (gruesas) ‚Äî riesgo de irritaci√≥n respiratoria.',
          explainer_no2: 'NO2: Di√≥xido de nitr√≥geno ‚Äî de tr√°fico/combusti√≥n; irrita las v√≠as respiratorias.',
          explainer_o3: 'O3: Ozono troposf√©rico ‚Äî afecta la respiraci√≥n.',
          explainer_so2: 'SO2: Di√≥xido de azufre ‚Äî efectos respiratorios.',
          explainer_co: 'CO: Mon√≥xido de carbono ‚Äî reduce la entrega de ox√≠geno en el cuerpo.'
        },
        fr: {
          updated: 'Mis √† jour:',
          location_denied: 'Acc√®s √† la localisation refus√©. Veuillez fournir des coordonn√©es.',
          fetch_failed: '√âchec de la r√©cup√©ration des donn√©es de qualit√© de l‚Äôair.',
          measured_label: 'Mesur√©:',
          measured_others_not: "(autres non disponibles)",
          advice_excellent_general: 'La qualit√© de l‚Äôair est excellente. Parfait pour les activit√©s en plein air.',
          advice_excellent_sensitive: 'La qualit√© de l‚Äôair est sans danger pour tout le monde.',
          advice_acceptable_general: 'La qualit√© de l‚Äôair est acceptable pour la plupart des personnes.',
          advice_acceptable_sensitive: 'Envisagez de r√©duire les efforts prolong√©s √† l‚Äôext√©rieur.',
          advice_moderate_general: 'La qualit√© de l‚Äôair est mod√©r√©e ‚Äî certaines personnes peuvent ressentir des sympt√¥mes.',
          advice_moderate_sensitive: 'Les personnes atteintes de maladies respiratoires doivent r√©duire les efforts prolong√©s ou intenses √† l‚Äôext√©rieur.',
          advice_poor_general: 'La qualit√© de l‚Äôair est mauvaise. R√©duisez les activit√©s en plein air.',
          advice_poor_sensitive: 'Groupes sensibles : √©vitez l‚Äôeffort prolong√© en ext√©rieur ; envisagez de rester √† l‚Äôint√©rieur.',
          advice_very_poor_general: 'La qualit√© de l‚Äôair est tr√®s mauvaise. √âvitez les activit√©s en plein air.',
          advice_very_poor_sensitive: 'Groupes sensibles : restez √† l‚Äôint√©rieur et suivez les conseils m√©dicaux.',
          advice_hazardous_general: 'La qualit√© de l‚Äôair est dangereuse. Restez √† l‚Äôint√©rieur et limitez l‚Äôexposition.',
          advice_hazardous_sensitive: 'Tout le monde doit √©viter les activit√©s en plein air ; suivez les recommandations sanitaires locales.',
          elevated_note: 'Niveaux √©lev√©s de polluants d√©tect√©s :',
          explainer_summary: 'Que signifient ces abr√©viations?',
          explainer_pm2_5: 'PM2.5: Particules ‚â§2.5 ¬µm (fines) ‚Äî p√©n√®trent profond√©ment dans les poumons.',
          explainer_pm10: 'PM10: Particules ‚â§10 ¬µm (grossi√®res) ‚Äî irritation respiratoire possible.',
          explainer_no2: 'NO2: Dioxyde d‚Äôazote ‚Äî du trafic/combustion; irrite les voies respiratoires.',
          explainer_o3: 'O3: Ozone de surface ‚Äî affecte la respiration.',
          explainer_so2: 'SO2: Dioxyde de soufre ‚Äî effets respiratoires.',
          explainer_co: 'CO: Monoxyde de carbone ‚Äî r√©duit l‚Äôapport en oxyg√®ne dans le corps.'
        },
        it: {
          updated: 'Aggiornato:',
          location_denied: 'Accesso alla posizione negato. Fornisci le coordinate.',
          fetch_failed: 'Recupero dati qualit√† dell‚Äôaria non riuscito.',
          measured_label: 'Misurato:',
          measured_others_not: '(altri non disponibili)',
          advice_excellent_general: 'La qualit√† dell‚Äôaria √® eccellente. Perfetta per attivit√† all‚Äôaperto.',
          advice_excellent_sensitive: 'La qualit√† dell‚Äôaria √® sicura per tutti.',
          advice_acceptable_general: 'La qualit√† dell‚Äôaria √® accettabile per la maggior parte delle persone.',
          advice_acceptable_sensitive: 'Considerare di ridurre l‚Äôattivit√† fisica prolungata all‚Äôaperto.',
          advice_moderate_general: 'La qualit√† dell‚Äôaria √® moderata ‚Äî alcune persone potrebbero avvertire sintomi.',
          advice_moderate_sensitive: 'Le persone con patologie respiratorie dovrebbero ridurre l‚Äôattivit√† fisica prolungata o intensa all‚Äôaperto.',
          advice_poor_general: 'La qualit√† dell‚Äôaria √® scadente. Ridurre le attivit√† all‚Äôaperto.',
          advice_poor_sensitive: 'Gruppi sensibili: evitare attivit√† prolungate all‚Äôaperto; prendere in considerazione di restare al chiuso.',
          advice_very_poor_general: 'La qualit√† dell‚Äôaria √® molto scadente. Evitare attivit√† all‚Äôaperto.',
          advice_very_poor_sensitive: 'Gruppi sensibili: rimanere al chiuso e seguire i consigli medici.',
          advice_hazardous_general: 'La qualit√† dell‚Äôaria √® pericolosa. Rimanere al chiuso e limitare l‚Äôesposizione.',
          advice_hazardous_sensitive: 'Tutti dovrebbero evitare attivit√† all‚Äôaperto; seguire le indicazioni sanitarie locali.',
          elevated_note: 'Livelli elevati di inquinanti rilevati:',
          explainer_summary: 'Cosa significano queste abbreviazioni?',
          explainer_pm2_5: 'PM2.5: Particelle ‚â§2.5 ¬µm (fini) ‚Äî penetrano in profondit√† nei polmoni.',
          explainer_pm10: 'PM10: Particelle ‚â§10 ¬µm (grossolane) ‚Äî rischio di irritazione respiratoria.',
          explainer_no2: 'NO2: Diossido di azoto ‚Äî da traffico/combustione; pu√≤ irritare le vie respiratorie.',
          explainer_o3: 'O3: Ozono troposferico ‚Äî influisce sulla respirazione.',
          explainer_so2: 'SO2: Diossido di zolfo ‚Äî effetti respiratori.',
          explainer_co: 'CO: Monossido di carbonio ‚Äî riduce il trasporto di ossigeno nel corpo.'
        },
        pt: {
          updated: 'Atualizado:',
          location_denied: 'Acesso √† localiza√ß√£o negado. Forne√ßa coordenadas.',
          fetch_failed: 'Falha ao obter dados de qualidade do ar.',
          measured_label: 'Medido:',
          measured_others_not: '(outros n√£o dispon√≠veis)',
          advice_excellent_general: 'A qualidade do ar √© excelente. Perfeita para atividades ao ar livre.',
          advice_excellent_sensitive: 'A qualidade do ar √© segura para todos.',
          advice_acceptable_general: 'A qualidade do ar √© aceit√°vel para a maioria das pessoas.',
          advice_acceptable_sensitive: 'Considere reduzir o esfor√ßo prolongado ao ar livre.',
          advice_moderate_general: 'A qualidade do ar √© moderada ‚Äî algumas pessoas podem apresentar sintomas.',
          advice_moderate_sensitive: 'Pessoas com condi√ß√µes respirat√≥rias devem reduzir o esfor√ßo prolongado ou intenso ao ar livre.',
          advice_poor_general: 'A qualidade do ar √© m√°. Reduza as atividades ao ar livre.',
          advice_poor_sensitive: 'Grupos sens√≠veis: evite esfor√ßo prolongado ao ar livre; considere permanecer em ambientes fechados.',
          advice_very_poor_general: 'A qualidade do ar √© muito m√°. Evite atividades ao ar livre.',
          advice_very_poor_sensitive: 'Grupos sens√≠veis: permane√ßa em ambientes fechados e siga as orienta√ß√µes m√©dicas.',
          advice_hazardous_general: 'A qualidade do ar √© perigosa. Permane√ßa em ambientes fechados e limite a exposi√ß√£o.',
          advice_hazardous_sensitive: 'Todos devem evitar atividades ao ar livre; siga as orienta√ß√µes de sa√∫de locais.',
          elevated_note: 'N√≠veis elevados de poluentes detectados:',
          explainer_summary: 'O que significam estas abreviaturas?',
          explainer_pm2_5: 'PM2.5: Part√≠culas ‚â§2.5 ¬µm (finas) ‚Äî penetram profundamente nos pulm√µes.',
          explainer_pm10: 'PM10: Part√≠culas ‚â§10 ¬µm (grossas) ‚Äî risco de irrita√ß√£o respirat√≥ria.',
          explainer_no2: 'NO2: Di√≥xido de azoto ‚Äî do tr√°fego/combust√£o; pode irritar as vias respirat√≥rias.',
          explainer_o3: 'O3: Ozono (a n√≠vel do solo) ‚Äî afeta a respira√ß√£o.',
          explainer_so2: 'SO2: Di√≥xido de enxofre ‚Äî efeitos respirat√≥rios.',
          explainer_co: 'CO: Mon√≥xido de carbono ‚Äî reduz o fornecimento de oxig√©nio no corpo.'
        }
      };
      return (TRANSLATIONS[this.lang] && TRANSLATIONS[this.lang][key]) || TRANSLATIONS.en[key] || key;
    }

    async getCoordinates() {
      if (this.latitude && this.longitude) return;

      if ('geolocation' in navigator) {
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: 10000,
            });
          });
          this.latitude = position.coords.latitude;
          this.longitude = position.coords.longitude;
        } catch {
          this.showError(this.tLang('location_denied'));
        }
      }
    }

    async fetchData() {
      if (!this.latitude || !this.longitude) {
        this.showError('No location provided.');
        return;
      }

      this.showLoading();

      try {
  // Request current AQI values separately (only AQI here ‚Äî per-pollutant current values are fetched individually below)
  const currentUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${this.latitude}&longitude=${this.longitude}&current=european_aqi,us_aqi&timezone=auto`;
        const currentRes = await fetch(currentUrl);
        if (!currentRes.ok) throw new Error(`API error: ${currentRes.status}`);
        const currentData = await currentRes.json();
        if (currentData.error) throw new Error(currentData.reason || 'AirQuality current API error');

        // Detect supported pollutants with method map (hourly | current)
        let supportMap = {};
        try {
          supportMap = await this.detectSupportedPollutants();
        } catch {
          supportMap = {}; // fallback empty
        }
        // persist for handleData fallback logic
        this.supportMap = supportMap;

        const allPollutants = ['pm2_5', 'pm10', 'no2', 'o3', 'so2', 'co'];
        const hourlyList = [];
        // pollutants marked 'current' will be read from currentData later
        allPollutants.forEach((p) => {
          if (supportMap && supportMap[p] === 'hourly') hourlyList.push(p);
        });

        // Fetch hourly data only for hourlyList (single variable requests per pollutant)
        const hourlyPromises = hourlyList.map(async (p) => {
          const domainParam = this.domain && this.domain !== 'auto' ? `&domain=${this.domain}` : '';
          const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${this.latitude}&longitude=${this.longitude}&hourly=${p}${domainParam}&timezone=auto`;
          try {
            const res = await fetch(url);
            if (!res.ok) return { pollutant: p, data: null };
            const json = await res.json();
            return { pollutant: p, data: json };
          } catch {
            return { pollutant: p, data: null };
          }
        });

        const hourlyResults = await Promise.all(hourlyPromises);
        const mergedHourly = {};
        hourlyResults.forEach((r) => {
          if (r && r.data && r.data.hourly && r.data.hourly[r.pollutant]) {
            mergedHourly[r.pollutant] = r.data.hourly[r.pollutant];
          }
        });

        // For pollutants detected as 'current', fetch single-variable current endpoints (avoid multi-variable current requests)
        const currentPollutants = {};
        const currentList = allPollutants.filter((p) => supportMap && supportMap[p] === 'current');
        const currentPromises = currentList.map(async (p) => {
          const domainParam = this.domain && this.domain !== 'auto' ? `&domain=${this.domain}` : '';
          const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${this.latitude}&longitude=${this.longitude}&current=${p}${domainParam}&timezone=auto`;
          try {
            const res = await fetch(url);
            if (!res.ok) return;
            const json = await res.json();
            if (json && json.current && json.current[p] != null) currentPollutants[p] = json.current[p];
          } catch {
            // ignore per-pollutant current fetch errors
          }
        });
        await Promise.all(currentPromises);

        // Merge into a single shape expected by handleData (currentData remains primary source for 'current' methods)
        const merged = {
          ...currentData,
          current: {
            ...(currentData.current || {}),
            ...currentPollutants,
          },
          hourly: mergedHourly,
        };

        this.handleData(merged);
        this.showContent();
      } catch (err) {
        console.error('AirQuality fetch error', err);
        this.showError(this.tLang('fetch_failed'));
      }
    }

    handleData(data) {
      const current = data.current;
      if (!current) return;

      // Update European AQI
      if (current.european_aqi != null) {
        const value = Math.round(current.european_aqi);
        const level = this.getEuropeanAQILevel(value);

        const valueEl = this.element.querySelector('.eu-aqi-value');
        const descEl = this.element.querySelector('.eu-aqi-desc');
        const indicatorEl = this.element.querySelector('.eu-indicator');

        if (valueEl) {
          valueEl.textContent = value.toString();
          valueEl.className = `text-4xl font-black text-center eu-aqi-value aqi-${level.class}`;
        }

        if (descEl) {
          descEl.textContent = level.description;
          descEl.className = `text-center text-gray-600 dark:text-gray-300 eu-aqi-desc aqi-${level.class}`;
        }

        if (indicatorEl) {
          indicatorEl.style.left = `${Math.min(value, 100)}%`;
        }
      }

      // Update US AQI
      if (current.us_aqi != null) {
        const value = Math.round(current.us_aqi);
        const level = this.getUSAQILevel(value);

        const valueEl = this.element.querySelector('.us-aqi-value');
        const descEl = this.element.querySelector('.us-aqi-desc');
        const indicatorEl = this.element.querySelector('.us-indicator');

        if (valueEl) {
          valueEl.textContent = value.toString();
          valueEl.className = `text-4xl font-black text-center us-aqi-value aqi-${level.class}`;
        }

        if (descEl) {
          descEl.textContent = level.description;
          descEl.className = `text-center text-gray-600 dark:text-gray-300 us-aqi-desc aqi-${level.class}`;
        }

        if (indicatorEl) {
          indicatorEl.style.left = `${Math.min(value / 5, 100)}%`;
        }
      }

      // Update health advice
      // Provide both AQI and pollutant components to the advice generator
      const aqiValue =
        current.european_aqi != null
          ? Math.round(current.european_aqi)
          : current.us_aqi != null
          ? Math.round(current.us_aqi)
          : 0;

      // Extract pollutant values. Prefer current if available or supported as 'current', otherwise latest from hourly arrays.
      const components = {};
      const hourly = data.hourly || {};

      const getLatest = (arr) => {
        if (!Array.isArray(arr)) return undefined;
        for (let i = arr.length - 1; i >= 0; i--) {
          const v = arr[i];
          if (v !== null && v !== undefined) return v;
        }
        return undefined;
      };

      const pick = (key) => {
        // If current has a value, prefer it
        if (current && current[key] != null) return current[key];
        // If supportMap says current, prefer current (even if null), else try hourly latest
        if (this.supportMap && this.supportMap[key] === 'current' && current && current[key] != null) return current[key];
        return getLatest(hourly[key]);
      };

      components.pm2_5 = pick('pm2_5');
      components.pm10 = pick('pm10');
      components.no2 = pick('no2');
      components.o3 = pick('o3');
      components.so2 = pick('so2');
      components.co = pick('co');

      this.updateHealthAdvice({ aqi: aqiValue, components });
      this.updateLastUpdated();
      this.updateCoverage();
    }

    updateCoverage() {
      const el = this.element.querySelector('.pollutant-coverage');
      if (!el) return;
      const map = this.supportMap || {};
      const keys = Object.keys(map).filter((k) => map[k]);
      if (keys.length === 0) {
        el.textContent = '';
        return;
      }
      const label = this.tLang('measured_label') || 'Measured:';
      const othersNot = this.tLang('measured_others_not') || '(others not available)';
      // build tooltip text: "Measured: PM2_5, PM10 (others not available)"
      const measuredText = `${label} ${keys.map((k) => k.toUpperCase()).join(', ')} ${othersNot}`;

      // Render a simple inline info with visually-hidden tooltip text for accessibility
      el.innerHTML = `
        <span class="inline-flex items-center gap-2">
          <svg aria-hidden="true" class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"></path></svg>
          <span class="sr-only">${measuredText}</span>
          <span class="text-xs text-gray-600 dark:text-gray-400">${label} ${keys.map((k) => k.toUpperCase()).join(', ')}<span class="text-gray-400"> ${othersNot}</span></span>
        </span>
      `;
    }

    getEuropeanAQILevel(aqi) {
      if (aqi <= 20) return { class: 'good', description: 'Good' };
      if (aqi <= 40) return { class: 'fair', description: 'Fair' };
      if (aqi <= 60) return { class: 'moderate', description: 'Moderate' };
      if (aqi <= 80) return { class: 'poor', description: 'Poor' };
      return { class: 'very-poor', description: 'Very Poor' };
    }

    getUSAQILevel(aqi) {
      if (aqi <= 50) return { class: 'good', description: 'Good' };
      if (aqi <= 100) return { class: 'moderate', description: 'Moderate' };
      if (aqi <= 150)
        return {
          class: 'unhealthy-sensitive',
          description: 'Unhealthy for Sensitive Groups',
        };
      if (aqi <= 200) return { class: 'unhealthy', description: 'Unhealthy' };
      if (aqi <= 300)
        return { class: 'very-unhealthy', description: 'Very Unhealthy' };
      return { class: 'hazardous', description: 'Hazardous' };
    }

    updateHealthAdvice({ aqi = 0, components = {} } = {}) {
      const generalEl = this.element.querySelector('.general-text');
      const sensitiveEl = this.element.querySelector('.sensitive-text');

      // Base advice from AQI bands (simple, readable guidance)
      let general = 'Air quality is being assessed...';
      let sensitive = 'Air quality is being assessed...';

      if (aqi <= 50) {
        general = this.tLang('advice_excellent_general');
        sensitive = this.tLang('advice_excellent_sensitive');
      } else if (aqi <= 100) {
        general = this.tLang('advice_acceptable_general');
        sensitive = this.tLang('advice_acceptable_sensitive');
      } else if (aqi <= 150) {
        general = this.tLang('advice_moderate_general');
        sensitive = this.tLang('advice_moderate_sensitive');
      } else if (aqi <= 200) {
        general = this.tLang('advice_poor_general');
        sensitive = this.tLang('advice_poor_sensitive');
      } else if (aqi <= 300) {
        general = this.tLang('advice_very_poor_general');
        sensitive = this.tLang('advice_very_poor_sensitive');
      } else {
        general = this.tLang('advice_hazardous_general');
        sensitive = this.tLang('advice_hazardous_sensitive');
      }

      // Inspect pollutant components for specific elevated warnings
      const pollutantThresholds = {
        pm2_5: 35, // ¬µg/m3 - indicative threshold
        pm10: 50,
        no2: 200,
        o3: 120,
        so2: 125,
        co: 10000, // ¬µg/m3 - very high threshold as placeholder
      };

      const elevated = [];
      Object.keys(components).forEach((key) => {
        const val = Number(components[key]);
        if (!Number.isFinite(val)) return;
        const thr = pollutantThresholds[key];
        if (thr != null && val >= thr) {
          // Format value with reasonable precision
          elevated.push(`${key.toUpperCase()}: ${val}`);
        }
      });

      if (elevated.length > 0) {
        const note = ` ${this.tLang('elevated_note')} ${elevated.join(', ')}.`;
        general += note;
        sensitive += note;
      }

      if (generalEl) generalEl.textContent = general;
      if (sensitiveEl) sensitiveEl.textContent = sensitive;

      // Update pollutant badges/list
      this.updatePollutantList(components);
    }

    updatePollutantList(components = {}) {
      const container = this.element.querySelector('.pollutant-badges');
      const legend = this.element.querySelector('.pollutant-legend');
      if (!container) return;
      container.innerHTML = '';

      const units = {
        pm2_5: '¬µg/m¬≥',
        pm10: '¬µg/m¬≥',
        no2: '¬µg/m¬≥',
        o3: '¬µg/m¬≥',
        so2: '¬µg/m¬≥',
        co: '¬µg/m¬≥',
      };

      // Indicative thresholds used to derive badge color (same as advice thresholds)
      const thresholds = {
        pm2_5: 35,
        pm10: 50,
        no2: 200,
        o3: 120,
        so2: 125,
        co: 10000,
      };

      const severityFor = (k, v) => {
        const thr = thresholds[k];
        if (thr == null) return 'unknown';
        if (v < thr * 0.5) return 'low';
        if (v < thr) return 'moderate';
        if (v < thr * 1.5) return 'high';
        return 'very-high';
      };

      const colorFor = (sev) => {
        // Tailwind-like utility strings; these classes exist in the project
        switch (sev) {
          case 'low':
            return 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900 dark:text-green-200';
          case 'moderate':
            return 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900 dark:text-yellow-200';
          case 'high':
            return 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900 dark:text-orange-200';
          case 'very-high':
            return 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900 dark:text-red-200';
          default:
            return 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-800 dark:text-gray-100';
        }
      };

      let rendered = 0;
      Object.keys(components).forEach((k) => {
        const raw = components[k];
        const val = Number(raw);
        if (!Number.isFinite(val)) return;

        const sev = severityFor(k, val);
        const color = colorFor(sev);

        const badge = document.createElement('div');
        badge.className = `px-2 py-1 rounded-md text-sm font-medium border ${color}`;
        badge.setAttribute('role', 'status');
        const titleText = `${k.toUpperCase()}: ${val}${units[k] ? ' ' + units[k] : ''}`;
        badge.setAttribute('aria-label', titleText);
        // tooltip on hover for quick info
        badge.setAttribute('title', titleText);
        badge.textContent = titleText;
        container.appendChild(badge);
        rendered++;
      });

      if (legend) {
        if (rendered === 0) {
          legend.textContent = 'No pollutant concentration data available for this location.';
        } else {
          legend.innerHTML = 'Values are latest hourly concentrations. Badges are colored by indicative severity vs. typical thresholds (e.g. PM2.5 35 ¬µg/m¬≥).';
        }

        // Add a short, collapsible explanation of pollutant abbreviations
        const detailsId = 'pollutant-explainer';
        let details = this.element.querySelector(`#${detailsId}`);
          if (!details) {
          details = document.createElement('details');
          details.id = detailsId;
          details.className = 'mt-2 text-xs text-gray-700 dark:text-gray-300';
          details.innerHTML = `
            <summary class="font-medium">${this.tLang('explainer_summary')}</summary>
            <ul class="mt-2 list-disc ml-5 space-y-1">
              <li><strong>PM2.5</strong>: ${this.tLang('explainer_pm2_5')}</li>
              <li><strong>PM10</strong>: ${this.tLang('explainer_pm10')}</li>
              <li><strong>NO2</strong>: ${this.tLang('explainer_no2')}</li>
              <li><strong>O3</strong>: ${this.tLang('explainer_o3')}</li>
              <li><strong>SO2</strong>: ${this.tLang('explainer_so2')}</li>
              <li><strong>CO</strong>: ${this.tLang('explainer_co')}</li>
            </ul>
          `;
          legend.appendChild(details);
        }
      }
    }

    updateLastUpdated() {
      const updateEl = this.element.querySelector('.update-time');
      if (updateEl) {
        const now = new Date();
        updateEl.textContent = `${this.tLang('updated')} ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      }
    }

    showLoading() {
      this.loadingEl?.classList.remove('hidden');
      this.errorEl?.classList.add('hidden');
      this.contentEl?.classList.add('hidden');
    }

    showError(message) {
      this.loadingEl?.classList.add('hidden');
      this.errorEl?.classList.remove('hidden');
      this.contentEl?.classList.add('hidden');

      const messageEl = this.errorEl?.querySelector('.error-message');
      if (messageEl) messageEl.textContent = message;
    }

    showContent() {
      this.loadingEl?.classList.add('hidden');
      this.errorEl?.classList.add('hidden');
      this.contentEl?.classList.remove('hidden');
    }
  }

  // Initialize components
  document.addEventListener('DOMContentLoaded', () => {
    document
      .querySelectorAll('[data-air-quality-widget]')
      .forEach((element) => {
        new AirQuality(element);
      });
  });
</script>

<style>
  @layer components {
    .air-quality-widget {
      /* Tailwind theme() requires quoted keys; provide fallbacks for robustness */
      --aqi-good: theme('colors.green.700', #166534);
      --aqi-fair: theme('colors.lime.600', #65a30d);
      --aqi-moderate: theme('colors.yellow.600', #ca8a04);
      --aqi-poor: theme('colors.orange.600', #ea580c);
      --aqi-very-poor: theme('colors.red.700', #b91c1c);
      --aqi-unhealthy-sensitive: theme('colors.orange.700', #c2410c);
      --aqi-unhealthy: theme('colors.red.700', #b91c1c);
      --aqi-very-unhealthy: theme('colors.purple.700', #6d28d9);
      --aqi-hazardous: theme('colors.red.900', #7f1d1d);
    }

    .dark .air-quality-widget {
      --aqi-good: theme('colors.green.400', #4ade80);
      --aqi-fair: theme('colors.lime.400', #a3e635);
      --aqi-moderate: theme('colors.yellow.400', #facc15);
      --aqi-poor: theme('colors.orange.400', #fb923c);
      --aqi-very-poor: theme('colors.red.400', #f87171);
      --aqi-unhealthy-sensitive: theme('colors.orange.400', #fb923c);
      --aqi-unhealthy: theme('colors.red.400', #f87171);
      --aqi-very-unhealthy: theme('colors.purple.400', #c084fc);
      --aqi-hazardous: theme('colors.red.300', #fca5a5);
    }

    .aqi-good {
      color: var(--aqi-good) !important;
    }
    .aqi-fair {
      color: var(--aqi-fair) !important;
    }
    .aqi-moderate {
      color: var(--aqi-moderate) !important;
    }
    .aqi-poor {
      color: var(--aqi-poor) !important;
    }
    .aqi-very-poor {
      color: var(--aqi-very-poor) !important;
    }
    .aqi-unhealthy-sensitive {
      color: var(--aqi-unhealthy-sensitive) !important;
    }
    .aqi-unhealthy {
      color: var(--aqi-unhealthy) !important;
    }
    .aqi-very-unhealthy {
      color: var(--aqi-very-unhealthy) !important;
    }
    .aqi-hazardous {
      color: var(--aqi-hazardous) !important;
    }

    .eu-indicator,
    .us-indicator {
      transition: left 0.5s ease-in-out;
      top: 0;
    }

    @media (prefers-contrast: high) {
      .air-quality-widget {
        border-width: 3px !important;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .air-quality-widget .animate-spin {
        animation: none;
      }
      .eu-indicator,
      .us-indicator {
        transition: none !important;
      }
    }
  }
</style>
