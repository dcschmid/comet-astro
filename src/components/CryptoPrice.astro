---
/**
 * CryptoPrice - Kryptowährungs-Kurse
 *
 * Zeigt aktuelle Preise und 24h-Änderung für Kryptowährungen.
 *
 * API: https://www.coingecko.com/en/api
 */
import { cn } from '../utils/cn';

interface Props {
  coins?: string[];
  currency?: string;
  showChange?: boolean;
  showIcon?: boolean;
  variant?: 'default' | 'compact' | 'ticker';
  className?: string;
}

const {
  coins = ['bitcoin', 'ethereum'],
  currency = 'eur',
  showChange = true,
  showIcon = true,
  variant = 'default',
  className = '',
} = Astro.props;

interface CoinData {
  [key: string]: {
    [currency: string]: number;
    [change: string]: number;
  };
}

let data: CoinData | null = null;
let error: string | null = null;

try {
  const params = new URLSearchParams({
    ids: coins.join(','),
    vs_currencies: currency,
    include_24hr_change: 'true',
  });

  const res = await fetch(
    `https://api.coingecko.com/api/v3/simple/price?${params}`
  );
  if (res.ok) {
    data = await res.json();
  } else if (res.status === 429) {
    error = 'Rate Limit erreicht';
  } else {
    error = `Fehler (${res.status})`;
  }
} catch {
  error = 'Verbindungsfehler';
}

const coinInfo: Record<
  string,
  { name: string; symbol: string; icon: string; color: string }
> = {
  bitcoin: {
    name: 'Bitcoin',
    symbol: 'BTC',
    icon: '₿',
    color: 'from-orange-500 to-amber-500',
  },
  ethereum: {
    name: 'Ethereum',
    symbol: 'ETH',
    icon: 'Ξ',
    color: 'from-blue-500 to-indigo-500',
  },
  tether: {
    name: 'Tether',
    symbol: 'USDT',
    icon: '₮',
    color: 'from-emerald-500 to-teal-500',
  },
  binancecoin: {
    name: 'BNB',
    symbol: 'BNB',
    icon: '◆',
    color: 'from-yellow-500 to-amber-500',
  },
  solana: {
    name: 'Solana',
    symbol: 'SOL',
    icon: '◎',
    color: 'from-purple-500 to-violet-500',
  },
  ripple: {
    name: 'XRP',
    symbol: 'XRP',
    icon: '✕',
    color: 'from-slate-400 to-slate-500',
  },
  cardano: {
    name: 'Cardano',
    symbol: 'ADA',
    icon: '₳',
    color: 'from-blue-400 to-cyan-500',
  },
  dogecoin: {
    name: 'Dogecoin',
    symbol: 'DOGE',
    icon: 'Ð',
    color: 'from-amber-400 to-yellow-500',
  },
  polkadot: {
    name: 'Polkadot',
    symbol: 'DOT',
    icon: '●',
    color: 'from-pink-500 to-rose-500',
  },
  'avalanche-2': {
    name: 'Avalanche',
    symbol: 'AVAX',
    icon: '▲',
    color: 'from-red-500 to-rose-500',
  },
};

const currencySymbols: Record<string, string> = {
  eur: '€',
  usd: '$',
  gbp: '£',
  chf: 'Fr.',
  jpy: '¥',
};

function formatPrice(price: number): string {
  if (price >= 10000)
    return price.toLocaleString('de-DE', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    });
  if (price >= 100)
    return price.toLocaleString('de-DE', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  if (price >= 1)
    return price.toLocaleString('de-DE', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 4,
    });
  return price.toLocaleString('de-DE', {
    minimumFractionDigits: 4,
    maximumFractionDigits: 6,
  });
}

const currencySymbol = currencySymbols[currency] || currency.toUpperCase();
const isTicker = variant === 'ticker';
const isCompact = variant === 'compact';
---

{
  error ? (
    <div
      class={cn(
        'p-4 rounded-xl bg-red-950/50 border border-red-500/30 text-red-300 text-sm',
        className
      )}
    >
      {error}
    </div>
  ) : (
    data && (
      <>
        {isTicker ? (
          <div class={cn('flex items-center gap-6 py-2 text-sm', className)}>
            {coins.map((coin) => {
              const info = coinInfo[coin] || {
                name: coin,
                symbol: coin.toUpperCase(),
                icon: '●',
                color: 'from-slate-500 to-slate-600',
              };
              const price = data[coin]?.[currency];
              const change = data[coin]?.[`${currency}_24h_change`];

              if (!price) return null;

              return (
                <div class="flex items-center gap-2">
                  {showIcon && <span class="text-lg">{info.icon}</span>}
                  <span class="font-semibold text-slate-100">
                    {info.symbol}
                  </span>
                  <span class="text-slate-300">
                    {currencySymbol}
                    {formatPrice(price)}
                  </span>
                  {showChange && change !== undefined && (
                    <span
                      class={cn(
                        'text-xs font-medium',
                        change >= 0 ? 'text-emerald-400' : 'text-red-400'
                      )}
                    >
                      {change >= 0 ? '+' : ''}
                      {change.toFixed(2)}%
                    </span>
                  )}
                </div>
              );
            })}
          </div>
        ) : (
          <div
            class={cn(
              'rounded-2xl bg-gradient-to-br from-slate-800/90 to-slate-900/90 border border-slate-700/50 overflow-hidden',
              className
            )}
          >
            {!isCompact && (
              <header class="px-5 py-4 border-b border-slate-700/50 bg-amber-500/5">
                <div class="flex items-center gap-3">
                  <div class="p-2.5 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-500/25">
                    <svg
                      class="w-5 h-5 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                  <div>
                    <h3 class="font-bold text-slate-100 text-lg">
                      Krypto-Kurse
                    </h3>
                    <p class="text-xs text-slate-400">Live von CoinGecko</p>
                  </div>
                </div>
              </header>
            )}

            <div class={cn('p-4', isCompact && 'p-3')}>
              <div class={cn('space-y-3', isCompact && 'space-y-2')}>
                {coins.map((coin) => {
                  const info = coinInfo[coin] || {
                    name: coin,
                    symbol: coin.toUpperCase(),
                    icon: '●',
                    color: 'from-slate-500 to-slate-600',
                  };
                  const price = data[coin]?.[currency];
                  const change = data[coin]?.[`${currency}_24h_change`];

                  if (!price) return null;

                  const isPositive = change !== undefined && change >= 0;

                  return (
                    <article
                      class={cn(
                        'flex items-center gap-4 p-3 rounded-xl border transition-all bg-slate-800/30 border-slate-700/30 hover:border-slate-600/50',
                        isCompact && 'p-2'
                      )}
                    >
                      {showIcon && (
                        <div
                          class={cn(
                            'shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-xl font-bold text-white bg-gradient-to-br shadow-lg',
                            info.color,
                            isCompact && 'w-8 h-8 text-base'
                          )}
                        >
                          {info.icon}
                        </div>
                      )}

                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="font-bold text-slate-100">
                            {info.symbol}
                          </span>
                          {!isCompact && (
                            <span class="text-sm text-slate-500">
                              {info.name}
                            </span>
                          )}
                        </div>
                      </div>

                      <div class="text-right shrink-0">
                        <div
                          class={cn(
                            'font-black text-slate-100',
                            isCompact ? 'text-base' : 'text-xl'
                          )}
                        >
                          {currencySymbol}
                          {formatPrice(price)}
                        </div>
                        {showChange && change !== undefined && (
                          <div
                            class={cn(
                              'flex items-center justify-end gap-1 text-xs font-semibold',
                              isPositive ? 'text-emerald-400' : 'text-red-400'
                            )}
                          >
                            <svg
                              class={cn('w-3 h-3', !isPositive && 'rotate-180')}
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 10l7-7m0 0l7 7m-7-7v18"
                              />
                            </svg>
                            {Math.abs(change).toFixed(2)}%
                          </div>
                        )}
                      </div>
                    </article>
                  );
                })}
              </div>
            </div>

            {!isCompact && (
              <footer class="px-5 py-3 border-t border-slate-700/50 bg-slate-800/30 flex items-center justify-between text-xs text-slate-500">
                <span>24h Änderung</span>
                <a
                  href="https://www.coingecko.com"
                  target="_blank"
                  rel="noopener"
                  class="text-blue-400 hover:text-blue-300"
                >
                  CoinGecko →
                </a>
              </footer>
            )}
          </div>
        )}
      </>
    )
  )
}
