---
import EmbedBase from './EmbedBase.astro';

/**
 * VimeoEmbed - WCAG AAA compliant Vimeo video embed
 * Provides accessible Vimeo integration with proper loading states and error handling
 */
interface Props {
  /** Vimeo video ID */
  videoId: string;
  /** Accessible title for screen readers */
  title?: string;
  /** Visual theme variant */
  variant?: 'default' | 'minimal' | 'card' | 'featured' | 'inline';
  /** Enable autoplay */
  autoplay?: boolean;
  /** Loop video playback */
  loop?: boolean;
  /** Start video muted */
  muted?: boolean;
  /** Player color theme (hex color) */
  color?: string;
  /** Show portrait */
  portrait?: boolean;
  /** Show byline */
  byline?: boolean;
  /** Do Not Track mode */
  dnt?: boolean;
  /** Video quality preference */
  quality?: 'auto' | '240p' | '360p' | '540p' | '720p' | '1080p';
  /** Show loading state */
  showLoading?: boolean;
  /** Aspect ratio - Vimeo typically uses 16:9 */
  aspectRatio?: '16:9' | '4:3' | '1:1' | '21:9' | '9:16' | 'auto';
  /** CSS class for styling */
  class?: string;
  /** ARIA label for accessibility */
  ariaLabel?: string;
  /** Additional iframe attributes */
  [key: string]: any;
}

const {
  videoId,
  title = 'Vimeo video player',
  variant = 'default',
  autoplay = false,
  loop = false,
  muted = false,
  color = '00adef',
  portrait = false,
  byline = false,
  dnt = true,
  quality = 'auto',
  showLoading = true,
  aspectRatio = '16:9',
  class: className = '',
  ariaLabel,
  ...props
} = Astro.props;

// Validate videoId
if (!videoId || typeof videoId !== 'string') {
  throw new Error('VimeoEmbed: videoId is required and must be a string');
}

// Build Vimeo embed URL
const buildVimeoEmbedUrl = (): string => {
  const url = new URL(
    `https://player.vimeo.com/video/${encodeURIComponent(videoId)}`
  );

  // Playback parameters
  if (autoplay) url.searchParams.set('autoplay', '1');
  if (loop) url.searchParams.set('loop', '1');
  if (muted) url.searchParams.set('muted', '1');

  // Appearance parameters
  if (color) url.searchParams.set('color', color.replace('#', ''));
  url.searchParams.set('portrait', portrait ? '1' : '0');
  url.searchParams.set('byline', byline ? '1' : '0');
  url.searchParams.set('title', '0'); // Hide title for cleaner look

  // Privacy and performance
  if (dnt) url.searchParams.set('dnt', '1');
  if (quality !== 'auto') url.searchParams.set('quality', quality);

  return url.toString();
};

const embedUrl = buildVimeoEmbedUrl();

// Generate appropriate title and ARIA label
const finalTitle = title || `Vimeo video ${videoId}`;
const finalAriaLabel =
  ariaLabel || `Vimeo video player${title ? `: ${title}` : ''}`;
---

<EmbedBase
  src={embedUrl}
  title={finalTitle}
  aspectRatio={aspectRatio}
  variant={variant}
  showLoading={showLoading}
  class={className}
  ariaLabel={finalAriaLabel}
  allowFullscreen={true}
  allow="autoplay; fullscreen; picture-in-picture"
  {...props}
/>
