---
import { cn } from '../utils/cn';

/**
 * WCAG AAA compliant Tabs component
 * Provides accessible tabbed interface with keyboard navigation and screen reader support
 */
interface Tab {
  id: string;
  label: string;
  content?: string;
  disabled?: boolean;
  icon?: string;
  badge?: string | number;
}

type TabSize = 'sm' | 'md' | 'lg';
type TabVariant = 'default' | 'minimal' | 'pills' | 'cards';
type TabOrientation = 'horizontal' | 'vertical';

interface Props {
  tabs: Tab[];
  activeId?: string;
  className?: string;
  size?: TabSize;
  variant?: TabVariant;
  orientation?: TabOrientation;
  centered?: boolean;
  fullWidth?: boolean;
  destroyInactive?: boolean;
  ariaLabel?: string;
}

const {
  tabs = [],
  activeId = tabs.find((tab) => !tab.disabled)?.id || tabs[0]?.id,
  className = '',
  size = 'md',
  variant = 'default',
  orientation = 'horizontal',
  centered = false,
  fullWidth = false,
  destroyInactive = false,
  ariaLabel = 'Tabs',
} = Astro.props as Props;

// Size variants with WCAG AAA spacing
const sizeClasses = {
  sm: {
    tab: 'px-3 py-1.5 text-sm min-h-[32px]',
    panel: 'p-3 text-sm',
    gap: 'gap-1',
  },
  md: {
    tab: 'px-4 py-2 text-base min-h-[40px]',
    panel: 'p-4 text-base',
    gap: 'gap-2',
  },
  lg: {
    tab: 'px-6 py-3 text-lg min-h-[48px]',
    panel: 'p-6 text-lg',
    gap: 'gap-3',
  },
};

// Variant styles with WCAG AAA contrast ratios (9:1)
const variantClasses = {
  default: {
    container: 'space-y-4',
    tablist: 'border-b border-slate-200 dark:border-slate-700',
    tab: {
      base: 'border-b-2 border-transparent font-medium transition-all duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950 motion-safe:transition-all motion-reduce:transition-none contrast-more:border contrast-more:border-slate-950 contrast-more:dark:border-white',
      active:
        'border-blue-600 text-blue-700 dark:border-blue-400 dark:text-blue-300 bg-blue-50/50 dark:bg-blue-950/30 contrast-more:bg-blue-100 contrast-more:dark:bg-blue-900',
      inactive:
        'border-transparent text-slate-600 hover:text-slate-900 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:border-slate-600 contrast-more:text-slate-950 contrast-more:dark:text-white',
      disabled:
        'border-transparent text-slate-400 dark:text-slate-600 cursor-not-allowed contrast-more:text-slate-500 contrast-more:dark:text-slate-500',
    },
    panel:
      'bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg shadow-sm contrast-more:border-slate-950 contrast-more:dark:border-white',
  },
  minimal: {
    container: 'space-y-4',
    tablist: '',
    tab: {
      base: 'font-medium transition-all duration-150 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950 motion-safe:transition-all motion-reduce:transition-none contrast-more:border contrast-more:border-slate-950 contrast-more:dark:border-white',
      active:
        'text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-950/30 rounded-md contrast-more:bg-blue-100 contrast-more:dark:bg-blue-900',
      inactive:
        'text-slate-600 hover:text-slate-900 hover:bg-slate-50 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:bg-slate-900/50 rounded-md contrast-more:text-slate-950 contrast-more:dark:text-white',
      disabled:
        'text-slate-400 dark:text-slate-600 cursor-not-allowed contrast-more:text-slate-500 contrast-more:dark:text-slate-500',
    },
    panel: 'bg-transparent border-none p-0',
  },
  pills: {
    container: 'space-y-4',
    tablist: 'bg-slate-100 dark:bg-slate-800/50 rounded-lg p-1',
    tab: {
      base: 'font-medium transition-all duration-150 rounded-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-100 dark:focus-visible:ring-offset-slate-800 motion-safe:transition-all motion-reduce:transition-none contrast-more:border contrast-more:border-slate-950 contrast-more:dark:border-white',
      active:
        'bg-white text-slate-900 shadow-sm dark:bg-slate-950 dark:text-slate-100 contrast-more:bg-slate-50 contrast-more:dark:bg-slate-900',
      inactive:
        'text-slate-600 hover:text-slate-900 hover:bg-white/50 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:bg-slate-950/50 contrast-more:text-slate-950 contrast-more:dark:text-white',
      disabled:
        'text-slate-400 dark:text-slate-600 cursor-not-allowed contrast-more:text-slate-500 contrast-more:dark:text-slate-500',
    },
    panel:
      'bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg shadow-sm contrast-more:border-slate-950 contrast-more:dark:border-white',
  },
  cards: {
    container: 'space-y-4',
    tablist: '',
    tab: {
      base: 'border font-medium transition-all duration-150 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950 motion-safe:transition-all motion-reduce:transition-none contrast-more:border-2 contrast-more:border-slate-950 contrast-more:dark:border-white',
      active:
        'border-blue-600 bg-blue-600 text-white shadow-md dark:border-blue-500 dark:bg-blue-500 dark:text-slate-900 contrast-more:bg-blue-500 contrast-more:dark:bg-blue-400',
      inactive:
        'border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800 dark:hover:border-slate-600 shadow-sm contrast-more:text-slate-950 contrast-more:dark:text-white contrast-more:border-slate-950 contrast-more:dark:border-white',
      disabled:
        'border-slate-200 bg-slate-100 text-slate-400 cursor-not-allowed dark:border-slate-700 dark:bg-slate-800 dark:text-slate-600 contrast-more:text-slate-500 contrast-more:dark:text-slate-500',
    },
    panel:
      'bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg shadow-sm contrast-more:border-slate-950 contrast-more:dark:border-white',
  },
};

const currentSize = sizeClasses[size];
const currentVariant = variantClasses[variant];
const isVertical = orientation === 'vertical';

// Generate unique IDs for this tabs instance
const tabsId = `tabs-${Math.random().toString(36).substr(2, 9)}`;
const getTabId = (id: string) => `${tabsId}-tab-${id}`;
const getPanelId = (id: string) => `${tabsId}-panel-${id}`;

// Filter out disabled tabs for default active selection
const enabledTabs = tabs.filter((tab) => !tab.disabled);
const validActiveId =
  activeId && tabs.find((tab) => tab.id === activeId && !tab.disabled)
    ? activeId
    : enabledTabs[0]?.id;
---

<div
  class={cn(
    'text-slate-900 dark:text-slate-100',
    isVertical ? 'flex gap-6' : currentVariant.container,
    className
  )}
  data-tabs-orientation={orientation}
  data-tabs-variant={variant}
  data-tabs-size={size}
>
  <!-- Tab List -->
  <div
    role="tablist"
    aria-label={ariaLabel}
    aria-orientation={orientation}
    class={cn(
      'flex',
      isVertical ? 'flex-col' : 'flex-row',
      currentSize.gap,
      currentVariant.tablist,
      centered && !isVertical && 'justify-center',
      fullWidth && !isVertical && 'w-full',
      isVertical && 'min-w-[200px] flex-shrink-0'
    )}
  >
    {
      tabs.map((tab) => {
        const isActive = tab.id === validActiveId;
        const isDisabled = tab.disabled;

        return (
          <button
            type="button"
            role="tab"
            id={getTabId(tab.id)}
            aria-selected={isActive}
            aria-controls={getPanelId(tab.id)}
            aria-disabled={isDisabled}
            data-tab-id={tab.id}
            tabindex={isActive ? 0 : -1}
            disabled={isDisabled}
            class={cn(
              currentVariant.tab.base,
              currentSize.tab,
              fullWidth && !isVertical && 'flex-1',
              isActive && currentVariant.tab.active,
              !isActive && !isDisabled && currentVariant.tab.inactive,
              isDisabled && currentVariant.tab.disabled,
              tab.icon && 'flex items-center gap-2',
              'relative'
            )}
            title={isDisabled ? `${tab.label} (disabled)` : tab.label}
          >
            {/* Icon */}
            {tab.icon && (
              <span
                class="flex-shrink-0"
                aria-hidden="true"
                set:html={tab.icon}
              />
            )}

            {/* Label */}
            <span class="truncate">{tab.label}</span>

            {/* Badge */}
            {tab.badge && (
              <span
                class={cn(
                  'ml-2 inline-flex items-center justify-center rounded-full text-xs font-medium min-w-[1.25rem] h-5 px-1.5',
                  isActive
                    ? 'bg-white/20 text-current'
                    : 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300'
                )}
                aria-label={`${tab.badge} notifications`}
              >
                {tab.badge}
              </span>
            )}

            {/* Focus indicator for better visibility */}
            <span
              class="absolute inset-0 rounded-md ring-2 ring-transparent group-focus-visible:ring-blue-600"
              aria-hidden="true"
            />
          </button>
        );
      })
    }
  </div>

  <!-- Tab Panels Container -->
  <div
    class={cn(
      'flex-1',
      variant !== 'minimal' && currentVariant.panel,
      variant === 'minimal' ? currentSize.panel : '',
      isVertical && 'min-h-0'
    )}
  >
    {
      tabs.map((tab) => {
        const isActive = tab.id === validActiveId;
        const shouldRender = !destroyInactive || isActive;

        return shouldRender ? (
          <div
            role="tabpanel"
            id={getPanelId(tab.id)}
            aria-labelledby={getTabId(tab.id)}
            data-panel-id={tab.id}
            aria-hidden={!isActive}
            tabindex={isActive ? 0 : -1}
            class={cn(
              variant !== 'minimal' && currentSize.panel,
              !isActive && 'hidden',
              'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2',
              variant !== 'minimal'
                ? 'focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950'
                : 'focus-visible:ring-offset-transparent'
            )}
          >
            {tab.content ? (
              <div set:html={tab.content} />
            ) : (
              <div class="text-slate-500 dark:text-slate-400 italic">
                No content provided for this tab
              </div>
            )}
          </div>
        ) : null;
      })
    }

    {/* Empty state */}
    {
      tabs.length === 0 && (
        <div
          class={cn(
            'text-slate-500 dark:text-slate-400 italic text-center',
            currentSize.panel,
            'contrast-more:text-slate-700 contrast-more:dark:text-slate-300'
          )}
          role="status"
          aria-live="polite"
        >
          No tabs available
        </div>
      )
    }
  </div>
</div>

{/* Enhanced Tabs Script with WCAG compliance */}
<script is:inline define:vars={{ orientation }}>
  (function () {
    const container = document.querySelector(
      `[data-tabs-orientation="${orientation}"][data-tabs-variant][data-tabs-size]`
    );
    if (!container) return;

    const tablist = container.querySelector('[role="tablist"]');
    const tabs = Array.from(
      container.querySelectorAll('[role="tab"]:not([disabled])')
    );
    const panels = Array.from(container.querySelectorAll('[role="tabpanel"]'));

    if (!tablist || !tabs.length || !panels.length) return;

    // Set active tab and panel
    const setActiveTab = (targetId, focus = false) => {
      tabs.forEach((tab) => {
        const tabId = tab.getAttribute('data-tab-id');
        const isActive = tabId === targetId;

        // Update tab states
        tab.setAttribute('aria-selected', String(isActive));
        tab.tabIndex = isActive ? 0 : -1;

        if (focus && isActive) {
          tab.focus();
        }
      });

      panels.forEach((panel) => {
        const panelId = panel.getAttribute('data-panel-id');
        const isActive = panelId === targetId;

        // Update panel states
        panel.setAttribute('aria-hidden', String(!isActive));
        panel.tabIndex = isActive ? 0 : -1;
        panel.classList.toggle('hidden', !isActive);
      });

      // Announce change to screen readers (non-intrusive)
      const activeTab = tabs.find(
        (tab) => tab.getAttribute('data-tab-id') === targetId
      );
      if (activeTab) {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = `Switched to ${activeTab.textContent?.trim()} tab`;

        document.body.appendChild(announcement);
        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);
      }
    };

    // Navigate between tabs
    const navigateTab = (currentIndex, direction) => {
      const enabledTabs = tabs.filter((tab) => !tab.hasAttribute('disabled'));
      if (!enabledTabs.length) return;

      let nextIndex;

      if (direction === 'next') {
        nextIndex = (currentIndex + 1) % enabledTabs.length;
      } else if (direction === 'previous') {
        nextIndex =
          (currentIndex - 1 + enabledTabs.length) % enabledTabs.length;
      } else if (direction === 'first') {
        nextIndex = 0;
      } else if (direction === 'last') {
        nextIndex = enabledTabs.length - 1;
      } else {
        return;
      }

      const nextTab = enabledTabs[nextIndex];
      const nextTabId = nextTab?.getAttribute('data-tab-id');

      if (nextTabId) {
        setActiveTab(nextTabId, true);
      }
    };

    // Add event listeners
    tabs.forEach((tab) => {
      // Click handler
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = tab.getAttribute('data-tab-id');
        if (tabId && !tab.hasAttribute('disabled')) {
          setActiveTab(tabId);
        }
      });

      // Keyboard navigation
      tab.addEventListener('keydown', (e) => {
        const currentIndex = tabs
          .filter((t) => !t.hasAttribute('disabled'))
          .findIndex((t) => t === tab);

        switch (e.key) {
          case 'ArrowRight':
          case 'ArrowDown': {
            e.preventDefault();
            navigateTab(currentIndex, 'next');
            break;
          }
          case 'ArrowLeft':
          case 'ArrowUp': {
            e.preventDefault();
            navigateTab(currentIndex, 'previous');
            break;
          }
          case 'Home': {
            e.preventDefault();
            navigateTab(currentIndex, 'first');
            break;
          }
          case 'End': {
            e.preventDefault();
            navigateTab(currentIndex, 'last');
            break;
          }
          case 'Enter':
          case ' ': {
            e.preventDefault();
            const tabId = tab.getAttribute('data-tab-id');
            if (tabId && !tab.hasAttribute('disabled')) {
              setActiveTab(tabId);
            }
            break;
          }
        }
      });

      // Focus management
      tab.addEventListener('focus', () => {
        // Auto-activate tab on focus (optional behavior)
        const autoActivate =
          container.getAttribute('data-auto-activate') !== 'false';
        if (autoActivate) {
          const tabId = tab.getAttribute('data-tab-id');
          if (tabId && !tab.hasAttribute('disabled')) {
            setActiveTab(tabId);
          }
        }
      });
    });

    // Panel focus management
    panels.forEach((panel) => {
      panel.addEventListener('keydown', (e) => {
        // Ctrl+PageUp/PageDown for tab switching from panel
        if (e.ctrlKey && (e.key === 'PageUp' || e.key === 'PageDown')) {
          e.preventDefault();
          const activeTab = tabs.find(
            (tab) => tab.getAttribute('aria-selected') === 'true'
          );
          if (activeTab) {
            const currentIndex = tabs
              .filter((t) => !t.hasAttribute('disabled'))
              .findIndex((t) => t === activeTab);
            navigateTab(currentIndex, e.key === 'PageUp' ? 'previous' : 'next');
          }
        }
      });
    });

    // Handle dynamic tab changes via mutation observer
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === 'attributes' &&
          (mutation.attributeName === 'aria-selected' ||
            mutation.attributeName === 'disabled')
        ) {
          // Re-sync states if tabs are modified externally
          const activeTab = tabs.find(
            (tab) => tab.getAttribute('aria-selected') === 'true'
          );
          if (activeTab) {
            const tabId = activeTab.getAttribute('data-tab-id');
            if (tabId) setActiveTab(tabId);
          }
        }
      });
    });

    tabs.forEach((tab) => {
      observer.observe(tab, {
        attributes: true,
        attributeFilter: ['aria-selected', 'disabled'],
      });
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      observer.disconnect();
    });

    // Initialize with correct active state
    const initialActiveTab = tabs.find(
      (tab) => tab.getAttribute('aria-selected') === 'true'
    );
    if (initialActiveTab) {
      const tabId = initialActiveTab.getAttribute('data-tab-id');
      if (tabId) setActiveTab(tabId);
    }
  })();
</script>
