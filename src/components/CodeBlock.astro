---
interface Props {
  code?: string; // Raw code string
  language?: string; // Prism / Shiki language id
  title?: string; // Optional title bar string
  filename?: string; // Alternate to title (takes precedence if provided)
  showLineNumbers?: boolean; // Render line numbers gutter
  highlightLines?: number[]; // Lines to highlight (1-based)
  wrap?: boolean; // Soft wrap long lines
  copyable?: boolean; // Show copy button
  className?: string; // Extra utility classes
}

const {
  code,
  language = 'plaintext',
  title,
  filename,
  showLineNumbers = false,
  highlightLines = [],
  wrap = false,
  copyable = true,
  className = '',
} = Astro.props as Props;

const displayTitle = filename || title;
const lines = code?.split('\n') || [];
const highlightSet = new Set(highlightLines);
---

<div
  class={`group rounded-xl border border-slate-300 bg-slate-50 text-slate-800 shadow-sm dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100 ${className}`}
>
  {
    displayTitle && (
      <div class="flex items-center justify-between border-b border-slate-200 bg-slate-100/80 px-4 py-2 dark:border-slate-800 dark:bg-slate-900/60">
        <span class="text-xs font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300">
          {displayTitle}
        </span>
        {language && (
          <span class="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
            {language}
          </span>
        )}
      </div>
    )
  }
  <div class="relative">
    {
      copyable && (
        <button
          type="button"
          class="absolute right-3 top-3 inline-flex items-center gap-1 rounded-md border border-slate-400 bg-white/70 px-3 py-1 text-xs font-medium text-slate-700 backdrop-blur-sm transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50 dark:border-slate-600 dark:bg-slate-800/80 dark:text-slate-100 dark:hover:bg-slate-700 dark:focus-visible:ring-offset-slate-950"
          data-copy-button
          aria-describedby="copy-status"
        >
          Copy
        </button>
      )
    }
    <span id="copy-status" class="sr-only" aria-live="polite"></span>
    <pre
      class={`p-4 overflow-x-auto text-[13px] leading-relaxed ${wrap ? 'whitespace-pre-wrap wrap-break-word' : 'whitespace-pre'} font-medium`}><code class={`language-${language}`}>{
        showLineNumbers
          ? lines.map((line, i) => {
              const lineNum = i + 1;
              const isHighlighted = highlightSet.has(lineNum);
              const highlightCls = isHighlighted ? 'bg-blue-500/15 ring-1 ring-inset ring-blue-500/30 dark:bg-blue-400/10 -mx-4 px-4 rounded-md' : '';
              return `<span class="block ${highlightCls}"><span class="inline-block w-8 select-none pr-2 text-right text-slate-400 dark:text-slate-600">${lineNum}</span>${line || ' '}</span>`;
            }).join('\n')
          : code
      }</code></pre>
  </div>
</div>

<script is:inline>
  (function () {
    const container = document.currentScript?.previousElementSibling;
    if (!(container instanceof HTMLElement)) return;
    const button = container.querySelector('[data-copy-button]');
    const status = container.querySelector('#copy-status');
    const codeElement = container.querySelector('code');
    if (
      !(button instanceof HTMLElement) ||
      !(codeElement instanceof HTMLElement)
    )
      return;

    if (button) {
      button.addEventListener('click', async () => {
        const text = codeElement?.textContent || '';
        try {
          await navigator.clipboard.writeText(text);
          button.setAttribute('data-state', 'copied');
          button.textContent = 'Copied';
          if (status) status.textContent = 'Code copied to clipboard';
          window.setTimeout(() => {
            button.removeAttribute('data-state');
            button.textContent = 'Copy';
            if (status) status.textContent = '';
          }, 1800);
        } catch {
          button.textContent = 'Error';
          if (status) status.textContent = 'Copy failed';
          window.setTimeout(() => {
            button.textContent = 'Copy';
            if (status) status.textContent = '';
          }, 1800);
        }
      });
    }
  })();
</script>

<style>
  pre {
    tab-size: 2;
  }
  code {
    font-family:
      'JetBrains Mono', 'Fira Code', ui-monospace, SFMono-Regular, Menlo,
      Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-weight: 450;
  }
</style>
