---
/**
 * PypiPackage - Python Paket-Informationen
 *
 * Zeigt Version, Lizenz, Beschreibung und mehr für PyPI-Pakete.
 *
 * API: https://pypi.org/pypi/{package}/json
 */
import { cn } from '../utils/cn';

interface PackageInfo {
  info: {
    name: string;
    version: string;
    summary?: string;
    description?: string;
    author?: string;
    author_email?: string;
    license?: string;
    home_page?: string;
    project_url?: string;
    project_urls?: Record<string, string>;
    package_url?: string;
    requires_python?: string;
    keywords?: string;
    classifiers?: string[];
  };
  releases: Record<string, Array<{ upload_time: string; size: number }>>;
  urls: Array<{ upload_time: string; packagetype: string; size: number }>;
}

interface Props {
  package: string;
  variant?: 'default' | 'compact' | 'badge';
  showRequirements?: boolean;
  showLinks?: boolean;
  className?: string;
}

const {
  package: packageName,
  variant = 'default',
  showRequirements = true,
  showLinks = true,
  className = '',
} = Astro.props;

let pkg: PackageInfo | null = null;
let error: string | null = null;

try {
  const res = await fetch(`https://pypi.org/pypi/${packageName}/json`);
  if (res.ok) {
    pkg = await res.json();
  } else {
    error = 'Paket nicht gefunden';
  }
} catch {
  error = 'Verbindungsfehler';
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('de-DE', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
  });
}

function getRepoUrl(urls: Record<string, string> | undefined): string | null {
  if (!urls) return null;
  return (
    urls['Source'] ||
    urls['Repository'] ||
    urls['GitHub'] ||
    urls['Code'] ||
    null
  );
}

function getDocsUrl(urls: Record<string, string> | undefined): string | null {
  if (!urls) return null;
  return urls['Documentation'] || urls['Docs'] || null;
}

const info = pkg?.info;
const latestRelease = pkg?.urls?.[0];
const releaseDate = latestRelease
  ? formatDate(latestRelease.upload_time)
  : null;
const repoUrl = info?.project_urls ? getRepoUrl(info.project_urls) : null;
const docsUrl = info?.project_urls ? getDocsUrl(info.project_urls) : null;
const keywords =
  info?.keywords
    ?.split(',')
    .map((k) => k.trim())
    .filter(Boolean) || [];
---

{
  error ? (
    <div
      class={cn(
        'p-4 rounded-xl bg-red-950/50 border border-red-500/30 text-red-300 text-sm',
        className
      )}
    >
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5 shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        {error}: {packageName}
      </div>
    </div>
  ) : info && variant === 'badge' ? (
    <a
      href={`https://pypi.org/project/${packageName}/`}
      target="_blank"
      rel="noopener"
      class={cn(
        'inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-500/20 border border-blue-500/30 text-blue-300 hover:bg-blue-500/30 transition-colors text-sm font-medium',
        className
      )}
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M9.585 11.692h4.328s2.432.039 2.432-2.35V5.391S16.714 3 11.936 3C7.362 3 7.647 4.983 7.647 4.983l.006 2.055h4.363v.617H5.92s-2.927-.332-2.927 4.282 2.555 4.45 2.555 4.45h1.524v-2.141s-.083-2.554 2.513-2.554zm-.056-6.086a.829.829 0 110-1.658.829.829 0 010 1.658z" />
        <path d="M18.452 7.532h-1.524v2.141s.083 2.554-2.513 2.554h-4.328s-2.432-.04-2.432 2.35v3.951s-.369 2.391 4.409 2.391c4.573 0 4.288-1.983 4.288-1.983l-.006-2.054h-4.363v-.617h6.097s2.927.332 2.927-4.282-2.555-4.451-2.555-4.451zm-3.981 10.436a.829.829 0 110 1.658.829.829 0 010-1.658z" />
      </svg>
      {packageName}
      <span class="text-blue-400">v{info.version}</span>
    </a>
  ) : info && variant === 'compact' ? (
    <a
      href={`https://pypi.org/project/${packageName}/`}
      target="_blank"
      rel="noopener"
      class={cn(
        'flex items-center gap-4 p-4 rounded-xl bg-slate-800/50 border border-slate-700/50 hover:border-blue-500/30 transition-colors',
        className
      )}
    >
      <div class="p-2.5 rounded-xl bg-gradient-to-br from-blue-500 to-yellow-500 shadow-lg shadow-blue-500/25">
        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9.585 11.692h4.328s2.432.039 2.432-2.35V5.391S16.714 3 11.936 3C7.362 3 7.647 4.983 7.647 4.983l.006 2.055h4.363v.617H5.92s-2.927-.332-2.927 4.282 2.555 4.45 2.555 4.45h1.524v-2.141s-.083-2.554 2.513-2.554zm-.056-6.086a.829.829 0 110-1.658.829.829 0 010 1.658z" />
          <path d="M18.452 7.532h-1.524v2.141s.083 2.554-2.513 2.554h-4.328s-2.432-.04-2.432 2.35v3.951s-.369 2.391 4.409 2.391c4.573 0 4.288-1.983 4.288-1.983l-.006-2.054h-4.363v-.617h6.097s2.927.332 2.927-4.282-2.555-4.451-2.555-4.451zm-3.981 10.436a.829.829 0 110 1.658.829.829 0 010-1.658z" />
        </svg>
      </div>
      <div class="flex-1 min-w-0">
        <h3 class="font-bold text-slate-100">{packageName}</h3>
        <p class="text-sm text-slate-400 truncate">
          {info.summary || 'Keine Beschreibung'}
        </p>
      </div>
      <div class="text-right shrink-0">
        <p class="font-semibold text-slate-200">v{info.version}</p>
        {info.author && <p class="text-xs text-slate-500">{info.author}</p>}
      </div>
    </a>
  ) : (
    info && (
      <div
        class={cn(
          'rounded-2xl bg-gradient-to-br from-slate-800/90 to-slate-900/90 border border-slate-700/50 overflow-hidden',
          className
        )}
      >
        <header class="px-5 py-4 border-b border-slate-700/50 bg-gradient-to-r from-blue-500/5 to-yellow-500/5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="p-2.5 rounded-xl bg-gradient-to-br from-blue-500 to-yellow-500 shadow-lg shadow-blue-500/25">
                <svg
                  class="w-5 h-5 text-white"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M9.585 11.692h4.328s2.432.039 2.432-2.35V5.391S16.714 3 11.936 3C7.362 3 7.647 4.983 7.647 4.983l.006 2.055h4.363v.617H5.92s-2.927-.332-2.927 4.282 2.555 4.45 2.555 4.45h1.524v-2.141s-.083-2.554 2.513-2.554zm-.056-6.086a.829.829 0 110-1.658.829.829 0 010 1.658z" />
                  <path d="M18.452 7.532h-1.524v2.141s.083 2.554-2.513 2.554h-4.328s-2.432-.04-2.432 2.35v3.951s-.369 2.391 4.409 2.391c4.573 0 4.288-1.983 4.288-1.983l-.006-2.054h-4.363v-.617h6.097s2.927.332 2.927-4.282-2.555-4.451-2.555-4.451zm-3.981 10.436a.829.829 0 110 1.658.829.829 0 010-1.658z" />
                </svg>
              </div>
              <div>
                <h3 class="font-bold text-slate-100 text-lg">{info.name}</h3>
                <p class="text-xs text-slate-400">
                  von {info.author || 'Unbekannt'}
                </p>
              </div>
            </div>

            <span class="px-3 py-1.5 rounded-full text-xs font-semibold bg-blue-500/20 text-blue-300 border border-blue-500/30">
              v{info.version}
            </span>
          </div>
        </header>

        <div class="p-5">
          {info.summary && <p class="text-slate-300 mb-4">{info.summary}</p>}

          {/* Stats Grid */}
          <div class="grid grid-cols-3 gap-3 mb-4">
            {info.license && (
              <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700/30 text-center">
                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">
                  Lizenz
                </p>
                <p class="font-semibold text-slate-200 text-sm truncate">
                  {info.license}
                </p>
              </div>
            )}
            {showRequirements && info.requires_python && (
              <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700/30 text-center">
                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">
                  Python
                </p>
                <p class="font-semibold text-slate-200 text-sm">
                  {info.requires_python}
                </p>
              </div>
            )}
            {releaseDate && (
              <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700/30 text-center">
                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">
                  Aktualisiert
                </p>
                <p class="font-semibold text-slate-200 text-sm">
                  {releaseDate}
                </p>
              </div>
            )}
          </div>

          {/* Keywords */}
          {keywords.length > 0 && (
            <div class="mb-4">
              <p class="text-xs text-slate-500 uppercase tracking-wide mb-2">
                Keywords
              </p>
              <div class="flex flex-wrap gap-2">
                {keywords.slice(0, 8).map((keyword) => (
                  <span class="px-2 py-0.5 rounded-full text-xs bg-slate-700/50 text-slate-400">
                    {keyword}
                  </span>
                ))}
              </div>
            </div>
          )}

          {/* Install Command */}
          <div class="p-3 rounded-lg bg-slate-950/50 border border-slate-700/30 font-mono text-sm">
            <span class="text-slate-500">$</span>
            <span class="text-emerald-400 ml-2">pip</span>
            <span class="text-slate-300"> install </span>
            <span class="text-yellow-400">{packageName}</span>
          </div>
        </div>

        {/* Footer with Links */}
        {showLinks && (
          <footer class="px-5 py-3 border-t border-slate-700/50 bg-slate-800/30 flex items-center justify-between gap-4">
            <a
              href={`https://pypi.org/project/${packageName}/`}
              target="_blank"
              rel="noopener"
              class="text-sm text-blue-400 hover:text-blue-300 transition-colors"
            >
              PyPI →
            </a>
            {docsUrl && (
              <a
                href={docsUrl}
                target="_blank"
                rel="noopener"
                class="text-sm text-emerald-400 hover:text-emerald-300 transition-colors"
              >
                Docs →
              </a>
            )}
            {repoUrl && (
              <a
                href={repoUrl}
                target="_blank"
                rel="noopener"
                class="text-sm text-slate-400 hover:text-slate-300 transition-colors"
              >
                Repository →
              </a>
            )}
            {info.home_page && (
              <a
                href={info.home_page}
                target="_blank"
                rel="noopener"
                class="text-sm text-slate-400 hover:text-slate-300 transition-colors"
              >
                Homepage →
              </a>
            )}
          </footer>
        )}
      </div>
    )
  )
}
