---
import { tv } from 'tailwind-variants';

interface Props {
  src: string;
  title?: string;
  artist?: string;
  cover?: string;
  autoplay?: boolean;
  loop?: boolean;
  variant?: 'compact' | 'full';
  coverAspect?: 'square' | 'wide';
  captionsSrc?: string;
  captionsLabel?: string;
  className?: string;
}

const {
  src,
  title,
  artist,
  cover,
  autoplay = false,
  loop = false,
  variant = 'full',
  coverAspect = 'square',
  captionsSrc,
  captionsLabel = 'Transcript',
  className = '',
} = Astro.props as Props;

const stackGap = 'gap-3 sm:gap-4 md:gap-5';
const shouldShowMetadata = variant === 'full' && (title || artist);
const hasWideCover = variant === 'full' && cover && coverAspect === 'wide';
const showMediaSection = variant === 'full' && (cover || shouldShowMetadata);
const containerLayout = `flex flex-col ${stackGap}`;
const mediaSectionClasses = hasWideCover
  ? 'flex flex-col md:flex-row md:items-center gap-2.5 sm:gap-3 md:gap-4 w-full'
  : 'flex flex-col gap-2.5 sm:gap-3 sm:flex-row sm:items-center';
const mediaContentClasses = hasWideCover
  ? 'flex flex-col gap-1.5 md:min-w-[14rem]'
  : 'min-w-0 flex-1 space-y-1';
const controlsLayout =
  variant === 'compact'
    ? 'flex flex-wrap items-center gap-4 sm:gap-5'
    : 'flex flex-col gap-4 sm:gap-5';
// Top offset for controls
const hasTranscript = Boolean(captionsSrc);
const transcriptSrcAttr = hasTranscript
  ? encodeURIComponent(captionsSrc!)
  : undefined;
const playerId = `audio-player-${Math.random().toString(36).slice(2, 9)}`;
import Icon from './Icon.astro';

const playerTv = tv({
  base: 'relative overflow-hidden rounded-2xl border shadow-sm transition-colors motion-reduce:transition-none flex flex-col',
  variants: {
    variant: {
      compact: 'p-3 sm:p-4 md:p-5 gap-4 sm:gap-5',
      full: 'p-5 sm:p-6 md:p-7 gap-5 sm:gap-6',
    },
    layoutRow: {
      true: 'md:flex-row md:items-start md:gap-4 lg:gap-6',
      false: '',
    },
  },
  defaultVariants: {
    variant: 'full',
    layoutRow: false,
  },
});

const playBtnTv = tv({
  base: 'inline-flex items-center justify-center rounded-full text-lg font-semibold shadow-sm transition motion-reduce:transition-none',
  variants: {
    variant: {
      compact:
        'h-9 w-9 min-h-9 min-w-9 bg-[#0f3ba8] text-white border border-[#0c2f87] dark:bg-[#cde2ff] dark:text-[#0b1220] dark:border-[#b7d4ff] md:h-10 md:w-10 lg:h-12 lg:w-12',
      full: 'h-10 w-10 min-h-10 min-w-10 bg-[#0f3ba8] text-lg text-white border border-[#0c2f87] dark:bg-[#cde2ff] dark:text-[#0b1220] dark:border-[#b7d4ff] md:h-12 md:w-12 lg:h-14 lg:w-14',
    },
  },
  defaultVariants: {
    variant: 'full',
  },
});

const rootClasses = [
  playerTv({ variant, layoutRow: variant === 'full' && !shouldShowMetadata }),
  className,
  'AudioPlayer',
  variant === 'compact' ? 'AudioPlayer--Compact' : 'AudioPlayer--Full',
  'bg-[#f8fafc] border-[#c2d4f5] text-[#0b152f]',
  'dark:bg-[#0b1220] dark:border-[#243655] dark:text-[#e9eef5]',
  hasWideCover ? 'p-0 sm:p-0 md:p-0' : '',
]
  .filter(Boolean)
  .join(' ');
const innerPadding = hasWideCover
  ? 'px-4 sm:px-5 md:px-6 pb-4 sm:pb-5 md:pb-6'
  : '';
---

<div
  id={playerId}
  class={rootClasses}
  data-audio-player
  data-variant={variant}
  data-transcript-src={transcriptSrcAttr}
  data-transcript-label={captionsLabel}
  aria-live="polite"
>
  <div class={`${containerLayout} AudioPlayer__Body`.trim()}>
    {
      showMediaSection && (
        <div
          class={`${mediaSectionClasses} AudioPlayer__MediaSection${hasWideCover ? ' AudioPlayer__MediaSection--Wide' : ''}`.trim()}
        >
          {cover && (
            <div
              class={`${
                hasWideCover
                  ? 'overflow-hidden rounded-xl w-full'
                  : 'shrink-0 overflow-hidden rounded-2xl'
              } AudioPlayer__CoverWrapper${hasWideCover ? ' AudioPlayer__CoverWrapper--Wide' : ''}`}
            >
              <div
                class={`${hasWideCover ? 'aspect-video w-full' : ''} AudioPlayer__CoverInner`.trim()}
              >
                <img
                  src={cover}
                  alt={title ? `${title} cover art` : 'Album cover'}
                  class={`${
                    hasWideCover
                      ? 'h-full w-full object-cover'
                      : 'h-20 w-28 sm:h-24 sm:w-32 md:h-28 md:w-36 object-cover'
                  } AudioPlayer__CoverImage${variant === 'compact' ? ' AudioPlayer__CoverImage--Compact' : ' AudioPlayer__CoverImage--Full'}`}
                />
              </div>
            </div>
          )}
          {shouldShowMetadata && (
            <div class={`${mediaContentClasses} AudioPlayer__Metadata`.trim()}>
              {title && (
                <p class="text-lg font-semibold tracking-tight text-[#0b152f] dark:text-[#e9eef5] AudioPlayer__Title">
                  {title}
                </p>
              )}
              {artist && (
                <p class="text-sm font-medium text-[#1a2f55] dark:text-[#d7e3ff] AudioPlayer__Artist">
                  {artist}
                </p>
              )}
            </div>
          )}
        </div>
      )
    }

    <audio
      src={src}
      preload="metadata"
      loop={loop}
      autoplay={autoplay}
      data-audio
      class="AudioPlayer__Audio"
      aria-label={title ? `Audio player for ${title}` : 'Audio player'}></audio>

    <div class={innerPadding}>
      <div
        class={`${controlsLayout} AudioPlayer__Controls${variant === 'compact' ? ' AudioPlayer__Controls--Compact' : ' AudioPlayer__Controls--Full'}`.trim()}
      >
        {
          variant === 'compact' && cover && (
            <img
              src={cover}
              alt={title ? `${title} cover art` : 'Album cover'}
              class="h-14 w-14 shrink-0 rounded-2xl object-cover shadow-sm sm:h-16 sm:w-16 md:h-20 md:w-20 lg:h-24 lg:w-24 self-center AudioPlayer__CoverImage AudioPlayer__CoverImage--Compact"
            />
          )
        }
        <div
          class={`${
            variant === 'compact' ? 'flex-1 min-w-0' : 'w-full'
          } space-y-4 AudioPlayer__ControlsBody`.trim()}
        >
          <div
            class="flex flex-wrap items-center justify-between gap-3 sm:gap-4 AudioPlayer__PrimaryActions"
          >
            <button
              type="button"
              class={`${playBtnTv({ variant })} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#0b2c73] focus-visible:ring-offset-2 focus-visible:ring-offset-[#f8fafc] dark:focus-visible:ring-offset-[#0b1220] AudioPlayer__PlayPauseButton ${variant === 'compact' ? 'AudioPlayer__PlayPauseButton--Compact' : 'AudioPlayer__PlayPauseButton--Full'}`.trim()}
              data-play-pause
              aria-label="Play or pause audio"
              aria-pressed="false"
            >
              <span data-play-icon>
                <Icon name="play" size="xl" decorative />
              </span>
              <span data-pause-icon class="hidden">
                <Icon name="pause" size="xl" decorative />
              </span>
            </button>

            <button
              type="button"
              class={`inline-flex items-center justify-center rounded-full text-lg font-semibold shadow-sm transition motion-reduce:transition-none border border-[#94b0e9] text-[#0b152f] bg-[#eef2fb] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#0b2c73] focus-visible:ring-offset-2 focus-visible:ring-offset-[#f8fafc] dark:border-[#39507a] dark:text-[#d7e3ff] dark:bg-[#16233a] dark:focus-visible:ring-offset-[#0b1220] ${variant === 'compact' ? 'h-9 w-9 md:h-10 lg:h-12 lg:w-12' : 'h-10 w-10 md:h-12 lg:h-12 lg:w-12'} AudioPlayer__MuteButton ${variant === 'compact' ? 'AudioPlayer__MuteButton--Compact' : 'AudioPlayer__MuteButton--Full'}`.trim()}
              data-mute
              aria-label="Mute or unmute audio"
              aria-pressed="false"
            >
              <span
                data-volume-icon
                class="flex align-center items-center justify-center translate-x-px translate-y-px AudioPlayer__VolumeIcon"
              >
                <Icon name="volume" size="xl" decorative />
              </span>
              <span
                data-mute-icon
                class="hidden translate-x-px translate-y-px AudioPlayer__MuteIcon"
              >
                <Icon name="mute" size="xl" decorative />
              </span>
            </button>
          </div>

          <div class="space-y-2 sm:space-y-2.5 AudioPlayer__Timeline">
            <div
              class="flex flex-col items-stretch gap-2 sm:flex-row sm:items-center sm:gap-2.5 AudioPlayer__SeekRow"
            >
              <span
                class="text-xs sm:text-sm font-semibold uppercase tracking-wide text-[#1a2f55] dark:text-[#d7e3ff] w-12 sm:w-14 text-left sm:text-center shrink-0 AudioPlayer__CurrentTime"
                data-current-time>0:00</span
              >
              <div class="flex-1 min-w-0 AudioPlayer__SeekTrack">
                <input
                  type="range"
                  min="0"
                  value="0"
                  step="0.1"
                  id="seek-label"
                  class="h-3.5 sm:h-4 w-full appearance-none rounded-full bg-transparent transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#0b2c73] focus-visible:ring-offset-2 focus-visible:ring-offset-[#f8fafc] motion-reduce:transition-none dark:focus-visible:ring-offset-[#0b1220] AudioPlayer__SeekInput"
                  data-seek
                  role="slider"
                  aria-label="Seek position"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  aria-valuenow="0"
                />
              </div>
              <span
                class="text-xs sm:text-sm font-semibold uppercase tracking-wide text-[#1a2f55] dark:text-[#d7e3ff] w-12 sm:w-14 text-right sm:text-center shrink-0 AudioPlayer__Duration"
                data-duration>0:00</span
              >
            </div>
          </div>
        </div>
      </div>
      {
        hasTranscript && (
          <div class="w-full mt-4 md:mt-6 AudioPlayer__Transcript">
            <div
              class="mx-0 overflow-hidden rounded-lg border shadow-inner transition-colors motion-reduce:transition-none border-[#94b0e9] bg-[#eef2fb] dark:border-[#39507a] dark:bg-[#111a2d] AudioPlayer__TranscriptContainer"
              data-transcript-container
            >
              <button
                type="button"
                class="flex w-full items-center justify-between gap-2 px-3 py-2 text-left text-sm font-semibold text-[#0b152f] bg-[#f8fafc] transition-colors hover:bg-[#e2e8f5] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#0b2c73] focus-visible:ring-offset-2 focus-visible:ring-offset-[#eef2fb] motion-reduce:transition-none dark:text-[#e9eef5] dark:bg-[#111a2d] dark:hover:bg-[#16233a] dark:focus-visible:ring-offset-[#0b1220] min-h-10 AudioPlayer__TranscriptToggle"
                data-transcript-toggle
                aria-expanded="true"
                aria-controls={`${playerId}-transcript`}
                aria-label={`${captionsLabel} (click to show or hide)`}
              >
                <span
                  data-transcript-toggle-label
                  class="AudioPlayer__TranscriptToggleLabel"
                >
                  {captionsLabel}
                </span>
                <span
                  aria-hidden="true"
                  class="text-lg transition-transform AudioPlayer__TranscriptToggleIcon"
                  data-transcript-toggle-icon
                >
                  <Icon
                    name="chevron-down"
                    size="lg"
                    decorative
                    aria-hidden="true"
                  />
                </span>
              </button>
              <div
                id={`${playerId}-transcript`}
                class="border-t border-[#94b0e9] bg-[#f8fafc] dark:border-[#39507a] dark:bg-[#0b1220] AudioPlayer__TranscriptPanel"
                data-transcript-panel
                role="group"
              >
                <div
                  class="px-3 py-2 text-sm text-[#0b152f] dark:text-[#e9eef5] AudioPlayer__TranscriptLoading"
                  data-transcript-loading
                >
                  Loading transcriptâ€¦
                </div>
                <div
                  class="hidden px-3 py-2 text-sm text-[#b42318] dark:text-[#f97066] AudioPlayer__TranscriptError"
                  data-transcript-error
                >
                  Unable to load transcript.
                </div>
                <ol
                  class="hidden max-h-[14rem] md:max-h-[16rem] lg:max-h-[18rem] space-y-1 overflow-y-auto px-3 py-2 text-sm leading-relaxed text-[#0b152f] dark:text-[#e9eef5] AudioPlayer__TranscriptList"
                  data-transcript-list
                />
              </div>
            </div>
          </div>
        )
      }
    </div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const players = document.querySelectorAll('[data-audio-player]');

    const formatTime = (seconds) => {
      if (!Number.isFinite(seconds) || seconds < 0) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${String(mins)}:${String(secs).padStart(2, '0')}`;
    };

    const getDuration = (audioEl) => {
      if (!(audioEl instanceof HTMLAudioElement)) return 0;
      if (Number.isFinite(audioEl.duration)) return audioEl.duration;
      if (audioEl.seekable?.length) {
        return audioEl.seekable.end(audioEl.seekable.length - 1);
      }
      return 0;
    };

    const updateSeekVisual = (input, audio) => {
      const max = Number(input.max) || 0;
      const value = Number(input.value) || 0;
      const percent =
        max > 0 ? Math.min(Math.max((value / max) * 100, 0), 100) : 0;
      input.style.setProperty('--seek-percent', `${percent}%`);
      if (audio instanceof HTMLAudioElement) {
        const seconds = Number.isFinite(value) ? value : audio.currentTime;
        const resolvedSeconds = Number.isFinite(seconds) ? seconds : 0;
        input.setAttribute(
          'aria-valuenow',
          String(Math.floor(resolvedSeconds))
        );
        input.setAttribute('aria-valuetext', formatTime(resolvedSeconds));
        input.setAttribute('aria-valuemax', input.max || '0');
      }
    };

    const escapeHtml = (value) =>
      value.replace(/[&<>"']/g, (char) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        };
        return map[char] || char;
      });

    const parseTime = (value) => {
      const parts = value.split(':').map((segment) => segment.trim());
      if (parts.length === 3) {
        const [hours, minutes, seconds] = parts;
        return (
          Number(hours) * 3600 +
          Number(minutes) * 60 +
          parseFloat(seconds.replace(',', '.'))
        );
      }
      if (parts.length === 2) {
        const [minutes, seconds] = parts;
        return Number(minutes) * 60 + parseFloat(seconds.replace(',', '.'));
      }
      return Number(value) || 0;
    };

    const parseVtt = (text) => {
      const sanitized = text.replace(/\r/g, '');
      const chunks = sanitized.split(/\n\n+/);
      const cues = [];
      chunks.forEach((chunk) => {
        const lines = chunk.trim().split('\n').filter(Boolean);
        if (!lines.length) return;
        const header = lines[0];
        let timingIndex = 0;
        if (header.startsWith('WEBVTT')) return;
        if (!header.includes('-->') && lines.length > 1) {
          timingIndex = 1;
        }
        const timingLine = lines[timingIndex];
        if (!timingLine || !timingLine.includes('-->')) return;
        const [rawStart, rawEnd] = timingLine
          .split('-->')
          .map((segment) => segment.trim().split(' ')[0]);
        const textLines = lines.slice(timingIndex + 1);
        const cueText = textLines.join(' ').trim();
        cues.push({
          start: parseTime(rawStart),
          end: parseTime(rawEnd),
          text: cueText,
        });
      });
      return cues.sort((a, b) => a.start - b.start);
    };

    players.forEach((player) => {
      if (!(player instanceof HTMLElement)) return;
      const audio = player.querySelector('[data-audio]');
      if (!(audio instanceof HTMLAudioElement)) return;

      const playPauseBtn = player.querySelector('[data-play-pause]');
      const playIcon = player.querySelector('[data-play-icon]');
      const pauseIcon = player.querySelector('[data-pause-icon]');
      const muteBtn = player.querySelector('[data-mute]');
      const volumeIcon = player.querySelector('[data-volume-icon]');
      const muteIcon = player.querySelector('[data-mute-icon]');
      const currentTimeEl = player.querySelector('[data-current-time]');
      const durationEl = player.querySelector('[data-duration]');
      const seekInput = player.querySelector('[data-seek]');
      const transcriptSrc = player.dataset.transcriptSrc
        ? decodeURIComponent(player.dataset.transcriptSrc)
        : null;
      const transcriptLabel = player.dataset.transcriptLabel || 'Transcript';
      const transcriptToggle = player.querySelector('[data-transcript-toggle]');
      const transcriptPanel = player.querySelector('[data-transcript-panel]');
      const transcriptList = player.querySelector('[data-transcript-list]');
      const transcriptLoading = player.querySelector(
        '[data-transcript-loading]'
      );
      const transcriptError = player.querySelector('[data-transcript-error]');
      const transcriptToggleLabel = player.querySelector(
        '[data-transcript-toggle-label]'
      );
      const transcriptToggleIcon = player.querySelector(
        '[data-transcript-toggle-icon]'
      );

      if (transcriptToggleLabel instanceof HTMLElement) {
        transcriptToggleLabel.textContent = transcriptLabel;
      }

      if (seekInput instanceof HTMLInputElement) {
        seekInput.setAttribute('aria-valuemin', '0');
        seekInput.setAttribute('role', 'slider');
        seekInput.setAttribute('aria-label', 'Seek position');
        updateSeekVisual(seekInput, audio);
      }

      const updateDurationAndSeek = () => {
        if (!(seekInput instanceof HTMLInputElement)) return;
        const duration = getDuration(audio);
        if (durationEl instanceof HTMLElement) {
          durationEl.textContent = formatTime(duration);
        }
        seekInput.max = duration > 0 ? String(duration) : '0';
        updateSeekVisual(seekInput, audio);
      };

      const updateCurrentTime = () => {
        if (currentTimeEl instanceof HTMLElement) {
          currentTimeEl.textContent = formatTime(audio.currentTime);
        }
      };

      playPauseBtn?.addEventListener('click', () => {
        if (audio.paused) {
          audio.play().catch(() => {
            /* ignore */
          });
        } else {
          audio.pause();
        }
      });

      audio.addEventListener('play', () => {
        playIcon?.classList.add('hidden');
        pauseIcon?.classList.remove('hidden');
        if (playPauseBtn instanceof HTMLElement) {
          playPauseBtn.setAttribute('aria-label', 'Pause audio');
          playPauseBtn.setAttribute('aria-pressed', 'true');
        }
      });

      audio.addEventListener('pause', () => {
        playIcon?.classList.remove('hidden');
        pauseIcon?.classList.add('hidden');
        if (playPauseBtn instanceof HTMLElement) {
          playPauseBtn.setAttribute('aria-label', 'Play audio');
          playPauseBtn.setAttribute('aria-pressed', 'false');
        }
      });

      muteBtn?.addEventListener('click', () => {
        audio.muted = !audio.muted;
        if (volumeIcon instanceof HTMLElement)
          volumeIcon.classList.toggle('hidden', audio.muted);
        if (muteIcon instanceof HTMLElement)
          muteIcon.classList.toggle('hidden', !audio.muted);
        if (muteBtn instanceof HTMLElement) {
          muteBtn.setAttribute('aria-pressed', audio.muted ? 'true' : 'false');
          muteBtn.setAttribute(
            'aria-label',
            audio.muted ? 'Unmute audio' : 'Mute audio'
          );
        }
      });

      audio.addEventListener('loadedmetadata', () => {
        updateDurationAndSeek();
      });

      audio.addEventListener('timeupdate', () => {
        updateCurrentTime();
        if (seekInput instanceof HTMLInputElement) {
          seekInput.value = String(audio.currentTime);
          updateSeekVisual(seekInput, audio);
        }
      });

      seekInput?.addEventListener('input', () => {
        if (!(seekInput instanceof HTMLInputElement)) return;
        const next = Number(seekInput.value);
        if (Number.isFinite(next) && audio.duration > 0) {
          audio.currentTime = Math.min(Math.max(next, 0), audio.duration);
        }
        updateSeekVisual(seekInput, audio);
      });

      seekInput?.addEventListener('change', () => {
        if (!(seekInput instanceof HTMLInputElement)) return;
        const next = Number(seekInput.value);
        if (Number.isFinite(next) && audio.duration > 0) {
          audio.currentTime = Math.min(Math.max(next, 0), audio.duration);
        }
      });

      audio.addEventListener('durationchange', updateDurationAndSeek);
      audio.addEventListener('canplay', updateDurationAndSeek);
      audio.addEventListener('loadeddata', updateDurationAndSeek);
      audio.addEventListener('loadeddata', updateCurrentTime);
      audio.addEventListener('canplay', updateCurrentTime);

      if (
        transcriptSrc &&
        transcriptToggle instanceof HTMLElement &&
        transcriptPanel instanceof HTMLElement &&
        transcriptList instanceof HTMLOListElement
      ) {
        let cues = [];
        let activeCueIndex = -1;
        let transcriptLoaded = false;
        let transcriptLoadingState = false;
        const activeTranscriptClasses = [
          'bg-[#d2ddf7]',
          'text-[#0f3ba8]',
          'border-l-4',
          'border-l-[#0f3ba8]',
          'dark:bg-[#1c2b47]',
          'dark:text-[#cde2ff]',
          'dark:border-l-[#cde2ff]',
        ];

        const setTranscriptExpanded = (expanded) => {
          transcriptPanel.classList.toggle('hidden', !expanded);
          transcriptToggle.setAttribute(
            'aria-expanded',
            expanded ? 'true' : 'false'
          );
          transcriptToggleIcon?.classList.toggle('rotate-180', expanded);
        };

        const clearHighlights = () => {
          transcriptList
            .querySelectorAll('[data-transcript-entry]')
            .forEach((entry) => {
              entry.setAttribute('data-active', 'false');
              if (entry instanceof HTMLElement) {
                activeTranscriptClasses.forEach((cls) =>
                  entry.classList.remove(cls)
                );
              }
            });
        };

        const updateActiveCue = (time) => {
          if (!transcriptLoaded || !cues.length) return;
          let nextIndex = cues.findIndex(
            (cue) => time >= cue.start && time < cue.end
          );
          if (nextIndex === -1 && time >= cues[cues.length - 1].end) {
            nextIndex = cues.length - 1;
          }
          if (nextIndex === activeCueIndex) return;
          activeCueIndex = nextIndex;
          clearHighlights();
          if (activeCueIndex >= 0) {
            const entry = transcriptList.querySelector(
              `[data-transcript-entry="${activeCueIndex}"]`
            );
            if (entry instanceof HTMLElement) {
              entry.setAttribute('data-active', 'true');
              activeTranscriptClasses.forEach((cls) =>
                entry.classList.add(cls)
              );
              entry.scrollIntoView({ block: 'nearest' });
            }
          }
        };

        const renderTranscript = () => {
          if (!transcriptLoaded) return;
          if (transcriptLoading instanceof HTMLElement) {
            transcriptLoading.classList.add('hidden');
          }
          if (transcriptError instanceof HTMLElement) {
            transcriptError.classList.add('hidden');
          }
          if (!cues.length) {
            if (transcriptError instanceof HTMLElement) {
              transcriptError.textContent = 'No transcript cues available.';
              transcriptError.classList.remove('hidden');
            }
            return;
          }
          transcriptList.innerHTML = cues
            .map(
              (cue, index) => `
                <li>
                  <button
                    type="button"
                    class="w-full rounded-lg bg-[#eef2fb] px-3 py-2.5 text-left text-sm font-medium text-[#0b152f] transition hover:bg-[#e2e8f5] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#0b2c73] focus-visible:ring-offset-2 focus-visible:ring-offset-[#f8fafc] dark:bg-[#111a2d] dark:text-[#e9eef5] dark:hover:bg-[#16233a] dark:focus-visible:ring-offset-[#0b1220] min-h-11 AudioPlayer__TranscriptEntry"
                    data-transcript-entry="${index}"
                    data-cue-start="${cue.start}"
                    data-active="false"
                    aria-label="Jump to transcript at ${formatTime(cue.start)}"
                  >
                    ${escapeHtml(cue.text)}
                  </button>
                </li>
              `
            )
            .join('');
          transcriptList.classList.remove('hidden');
        };

        const loadTranscript = async () => {
          if (transcriptLoaded || transcriptLoadingState) return;
          transcriptLoadingState = true;
          try {
            if (transcriptLoading instanceof HTMLElement) {
              transcriptLoading.classList.remove('hidden');
            }
            const response = await fetch(transcriptSrc);
            if (!response.ok) throw new Error('Request failed');
            const text = await response.text();
            cues = parseVtt(text);
            transcriptLoaded = true;
            renderTranscript();
            updateActiveCue(audio.currentTime);
          } catch {
            if (transcriptError instanceof HTMLElement) {
              transcriptError.textContent = 'Unable to load transcript.';
              transcriptError.classList.remove('hidden');
            }
            if (transcriptLoading instanceof HTMLElement) {
              transcriptLoading.classList.add('hidden');
            }
          } finally {
            transcriptLoadingState = false;
          }
        };

        transcriptToggle.addEventListener('click', () => {
          const expanded =
            transcriptToggle.getAttribute('aria-expanded') === 'true';
          const nextExpanded = !expanded;
          setTranscriptExpanded(nextExpanded);
          if (nextExpanded) {
            loadTranscript();
          }
        });

        transcriptList.addEventListener('click', (event) => {
          const target =
            event.target instanceof HTMLElement
              ? event.target.closest('[data-transcript-entry]')
              : null;
          if (!(target instanceof HTMLElement)) return;
          const start = Number(target.getAttribute('data-cue-start'));
          if (Number.isFinite(start)) {
            audio.currentTime = Math.max(start, 0);
            audio.play().catch(() => {});
          }
        });

        audio.addEventListener('timeupdate', () => {
          updateActiveCue(audio.currentTime);
        });

        audio.addEventListener('seeked', () => {
          updateActiveCue(audio.currentTime);
        });

        if (
          transcriptList instanceof HTMLElement &&
          transcriptList.hasChildNodes()
        ) {
          updateActiveCue(audio.currentTime);
        }

        // Open transcript panel by default when a transcript source exists
        setTranscriptExpanded(true);
        // Load transcript immediately so it's available under the player
        loadTranscript();
      }

      if (audio.readyState >= 1) {
        updateDurationAndSeek();
        updateCurrentTime();
      }
    });
  });
</script>

<style is:inline>
  [data-audio-player] {
    --seek-fill: #0f3ba8;
    --seek-bg: #d2ddf7;
    --seek-percent: 0%;
  }

  :where(.dark) [data-audio-player] {
    --seek-fill: #cde2ff;
    --seek-bg: #1c2b47;
  }

  [data-audio-player] [data-seek] {
    background: linear-gradient(
      90deg,
      var(--seek-fill) 0%,
      var(--seek-fill) var(--seek-percent),
      var(--seek-bg) var(--seek-percent),
      var(--seek-bg) 100%
    );
    height: 0.75rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--seek-bg) 80%, transparent);
  }

  [data-audio-player] [data-seek]:focus-visible {
    outline: none;
  }

  [data-audio-player] [data-seek]::-webkit-slider-thumb,
  [data-audio-player] [data-seek]::-moz-range-thumb {
    -webkit-appearance: none;
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 999px;
    background: var(--seek-fill);
    border: 2px solid color-mix(in srgb, white 80%, transparent);
    cursor: pointer;
  }

  [data-audio-player] [data-seek]::-webkit-slider-thumb:focus,
  [data-audio-player] [data-seek]::-moz-range-thumb:focus {
    outline: var(--focus-ring-width) solid var(--focus-ring-color);
    outline-offset: 2px;
  }

  :where(.dark) [data-audio-player] [data-seek]::-webkit-slider-thumb,
  :where(.dark) [data-audio-player] [data-seek]::-moz-range-thumb {
    border-color: color-mix(in srgb, black 30%, transparent);
  }

  [data-audio-player] [data-seek]::-webkit-slider-runnable-track,
  [data-audio-player] [data-seek]::-moz-range-track {
    height: 0.75rem;
    border-radius: 999px;
    background: transparent;
  }

  @media (min-width: 768px) {
    [data-audio-player] [data-seek]::-webkit-slider-thumb,
    [data-audio-player] [data-seek]::-moz-range-thumb {
      height: 22px;
      width: 22px;
    }
  }
</style>
