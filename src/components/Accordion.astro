---
/**
 * Accordion - collapsible sections (Disclosure)
 */
interface Item {
  id: string;
  title: string;
  content?: string;
}

interface Props {
  items: Item[];
  multiple?: boolean;
  openIds?: string[];
  className?: string;
}

const {
  items = [],
  multiple = false,
  openIds = [],
  className = '',
} = Astro.props as Props;
---

<div
  class={`space-y-4 sm:space-y-5 ${className}`}
  data-multiple={multiple}
  data-open={openIds.join(',')}
>
  {
    items.map((it) => (
      <section class="rounded-xl border border-slate-300 bg-slate-50 text-slate-900 shadow-sm transition-colors focus-within:border-slate-400 motion-reduce:transition-none dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:focus-within:border-slate-500">
        <h3>
          <button
            id={`acc-trigger-${it.id}`}
            class="flex w-full min-h-12 items-center justify-between gap-3 rounded-lg px-4 py-3 text-left text-base font-medium text-slate-900 transition-colors motion-reduce:transition-none hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-900 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50 dark:text-slate-50 dark:hover:bg-slate-800 dark:focus-visible:ring-slate-100 dark:focus-visible:ring-offset-slate-950 sm:px-6 sm:py-4 sm:text-lg"
            data-acc-trigger
            data-id={it.id}
            aria-expanded={openIds.includes(it.id)}
            aria-controls={`acc-panel-${it.id}`}
          >
            <span>{it.title}</span>
            <span
              aria-hidden="true"
              class={`text-xl text-slate-600 transition-transform motion-reduce:rotate-0 motion-reduce:transition-none dark:text-slate-300 ${openIds.includes(it.id) ? 'rotate-180' : ''}`}
              data-acc-icon
            >
              â–¾
            </span>
          </button>
        </h3>
        <div
          id={`acc-panel-${it.id}`}
          data-acc-panel
          data-id={it.id}
          role="region"
          aria-labelledby={`acc-trigger-${it.id}`}
          aria-hidden={openIds.includes(it.id) ? 'false' : 'true'}
          hidden={!openIds.includes(it.id)}
          class={openIds.includes(it.id) ? '' : 'hidden'}
        >
          <div class="px-4 pt-4 pb-5 text-base text-slate-700 dark:text-slate-200 sm:px-6 sm:pt-5 sm:pb-6">
            {it.content ? <div set:html={it.content} /> : null}
          </div>
        </div>
      </section>
    ))
  }
</div>

<script is:inline>
  (function () {
    const root = document.currentScript?.previousElementSibling;
    if (!(root instanceof HTMLElement)) return;
    const multiple = root.getAttribute('data-multiple') === 'true';

    const getOpen = () => {
      const raw = root.getAttribute('data-open') || '';
      return new Set(raw.split(',').filter(Boolean));
    };

    const setOpen = (openSet) => {
      root.setAttribute('data-open', Array.from(openSet).join(','));
    };

    const syncUI = (openSet) => {
      const panels = root.querySelectorAll('[data-acc-panel]');
      panels.forEach((panel) => {
        if (!(panel instanceof HTMLElement)) return;
        const id = panel.getAttribute('data-id');
        const isOpen = id ? openSet.has(id) : false;
        panel.classList.toggle('hidden', !isOpen);
        panel.toggleAttribute('hidden', !isOpen);
        panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
      });

      const triggers = root.querySelectorAll('[data-acc-trigger]');
      triggers.forEach((trigger) => {
        if (!(trigger instanceof HTMLElement)) return;
        const id = trigger.getAttribute('data-id');
        const isOpen = id ? openSet.has(id) : false;
        trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        const panelId = id ? `acc-panel-${id}` : '';
        if (panelId) {
          if (isOpen) {
            trigger.setAttribute('aria-describedby', panelId);
          } else {
            trigger.removeAttribute('aria-describedby');
          }
        }
        const icon = trigger.querySelector('[data-acc-icon]');
        if (icon instanceof HTMLElement) {
          icon.classList.toggle('rotate-180', isOpen);
        }
        trigger.classList.toggle('bg-slate-100', isOpen);
        trigger.classList.toggle('dark:bg-slate-800', isOpen);
      });
    };

    root.addEventListener('click', (event) => {
      const target =
        event.target instanceof HTMLElement
          ? event.target.closest('[data-acc-trigger]')
          : null;
      if (!(target instanceof HTMLElement)) return;
      const id = target.getAttribute('data-id');
      if (!id) return;
      const openSet = getOpen();
      if (openSet.has(id)) {
        openSet.delete(id);
      } else {
        if (!multiple) openSet.clear();
        openSet.add(id);
      }
      setOpen(openSet);
      syncUI(openSet);
    });

    // initial sync to ensure classes reflect provided openIds
    syncUI(getOpen());
  })();
</script>
