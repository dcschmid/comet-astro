---
import { cn } from '../utils/cn';

export interface Step {
  /**
   * The label for the step
   */
  label: string;

  /**
   * Optional description for the step
   */
  description?: string;

  /**
   * Optional icon for the step
   */
  icon?: string;

  /**
   * Whether the step is disabled
   */
  disabled?: boolean;
}

interface Props {
  /**
   * Array of steps to display
   */
  steps: Step[];

  /**
   * Current active step (1-based index)
   */
  currentStep: number;

  /**
   * Layout orientation
   */
  orientation?: 'horizontal' | 'vertical';

  /**
   * Size variant for responsive design
   */
  size?: 'sm' | 'md' | 'lg';

  /**
   * Visual variant
   */
  variant?: 'default' | 'minimal' | 'outlined' | 'filled';

  /**
   * Semantic HTML element to render
   */
  as?: 'nav' | 'ol' | 'div';

  /**
   * ARIA label for the stepper
   */
  ariaLabel?: string;

  /**
   * Whether steps are clickable/interactive
   */
  interactive?: boolean;

  /**
   * Enable visual debugging
   */
  debug?: boolean;

  /**
   * Additional CSS classes
   */
  class?: string;
}

const {
  steps,
  currentStep = 1,
  orientation = 'horizontal',
  size = 'md',
  variant = 'default',
  as: Element = 'nav',
  ariaLabel = 'Progress steps',
  interactive = false,
  debug = false,
  class: className = '',
} = Astro.props as Props;

// Step status calculation
const getStepStatus = (index: number) => {
  const stepNumber = index + 1;
  const step = steps[index];

  if (step?.disabled) return 'disabled';
  if (stepNumber < currentStep) return 'completed';
  if (stepNumber === currentStep) return 'active';
  return 'upcoming';
};

// Size classes for responsive design
const sizeClasses = {
  sm: {
    circle: 'h-8 w-8 text-xs',
    label: 'text-xs',
    description: 'text-xs',
    connector: 'h-0.5',
    connectorVertical: 'w-0.5',
    gap: 'gap-2',
    padding: 'pb-6',
  },
  md: {
    circle: 'h-10 w-10 text-sm',
    label: 'text-sm',
    description: 'text-xs',
    connector: 'h-0.5',
    connectorVertical: 'w-0.5',
    gap: 'gap-3',
    padding: 'pb-8',
  },
  lg: {
    circle: 'h-12 w-12 text-base',
    label: 'text-base',
    description: 'text-sm',
    connector: 'h-1',
    connectorVertical: 'w-1',
    gap: 'gap-4',
    padding: 'pb-10',
  },
};

// Base circle classes with WCAG AAA compliance
const baseCircleClasses = cn(
  'flex items-center justify-center rounded-full border-2 font-semibold transition-all duration-200',
  'focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2',
  'dark:focus:ring-blue-400 dark:focus:ring-offset-slate-900',
  sizeClasses[size].circle
);

// Circle variant classes with WCAG AAA contrast ratios
const getCircleClasses = (status: string) => {
  const baseVariants = {
    default: {
      completed: cn(
        // Light mode - 9:1 contrast
        'border-blue-700 bg-blue-700 text-white shadow-sm',
        // Dark mode - 9:1 contrast
        'dark:border-blue-400 dark:bg-blue-400 dark:text-slate-900',
        // High contrast support
        '@media (prefers-contrast: high) {',
        '  border-blue-900 bg-blue-900 text-white',
        '  dark:border-blue-200 dark:bg-blue-200 dark:text-slate-900',
        '}'
      ),
      active: cn(
        // Light mode - 9:1 contrast
        'border-blue-700 bg-blue-50 text-blue-900 ring-2 ring-blue-200',
        // Dark mode - 9:1 contrast
        'dark:border-blue-400 dark:bg-blue-950 dark:text-blue-200 dark:ring-blue-800',
        // High contrast support
        '@media (prefers-contrast: high) {',
        '  border-blue-900 bg-blue-100 text-blue-900 ring-blue-300',
        '  dark:border-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:ring-blue-600',
        '}'
      ),
      upcoming: cn(
        // Light mode - 9:1 contrast
        'border-slate-400 bg-white text-slate-700',
        // Dark mode - 9:1 contrast
        'dark:border-slate-500 dark:bg-slate-900 dark:text-slate-300',
        // High contrast support
        '@media (prefers-contrast: high) {',
        '  border-slate-900 bg-white text-slate-900',
        '  dark:border-slate-100 dark:bg-slate-900 dark:text-slate-100',
        '}'
      ),
      disabled: cn(
        // Light mode
        'border-slate-300 bg-slate-100 text-slate-400',
        // Dark mode
        'dark:border-slate-600 dark:bg-slate-800 dark:text-slate-500',
        // High contrast support
        '@media (prefers-contrast: high) {',
        '  border-slate-600 bg-slate-200 text-slate-600',
        '  dark:border-slate-400 dark:bg-slate-700 dark:text-slate-400',
        '}'
      ),
    },
  };

  // Other variants extend the default
  const variantStyles = {
    default: baseVariants.default,
    minimal: {
      ...baseVariants.default,
      completed: cn(baseVariants.default.completed, 'border-0 shadow-none'),
      active: cn(baseVariants.default.active, 'border-0 ring-0'),
      upcoming: cn(baseVariants.default.upcoming, 'border-0'),
      disabled: cn(baseVariants.default.disabled, 'border-0'),
    },
    outlined: {
      ...baseVariants.default,
      completed: cn(
        baseVariants.default.completed,
        'bg-transparent text-blue-700 dark:text-blue-400'
      ),
      active: cn(baseVariants.default.active, 'bg-transparent'),
    },
    filled: {
      ...baseVariants.default,
      upcoming: cn(
        baseVariants.default.upcoming,
        'bg-slate-100 dark:bg-slate-800'
      ),
    },
  };

  return variantStyles[variant]?.[status] || baseVariants.default[status];
};

// Label classes with WCAG AAA contrast
const getLabelClasses = (status: string) => {
  const baseClasses = cn('font-semibold', sizeClasses[size].label);

  const statusClasses = {
    completed: cn(
      'text-slate-800 dark:text-slate-100',
      '@media (prefers-contrast: high) { text-slate-900 dark:text-slate-100 }'
    ),
    active: cn(
      'text-slate-900 dark:text-slate-50',
      '@media (prefers-contrast: high) { text-slate-900 dark:text-slate-100 }'
    ),
    upcoming: cn(
      'text-slate-600 dark:text-slate-300',
      '@media (prefers-contrast: high) { text-slate-900 dark:text-slate-100 }'
    ),
    disabled: cn(
      'text-slate-400 dark:text-slate-500',
      '@media (prefers-contrast: high) { text-slate-600 dark:text-slate-400 }'
    ),
  };

  return cn(baseClasses, statusClasses[status]);
};

// Description classes with WCAG AAA contrast
const getDescriptionClasses = (status: string) => {
  const baseClasses = cn(
    'mt-1 leading-snug max-w-xs',
    sizeClasses[size].description
  );

  const statusClasses = {
    completed: cn(
      'text-slate-600 dark:text-slate-300',
      '@media (prefers-contrast: high) { text-slate-900 dark:text-slate-100 }'
    ),
    active: cn(
      'text-slate-700 dark:text-slate-200',
      '@media (prefers-contrast: high) { text-slate-900 dark:text-slate-100 }'
    ),
    upcoming: cn(
      'text-slate-500 dark:text-slate-400',
      '@media (prefers-contrast: high) { text-slate-900 dark:text-slate-100 }'
    ),
    disabled: cn(
      'text-slate-400 dark:text-slate-500',
      '@media (prefers-contrast: high) { text-slate-600 dark:text-slate-400 }'
    ),
  };

  return cn(baseClasses, statusClasses[status]);
};

// Connector classes with WCAG AAA contrast
const getConnectorClasses = (status: string, isVertical: boolean = false) => {
  const sizeClass = isVertical
    ? sizeClasses[size].connectorVertical
    : sizeClasses[size].connector;

  const baseClasses = cn('transition-colors duration-200', sizeClass);

  const statusClasses = {
    completed: cn(
      'bg-blue-700 dark:bg-blue-400',
      '@media (prefers-contrast: high) { bg-blue-900 dark:bg-blue-200 }'
    ),
    upcoming: cn(
      'bg-slate-300 dark:bg-slate-600',
      '@media (prefers-contrast: high) { bg-slate-600 dark:bg-slate-400 }'
    ),
  };

  return cn(
    baseClasses,
    statusClasses[status === 'completed' ? 'completed' : 'upcoming']
  );
};

// Main container classes
const containerClasses = cn(
  // Base layout
  orientation === 'horizontal'
    ? 'flex flex-col gap-4 sm:flex-row sm:items-start'
    : 'flex flex-col',
  // Debug mode
  debug && 'debug-stepper',
  // Custom classes
  className
);

// Generate unique IDs for accessibility
const stepperId = `stepper-${Math.random().toString(36).substr(2, 9)}`;
---

<style>
  .debug-stepper {
    /* Debug visualization */
    outline: 2px dashed rgba(255, 165, 0, 0.7);
    outline-offset: 2px;
    position: relative;
  }

  .debug-stepper::after {
    content: attr(data-debug-info);
    position: absolute;
    top: -1.5rem;
    left: 0;
    font-size: 0.75rem;
    color: rgb(255 165 0);
    background: rgba(255, 255, 255, 0.9);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: monospace;
    z-index: 10;
  }

  @media (prefers-color-scheme: dark) {
    .debug-stepper::after {
      background: rgba(0, 0, 0, 0.9);
      color: rgb(255 165 0);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .debug-stepper,
    .stepper-step,
    .stepper-circle,
    .stepper-connector {
      transition: none !important;
    }
  }

  /* High contrast mode adjustments */
  @media (prefers-contrast: high) {
    .debug-stepper {
      outline-color: rgb(255 165 0) !important;
    }
  }

  /* Interactive step hover states */
  .stepper-step.interactive:hover .stepper-circle {
    transform: scale(1.05);
  }

  .stepper-step.interactive:focus-within .stepper-circle {
    transform: scale(1.05);
  }
</style>

<Element
  class={containerClasses}
  aria-label={ariaLabel}
  role={Element === 'ol' ? undefined : 'progressbar'}
  aria-valuenow={currentStep}
  aria-valuemin={1}
  aria-valuemax={steps.length}
  data-debug-info={debug ? `${orientation} ${size} ${variant}` : undefined}
>
  {
    steps.map((step, index) => {
      const status = getStepStatus(index);
      const stepNumber = index + 1;
      const isLast = index === steps.length - 1;
      const isActive = status === 'active';
      const isCompleted = status === 'completed';
      const isDisabled = status === 'disabled';

      const textWrapperClass =
        orientation === 'horizontal'
          ? 'mt-2 block text-center sm:mt-0 sm:text-left'
          : 'block';

      const stepId = `${stepperId}-step-${stepNumber}`;

      return (
        <div
          class={cn(
            'stepper-step relative flex',
            orientation === 'horizontal'
              ? 'flex-1 items-start'
              : `items-start ${!isLast ? sizeClasses[size].padding : ''}`,
            interactive && !isDisabled && 'interactive cursor-pointer'
          )}
          role={Element === 'ol' ? 'listitem' : undefined}
        >
          <div class={cn('flex items-start', sizeClasses[size].gap)}>
            <div
              class={cn(
                baseCircleClasses,
                getCircleClasses(status),
                'stepper-circle'
              )}
              aria-current={isActive ? 'step' : undefined}
              aria-describedby={step.description ? `${stepId}-desc` : undefined}
              tabindex={interactive && !isDisabled ? 0 : -1}
              role={interactive ? 'button' : undefined}
              aria-label={
                interactive
                  ? `Go to step ${stepNumber}: ${step.label}`
                  : undefined
              }
              id={stepId}
            >
              {step.icon ? (
                <span aria-hidden="true">{step.icon}</span>
              ) : isCompleted ? (
                <span aria-hidden="true">âœ“</span>
              ) : (
                <span>{stepNumber}</span>
              )}
            </div>

            <div class={textWrapperClass}>
              <p class={getLabelClasses(status)} id={`${stepId}-label`}>
                {step.label}
              </p>
              {step.description && (
                <p class={getDescriptionClasses(status)} id={`${stepId}-desc`}>
                  {step.description}
                </p>
              )}
            </div>
          </div>

          {!isLast &&
            (orientation === 'horizontal' ? (
              <div
                class={cn(
                  'stepper-connector hidden flex-1 self-center sm:mx-4 sm:block',
                  getConnectorClasses(status)
                )}
                aria-hidden="true"
              />
            ) : (
              <div
                class={cn(
                  'stepper-connector absolute top-12 bottom-0',
                  size === 'sm'
                    ? 'left-4'
                    : size === 'md'
                      ? 'left-5'
                      : 'left-6',
                  getConnectorClasses(status, true)
                )}
                aria-hidden="true"
              />
            ))}
        </div>
      );
    })
  }
</Element>
