---
/**
 * WikiSummary - Wikipedia Artikel-Zusammenfassung
 *
 * Zeigt eine Zusammenfassung eines Wikipedia-Artikels mit Bild.
 *
 * API: https://en.wikipedia.org/api/rest_v1/
 */
import { cn } from '../utils/cn';

interface WikiArticle {
  title: string;
  displaytitle: string;
  description?: string;
  extract: string;
  extract_html?: string;
  thumbnail?: { source: string; width: number; height: number };
  originalimage?: { source: string; width: number; height: number };
  content_urls: {
    desktop: { page: string };
    mobile: { page: string };
  };
  pageid: number;
  lang: string;
  timestamp?: string;
}

interface Props {
  article: string; // Article title or URL
  lang?: string;
  variant?: 'default' | 'compact' | 'card';
  showImage?: boolean;
  showDescription?: boolean;
  maxLength?: number;
  className?: string;
}

const {
  article,
  lang = 'de',
  variant = 'default',
  showImage = true,
  showDescription = true,
  maxLength = 300,
  className = '',
} = Astro.props;

let data: WikiArticle | null = null;
let error: string | null = null;

// Extract article title from URL if needed
const title = article.includes('wikipedia.org')
  ? article.split('/wiki/').pop()?.replace(/_/g, ' ') || article
  : article;

try {
  const res = await fetch(
    `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`
  );
  if (res.ok) {
    data = await res.json();
  } else {
    error = 'Artikel nicht gefunden';
  }
} catch {
  error = 'Verbindungsfehler';
}

function truncate(text: string, len: number): string {
  if (text.length <= len) return text;
  return text.slice(0, len).trim() + '…';
}

// Strip HTML tags utility
// const _stripHtml = (html: string): string => {
//   return html.replace(/<[^>]*>/g, '');
// };
---

{
  error ? (
    <div
      class={cn(
        'p-4 rounded-xl bg-red-950/50 border border-red-500/30 text-red-300 text-sm',
        className
      )}
    >
      <div class="flex items-center gap-2">
        <svg
          class="w-5 h-5 shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        {error}: {title}
      </div>
    </div>
  ) : data && variant === 'compact' ? (
    <a
      href={data.content_urls.desktop.page}
      target="_blank"
      rel="noopener"
      class={cn(
        'flex items-center gap-4 p-4 rounded-xl bg-slate-800/50 border border-slate-700/50 hover:border-slate-600/50 transition-colors',
        className
      )}
    >
      {showImage && data.thumbnail && (
        <img
          src={data.thumbnail.source}
          alt=""
          class="w-12 h-12 rounded-lg object-cover shrink-0 bg-slate-700"
        />
      )}
      <div class="flex-1 min-w-0">
        <h3 class="font-bold text-slate-100">{data.title}</h3>
        {showDescription && data.description && (
          <p class="text-sm text-slate-400 truncate">{data.description}</p>
        )}
      </div>
      <div class="shrink-0">
        <span class="px-2 py-1 rounded text-xs bg-slate-700/50 text-slate-400">
          W
        </span>
      </div>
    </a>
  ) : data && variant === 'card' ? (
    <a
      href={data.content_urls.desktop.page}
      target="_blank"
      rel="noopener"
      class={cn(
        'block rounded-xl overflow-hidden bg-slate-800/50 border border-slate-700/50 hover:border-slate-600/50 transition-colors',
        className
      )}
    >
      {showImage && data.thumbnail && (
        <div class="aspect-video bg-slate-700 overflow-hidden">
          <img
            src={data.originalimage?.source || data.thumbnail.source}
            alt=""
            class="w-full h-full object-cover"
          />
        </div>
      )}
      <div class="p-4">
        <h3 class="font-bold text-slate-100 text-lg mb-1">{data.title}</h3>
        {showDescription && data.description && (
          <p class="text-sm text-slate-500 mb-2">{data.description}</p>
        )}
        <p class="text-sm text-slate-300 line-clamp-3">
          {truncate(data.extract, maxLength)}
        </p>
      </div>
    </a>
  ) : (
    data && (
      <div
        class={cn(
          'rounded-2xl bg-gradient-to-br from-slate-800/90 to-slate-900/90 border border-slate-700/50 overflow-hidden',
          className
        )}
      >
        <header class="px-5 py-4 border-b border-slate-700/50 bg-slate-700/20">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="p-2.5 rounded-xl bg-gradient-to-br from-slate-600 to-slate-700 shadow-lg">
                <svg
                  class="w-5 h-5 text-white"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.562 14.255l-.393-.167c-.477-.202-.86-.448-1.148-.737-.288-.289-.548-.68-.78-1.173l-1.36-2.896c-.09-.19-.247-.328-.47-.415-.224-.087-.525-.13-.904-.13v-2.04c.38 0 .68-.044.904-.13.223-.087.38-.225.47-.415l1.36-2.896c.232-.493.492-.884.78-1.173.288-.289.67-.535 1.148-.737l.393-.167-.248-.572c-.14.065-.288.125-.445.18-.157.055-.307.118-.45.188-.477.234-.9.527-1.268.88-.368.352-.68.773-.935 1.263L12.46 8.54c-.115.246-.33.44-.645.58-.316.14-.728.21-1.237.21h-.313v2.04h.313c.51 0 .92.07 1.237.21.315.14.53.334.645.58l.726 1.543c.255.49.567.91.935 1.263.368.353.79.646 1.268.88.143.07.293.133.45.188.157.055.305.115.445.18l.248-.572z" />
                </svg>
              </div>
              <div>
                <h3 class="font-bold text-slate-100 text-lg">{data.title}</h3>
                {showDescription && data.description && (
                  <p class="text-xs text-slate-400">{data.description}</p>
                )}
              </div>
            </div>

            <span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-slate-700/50 text-slate-300 border border-slate-600/50 uppercase">
              {data.lang}
            </span>
          </div>
        </header>

        <div class="p-5">
          <div class={cn('flex gap-5', !showImage && 'block')}>
            {/* Image */}
            {showImage && data.thumbnail && (
              <div class="shrink-0">
                <img
                  src={data.thumbnail.source}
                  alt=""
                  class="w-32 h-32 rounded-xl object-cover bg-slate-700 shadow-lg"
                />
              </div>
            )}

            {/* Extract */}
            <div class="flex-1 min-w-0">
              <p class="text-slate-300 leading-relaxed">
                {truncate(data.extract, maxLength)}
              </p>
            </div>
          </div>
        </div>

        <footer class="px-5 py-3 border-t border-slate-700/50 bg-slate-800/30 flex items-center justify-between">
          <span class="text-xs text-slate-500">Wikipedia</span>
          <a
            href={data.content_urls.desktop.page}
            target="_blank"
            rel="noopener"
            class="text-sm text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-1"
          >
            Vollständiger Artikel
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              />
            </svg>
          </a>
        </footer>
      </div>
    )
  )
}
