---
/**
 * Carousel - image/content carousel with controls and autoplay support
 */
interface Slide {
  id?: string;
  image?: string;
  alt?: string;
  title?: string;
  description?: string;
}

interface Props {
  slides: Slide[];
  autoplay?: boolean;
  interval?: number;
  loop?: boolean;
  showIndicators?: boolean;
  showControls?: boolean;
  showPauseControl?: boolean; // show pause/resume button (independent of nav controls)
  className?: string;
  ariaLabel?: string; // Accessible label for carousel region
  // Custom slide label generator. Signature: (index: number, length: number, slide: Slide) => string
  slideLabelFormat?: any;
  pauseLabel?: string; // Label for pause/resume button
}

const {
  slides = [],
  autoplay = false,
  interval = 5000,
  loop = true,
  showIndicators = true,
  showControls = true,
  showPauseControl = true,
  className = '',
  ariaLabel = 'Featured content carousel',
  slideLabelFormat,
  pauseLabel = 'Pause autoplay',
} = Astro.props as Props;

const id = `carousel-${Math.random().toString(36).slice(2, 10)}`;
---

{
  slides.length === 0 ? (
    <div
      class={`rounded-xl border border-slate-200 bg-white p-6 text-center text-slate-600 shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300 ${className}`}
    >
      No slides configured.
    </div>
  ) : (
    <div
      id={id}
      data-carousel-id={id}
      class={`relative overflow-hidden rounded-xl border border-slate-200 bg-(--carousel-bg,white) text-(--carousel-fg,#0f172a) shadow-sm dark:border-slate-800 dark:bg-(--carousel-bg-dark,#020617) dark:text-(--carousel-fg-dark,#f8fafc) ${className}`}
      data-carousel-root
      data-slide-count={slides.length}
      data-autoplay={autoplay}
      data-interval={interval}
      data-loop={loop}
      role="region"
      aria-label={ariaLabel}
      aria-roledescription="carousel"
      aria-live="polite"
    >
      <div class="relative">
        <div
          class="flex transition-transform duration-500 ease-out motion-reduce:transition-none"
          data-carousel-track
        >
          {slides.map((slide, index) => (
            <div
              class="min-w-full shrink-0"
              role="group"
              aria-roledescription="slide"
              aria-label={
                slideLabelFormat
                  ? slideLabelFormat(index, slides.length, slide)
                  : `Slide ${index + 1} of ${slides.length}`
              }
              id={`${id}-slide-${index}`}
            >
              <div class="relative h-full">
                {slide.image ? (
                  <img
                    src={slide.image}
                    alt={slide.alt || slide.title || `Slide ${index + 1}`}
                    class="h-64 sm:h-72 md:h-96 w-full object-cover"
                    loading={index === 0 ? 'eager' : 'lazy'}
                  />
                ) : (
                  <div class="flex h-64 sm:h-72 md:h-96 items-center justify-center bg-slate-100 text-slate-500 dark:bg-slate-900">
                    No image provided
                  </div>
                )}
                {(slide.title || slide.description) && (
                  <div class="absolute inset-x-0 bottom-0 bg-linear-to-t from-black/80 via-black/40 to-transparent p-4 sm:p-6 text-white">
                    {slide.title && (
                      <h3 class="text-lg sm:text-xl font-semibold leading-tight">
                        {slide.title}
                      </h3>
                    )}
                    {slide.description && (
                      <p class="mt-1 sm:mt-2 text-sm text-white/85 leading-relaxed">
                        {slide.description}
                      </p>
                    )}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>

        {showControls && (
          <>
            <button
              type="button"
              class="absolute left-2 sm:left-4 top-1/2 flex -translate-y-1/2 items-center justify-center rounded-full border border-slate-200 bg-white/90 p-2 sm:p-3 text-slate-900 shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 dark:border-slate-700 dark:bg-slate-900/90 dark:text-white"
              data-carousel-prev
              aria-label="Previous slide"
            >
              <span aria-hidden="true" class="text-lg sm:text-xl">
                ‹
              </span>
            </button>
            <button
              type="button"
              class="absolute right-2 sm:right-4 top-1/2 flex -translate-y-1/2 items-center justify-center rounded-full border border-slate-200 bg-white/90 p-2 sm:p-3 text-slate-900 shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 dark:border-slate-700 dark:bg-slate-900/90 dark:text-white"
              data-carousel-next
              aria-label="Next slide"
            >
              <span aria-hidden="true" class="text-lg sm:text-xl">
                ›
              </span>
            </button>
          </>
        )}
      </div>

      {showIndicators && (
        <div
          class="absolute bottom-4 left-1/2 flex -translate-x-1/2 gap-2 sm:gap-3"
          data-carousel-indicators
          role="tablist"
          aria-label="Carousel slides"
        >
          {slides.map((_slide, index) => (
            <button
              type="button"
              class="h-2 w-2 sm:h-2.5 sm:w-2.5 rounded-full border border-slate-300 bg-slate-400/60 transition-all duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 hover:bg-slate-400/80 dark:border-slate-600 dark:bg-slate-600/70 dark:hover:bg-slate-600/90"
              data-carousel-indicator={index}
              aria-label={`Go to slide ${index + 1}`}
              role="tab"
              aria-controls={`${id}-slide-${index}`}
            />
          ))}
        </div>
      )}
      {autoplay && showPauseControl && (
        <button
          type="button"
          class="absolute bottom-2 sm:bottom-4 right-2 sm:right-4 rounded-md border border-slate-200 bg-white/80 px-2 py-1 sm:px-3 sm:py-2 text-xs font-medium text-slate-900 shadow-sm backdrop-blur transition hover:bg-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100"
          data-carousel-pause
          aria-pressed="false"
          aria-label={pauseLabel}
        >
          Pause
        </button>
      )}
    </div>
  )
}

<script is:inline>
  document.addEventListener('DOMContentLoaded', function () {
    const carousels = document.querySelectorAll('[data-carousel-root]');

    carousels.forEach(function (root) {
      if (root.dataset.initialized === 'true') return;
      root.dataset.initialized = 'true';

      const track = root.querySelector('[data-carousel-track]');
      if (!track) {
        console.warn('[Carousel] Track not found');
        return;
      }

      const slideCount = parseInt(root.dataset.slideCount || '0', 10);
      if (slideCount <= 0) {
        console.warn('[Carousel] No slides found');
        return;
      }

      const shouldAutoplay =
        root.dataset.autoplay === 'true' &&
        !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const loop = root.dataset.loop === 'true';
      const interval = parseInt(root.dataset.interval || '5000', 10);

      const indicators = Array.from(
        root.querySelectorAll('[data-carousel-indicator]')
      );
      const prevButton = root.querySelector('[data-carousel-prev]');
      const nextButton = root.querySelector('[data-carousel-next]');

      let currentIndex = 0;
      let timer = null;
      let paused = false;
      root.dataset.currentIndex = String(currentIndex);

      function update() {
        track.style.transform = 'translateX(-' + currentIndex * 100 + '%)';
        indicators.forEach(function (indicator, index) {
          const isActive = index === currentIndex;
          indicator.style.opacity = isActive ? '1' : '0.45';
          indicator.dataset.active = isActive ? 'true' : 'false';
          indicator.setAttribute('aria-selected', isActive ? 'true' : 'false');
          indicator.setAttribute('tabindex', isActive ? '0' : '-1');
        });
      }

      function goTo(index) {
        if (index < 0) {
          currentIndex = loop ? (slideCount + index) % slideCount : 0;
        } else if (index >= slideCount) {
          currentIndex = loop ? index % slideCount : slideCount - 1;
        } else {
          currentIndex = index;
        }
        root.dataset.currentIndex = String(currentIndex);
        update();
      }

      function next() {
        goTo(currentIndex + 1);
      }
      function prev() {
        goTo(currentIndex - 1);
      }

      // Attach event listeners
      if (prevButton) {
        prevButton.addEventListener('click', function () {
          console.log('[Carousel] Prev clicked');
          prev();
        });
      }
      if (nextButton) {
        nextButton.addEventListener('click', function () {
          console.log('[Carousel] Next clicked');
          next();
        });
      }

      indicators.forEach(function (indicator, index) {
        indicator.addEventListener('click', function () {
          console.log('[Carousel] Indicator clicked:', index);
          goTo(index);
        });
      });

      const pauseButton = root.querySelector('[data-carousel-pause]');

      if (shouldAutoplay) {
        function stop() {
          if (timer) {
            clearInterval(timer);
            timer = null;
          }
        }
        function start() {
          stop();
          if (!paused) {
            timer = setInterval(next, interval);
          }
        }

        root.addEventListener('mouseenter', stop);
        root.addEventListener('mouseleave', start);

        if (pauseButton) {
          pauseButton.addEventListener('click', function () {
            paused = !paused;
            pauseButton.setAttribute('aria-pressed', String(paused));
            pauseButton.textContent = paused ? 'Resume' : 'Pause';
            pauseButton.setAttribute(
              'aria-label',
              paused ? 'Resume autoplay' : 'Pause autoplay'
            );
            if (paused) {
              stop();
            } else {
              start();
            }
          });
        }
        start();
      }

      update();
      console.log(
        '[Carousel] Initialized successfully with',
        slideCount,
        'slides'
      );
    });
  });
</script>
