---
/**
 * FilterChips - accessible selectable chip list with WCAG AAA compliance
 */
interface Chip {
  id: string;
  label: string;
  href?: string;
  count?: number;
  disabled?: boolean;
}

interface Props {
  items: Chip[];
  selected?: string[];
  multi?: boolean;
  className?: string;
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'outlined' | 'subtle';
  ariaLabel?: string;
  ariaDescribedby?: string;
}

const {
  items = [],
  selected = [],
  multi = true,
  className = '',
  size = 'md',
  variant = 'default',
  ariaLabel,
  ariaDescribedby,
} = Astro.props as Props;

const sizeClasses = {
  sm: 'px-3 py-1 text-xs',
  md: 'px-4 py-2 text-sm',
  lg: 'px-5 py-3 text-base',
};

const variantClasses = {
  default: {
    active: [
      'bg-blue-600',
      'text-white',
      'border-blue-600/90',
      'shadow-lg',
      'dark:bg-blue-500',
      'dark:border-blue-500/90',
    ],
    inactive: [
      'bg-white',
      'text-slate-800',
      'border-slate-300/90',
      'hover:bg-slate-50',
      'hover:border-slate-400',
      'dark:bg-slate-800',
      'dark:text-slate-200',
      'dark:border-slate-600/90',
      'dark:hover:bg-slate-700',
      'dark:hover:border-slate-500',
    ],
  },
  outlined: {
    active: [
      'bg-blue-50',
      'text-blue-800',
      'border-blue-600/90',
      'shadow-lg',
      'dark:bg-blue-500/20',
      'dark:text-blue-300',
      'dark:border-blue-400/90',
    ],
    inactive: [
      'bg-transparent',
      'text-slate-700',
      'border-slate-300/90',
      'hover:bg-slate-50',
      'hover:border-slate-400',
      'dark:text-slate-300',
      'dark:border-slate-600/90',
      'dark:hover:bg-slate-800',
      'dark:hover:border-slate-500',
    ],
  },
  subtle: {
    active: [
      'bg-slate-100',
      'text-slate-900',
      'border-slate-300/90',
      'shadow-lg',
      'dark:bg-slate-700',
      'dark:text-slate-100',
      'dark:border-slate-600/90',
    ],
    inactive: [
      'bg-slate-50',
      'text-slate-700',
      'border-slate-200/90',
      'hover:bg-slate-100',
      'hover:border-slate-300',
      'dark:bg-slate-800',
      'dark:text-slate-300',
      'dark:border-slate-700/90',
      'dark:hover:bg-slate-700',
      'dark:hover:border-slate-600',
    ],
  },
};

const activeClasses = variantClasses[variant].active;
const inactiveClasses = variantClasses[variant].inactive;
---

<div
  class={`flex flex-wrap gap-3 ${className}`.trim()}
  data-multi={multi}
  data-selected={selected.join(',')}
  data-active-classes={activeClasses.join(' ')}
  data-inactive-classes={inactiveClasses.join(' ')}
  role={multi ? 'group' : 'radiogroup'}
  aria-label={ariaLabel || (multi ? 'Filter options' : 'Select option')}
  aria-describedby={ariaDescribedby}
>
  {
    items.map((chip) => {
      const isActive = selected.includes(chip.id);
      const isDisabled = chip.disabled || false;
      return (
        <button
          type="button"
          data-id={chip.id}
          role={multi ? 'checkbox' : 'radio'}
          aria-checked={isActive}
          aria-disabled={isDisabled}
          disabled={isDisabled}
          class:list={[
            'inline-flex items-center gap-2 rounded-full border-2 font-semibold transition-colors duration-200 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-blue-400 dark:focus-visible:ring-offset-slate-800',
            sizeClasses[size],
            ...(isActive ? activeClasses : inactiveClasses),
            isDisabled && 'opacity-50 cursor-not-allowed pointer-events-none',
          ]}
        >
          <span>{chip.label}</span>
          {chip.count !== undefined && (
            <span class="ml-1 rounded-full bg-current/20 px-2 py-0.5 text-xs font-medium">
              {chip.count}
            </span>
          )}
        </button>
      );
    })
  }
</div>

<script is:inline>
  (function () {
    const root = document.currentScript?.previousElementSibling;
    if (!(root instanceof HTMLElement)) return;
    const multi = root.getAttribute('data-multi') === 'true';
    const activeClasses = (root.getAttribute('data-active-classes') || '')
      .split(' ')
      .filter(Boolean);
    const inactiveClasses = (root.getAttribute('data-inactive-classes') || '')
      .split(' ')
      .filter(Boolean);

    const getSelected = () =>
      new Set(
        (root.getAttribute('data-selected') || '').split(',').filter(Boolean)
      );
    const setSelected = (ids) => {
      root.setAttribute('data-selected', Array.from(ids).join(','));
      root.dispatchEvent(
        new CustomEvent('change', { detail: { selected: Array.from(ids) } })
      );
    };

    const applyStyles = (selectedSet) => {
      root.querySelectorAll('button[data-id]').forEach((el) => {
        if (!(el instanceof HTMLElement)) return;
        const id = el.getAttribute('data-id');
        const isActive = id ? selectedSet.has(id) : false;
        el.setAttribute('aria-checked', isActive ? 'true' : 'false');
        el.classList.remove(...activeClasses, ...inactiveClasses);
        el.classList.add(...(isActive ? activeClasses : inactiveClasses));
      });
    };

    applyStyles(getSelected());

    root.addEventListener('click', (event) => {
      const button =
        event.target instanceof HTMLElement
          ? event.target.closest('button[data-id]')
          : null;
      if (!(button instanceof HTMLElement)) return;
      if (button.disabled || button.getAttribute('aria-disabled') === 'true') return;
      
      const id = button.getAttribute('data-id');
      if (!id) return;

      const selectedSet = getSelected();
      if (multi) {
        if (selectedSet.has(id)) {
          selectedSet.delete(id);
        } else {
          selectedSet.add(id);
        }
      } else {
        selectedSet.clear();
        selectedSet.add(id);
      }

      setSelected(selectedSet);
      applyStyles(selectedSet);
    });

    // Keyboard navigation
    root.addEventListener('keydown', (event) => {
      if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(event.key)) return;
      
      const buttons = Array.from(root.querySelectorAll('button[data-id]:not([disabled])'));
      const currentIndex = buttons.findIndex(btn => btn === document.activeElement);
      
      if (currentIndex === -1) return;
      
      event.preventDefault();
      
      let nextIndex;
      switch (event.key) {
        case 'ArrowLeft':
          nextIndex = currentIndex > 0 ? currentIndex - 1 : buttons.length - 1;
          break;
        case 'ArrowRight':
          nextIndex = currentIndex < buttons.length - 1 ? currentIndex + 1 : 0;
          break;
        case 'Home':
          nextIndex = 0;
          break;
        case 'End':
          nextIndex = buttons.length - 1;
          break;
        default:
          return;
      }
      
      if (buttons[nextIndex] instanceof HTMLElement) {
        buttons[nextIndex].focus();
      }
    });
  })();
</script>
