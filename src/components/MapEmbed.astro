---
import EmbedBase from './EmbedBase.astro';

/**
 * MapEmbed - WCAG AAA compliant map embed
 * Provides accessible map integration with proper loading states and error handling
 */
interface Props {
  /** Street address to display */
  address?: string;
  /** Exact coordinates */
  coordinates?: { lat: number; lng: number };
  /** Map provider */
  provider?: 'openstreetmap' | 'google' | 'mapbox';
  /** Visual theme variant */
  variant?: 'default' | 'minimal' | 'card';
  /** Show loading state */
  showLoading?: boolean;
  /** Accessible title for screen readers */
  title?: string;
  /** CSS class for styling */
  class?: string;
  /** ARIA label for accessibility */
  ariaLabel?: string;
  /** Additional iframe attributes */
  [key: string]: any;
}

const {
  address,
  coordinates,
  provider = 'openstreetmap',
  variant = 'default',
  showLoading = true,
  title,
  class: className = '',
  ariaLabel,
  ...props
} = Astro.props;

// Validate that either address or coordinates are provided
if (!address && !coordinates) {
  throw new Error('MapEmbed: Either address or coordinates must be provided');
}

// Build map embed URL based on provider
const buildMapEmbedUrl = (): string => {
  let lat: number;
  let lng: number;
  
  if (coordinates) {
    lat = coordinates.lat;
    lng = coordinates.lng;
  } else if (address) {
    // For simplicity, we'll use OpenStreetMap's approach which handles address encoding
    return `https://www.openstreetmap.org/export/embed.html?bbox=${encodeURIComponent(address)}&layer=mapnik`;
  } else {
    throw new Error('Invalid map configuration');
  }
  
  switch (provider) {
    case 'openstreetmap': {
      // Calculate bbox for OpenStreetMap embed
      const offset = 0.01; // Adjust based on zoom level
      const bbox = `${lng - offset},${lat - offset},${lng + offset},${lat + offset}`;
      return `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lng}`;
    }
      
    case 'google':
      return `https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d1000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sen!2s!4v1`;
      
    case 'mapbox':
      // Mapbox embed would require API key, so we'll fallback to OpenStreetMap
      return `https://www.openstreetmap.org/export/embed.html?bbox=${lng - 0.01},${lat - 0.01},${lng + 0.01},${lat + 0.01}&layer=mapnik&marker=${lat},${lng}`;
      
    default:
      return `https://www.openstreetmap.org/export/embed.html?bbox=${lng - 0.01},${lat - 0.01},${lng + 0.01},${lat + 0.01}&layer=mapnik&marker=${lat},${lng}`;
  }
};

const embedUrl = buildMapEmbedUrl();

// Generate location description for accessibility
const getLocationDescription = (): string => {
  if (coordinates) {
    return `${coordinates.lat}, ${coordinates.lng}`;
  }
  if (address) {
    return address;
  }
  return 'Map location';
};

const locationDescription = getLocationDescription();

// Generate appropriate title and ARIA label
const finalTitle = title || `Map showing ${locationDescription}`;
const finalAriaLabel = ariaLabel || `Interactive map displaying ${locationDescription}`;
---

<EmbedBase
  src={embedUrl}
  title={finalTitle}
  aspectRatio="16/9"
  variant={variant}
  showLoading={showLoading}
  class={className}
  ariaLabel={finalAriaLabel}
  allowFullscreen={false}
  loading="lazy"
  referrerPolicy="no-referrer-when-downgrade"
  {...props}
/>