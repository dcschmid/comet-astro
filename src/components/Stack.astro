---
import { cn } from '../utils/cn';

/**
 * Stack - WCAG AAA compliant flexbox layout component
 * Provides semantic and accessible layout arrangements with responsive spacing
 */
interface Props {
  /** Layout direction */
  direction?: 'vertical' | 'horizontal';
  /** Spacing between items */
  gap?: 'none' | 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl' | '4xl';
  /** Cross-axis alignment */
  align?: 'start' | 'center' | 'end' | 'stretch' | 'baseline';
  /** Main-axis alignment */
  justify?: 'start' | 'center' | 'end' | 'between' | 'around' | 'evenly';
  /** Allow flex wrapping */
  wrap?: boolean;
  /** Responsive gap variations */
  responsive?: {
    sm?: 'none' | 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl' | '4xl';
    md?: 'none' | 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl' | '4xl';
    lg?: 'none' | 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl' | '4xl';
    xl?: 'none' | 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl' | '4xl';
  };
  /** Semantic HTML element */
  as?:
    | 'div'
    | 'section'
    | 'article'
    | 'nav'
    | 'ul'
    | 'ol'
    | 'header'
    | 'footer'
    | 'main'
    | 'aside';
  /** Accessibility role */
  role?: string;
  /** ARIA label for screen readers */
  ariaLabel?: string;
  /** ARIA labelledby reference */
  ariaLabelledby?: string;
  /** Debug mode to visualize layout */
  debug?: boolean;
  /** Additional CSS classes */
  class?: string;
}

const {
  direction = 'vertical',
  gap = 'md',
  align = 'stretch',
  justify = 'start',
  wrap = false,
  responsive,
  as: Element = 'div',
  role,
  ariaLabel,
  ariaLabelledby,
  debug = false,
  class: className = '',
} = Astro.props as Props;

// Direction classes
const directionClasses = {
  vertical: 'flex-col',
  horizontal: 'flex-row',
};

// Gap classes with proper spacing scale
const gapClasses = {
  none: 'gap-0',
  xs: 'gap-1', // 4px
  sm: 'gap-2', // 8px
  md: 'gap-4', // 16px
  lg: 'gap-6', // 24px
  xl: 'gap-8', // 32px
  '2xl': 'gap-12', // 48px
  '3xl': 'gap-16', // 64px
  '4xl': 'gap-20', // 80px
};

// Alignment classes
const alignClasses = {
  start: 'items-start',
  center: 'items-center',
  end: 'items-end',
  stretch: 'items-stretch',
  baseline: 'items-baseline',
};

// Justify classes
const justifyClasses = {
  start: 'justify-start',
  center: 'justify-center',
  end: 'justify-end',
  between: 'justify-between',
  around: 'justify-around',
  evenly: 'justify-evenly',
};

// Responsive gap classes
const responsiveGapClasses = responsive
  ? Object.entries(responsive)
      .map(([breakpoint, responsiveGap]) => {
        const prefix =
          breakpoint === 'sm'
            ? 'sm:'
            : breakpoint === 'md'
              ? 'md:'
              : breakpoint === 'lg'
                ? 'lg:'
                : 'xl:';
        return `${prefix}${gapClasses[responsiveGap].replace('gap-', 'gap-')}`;
      })
      .join(' ')
  : '';

// Main container classes
const stackClasses = cn(
  // Base flex layout
  'flex',
  // Direction
  directionClasses[direction],
  // Gap
  gapClasses[gap],
  // Responsive gaps
  responsiveGapClasses,
  // Alignment
  alignClasses[align],
  // Justify
  justifyClasses[justify],
  // Wrap
  wrap && 'flex-wrap',
  // Debug mode
  debug && 'debug-stack',
  // Custom classes
  className
);
---

<style>
  .debug-stack {
    /* Debug visualization */
    outline: 2px dashed rgba(255, 0, 255, 0.5);
    outline-offset: 2px;
    background: repeating-linear-gradient(
      45deg,
      rgba(255, 0, 255, 0.05),
      rgba(255, 0, 255, 0.05) 4px,
      transparent 4px,
      transparent 8px
    );
    position: relative;
  }

  .debug-stack::before {
    content: 'Stack: ' attr(data-debug-info);
    position: absolute;
    top: -1.5rem;
    left: 0;
    background: rgba(255, 0, 255, 0.9);
    color: white;
    padding: 2px 6px;
    font-size: 10px;
    font-family: monospace;
    border-radius: 2px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 1000;
  }

  /* Dark mode debug styles */
  @media (prefers-color-scheme: dark) {
    .debug-stack {
      outline-color: rgba(255, 255, 0, 0.6);
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 0, 0.05),
        rgba(255, 255, 0, 0.05) 4px,
        transparent 4px,
        transparent 8px
      );
    }

    .debug-stack::before {
      background: rgba(255, 255, 0, 0.9);
      color: black;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .debug-stack {
      outline-width: 3px !important;
    }

    .debug-stack::before {
      font-weight: bold !important;
    }
  }

  /* Divider enhanced accessibility */
  .stack-divider {
    /* Ensure minimum contrast */
    background-color: currentColor;
    opacity: 0.2;
  }

  @media (prefers-contrast: high) {
    .stack-divider {
      opacity: 0.6 !important;
    }
  }

  /* Focus management for interactive stacks */
  .stack-interactive:focus-within {
    outline: 2px solid transparent;
    box-shadow: 0 0 0 2px rgb(59 130 246 / 0.5);
  }

  @media (prefers-color-scheme: dark) {
    .stack-interactive:focus-within {
      box-shadow: 0 0 0 2px rgb(96 165 250 / 0.5);
    }
  }
</style>

<Element
  class={stackClasses}
  role={role}
  aria-label={ariaLabel}
  aria-labelledby={ariaLabelledby}
  data-direction={direction}
  data-gap={gap}
  data-debug-info={debug
    ? `${direction} ${gap} ${align} ${justify}`
    : undefined}
>
  <slot />
</Element>
