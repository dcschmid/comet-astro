---
/**
 * WeatherBase - Comprehensive weather component with Open-Meteo API integration
 *
 * Provides unified weather data display with full accessibility compliance,
 * responsive design, and modern Tailwind 4 styling.
 *
 * Features:
 * - WCAG AAA accessibility compliance (4.5:1 contrast minimum)
 * - Tailwind 4 styling with CSS custom properties
 * - Responsive design for all screen sizes
 * - Multiple weather data types and forecasting
 * - Automatic location detection with fallback
 * - Advanced error handling and loading states
 * - Internationalization support
 * - Real-time updates with configurable intervals
 */

interface Props {
  /**
   * Latitude coordinate (-90 to 90)
   * Auto-detected via geolocation if not provided
   */
  latitude?: number;

  /**
   * Longitude coordinate (-180 to 180)
   * Auto-detected via geolocation if not provided
   */
  longitude?: number;

  /**
   * Display name for the location
   */
  location?: string;

  /**
   * Weather data type to display
   */
  variant?: 'current' | 'forecast' | 'detailed' | 'minimal' | 'dashboard';

  /**
   * Component size variant
   */
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';

  /**
   * Color theme variant
   */
  theme?: 'default' | 'blue' | 'green' | 'orange' | 'red' | 'purple';

  /**
   * Number of forecast days (1-16)
   */
  forecastDays?: number;

  /**
   * Temperature unit preference
   */
  temperatureUnit?: 'celsius' | 'fahrenheit';

  /**
   * Wind speed unit preference
   */
  windSpeedUnit?: 'kmh' | 'ms' | 'mph' | 'kn';

  /**
   * Precipitation unit preference
   */
  precipitationUnit?: 'mm' | 'inch';

  /**
   * Timezone (auto-detected if not specified)
   */
  timezone?: string;

  /**
   * Enable weather alerts display
   */
  showAlerts?: boolean;

  /**
   * Enable forecast display
   */
  showForecast?: boolean;

  /**
   * Enable detailed metrics display
   */
  showDetails?: boolean;

  /**
   * Auto-refresh interval in minutes (0 to disable)
   */
  refreshInterval?: number;

  /**
   * Additional CSS classes
   */
  class?: string;

  /**
   * ARIA label for screen readers
   */
  ariaLabel?: string;
}

const {
  latitude,
  longitude,
  location = 'Current Location',
  variant = 'current',
  size = 'md',
  theme = 'default',
  forecastDays = 7,
  temperatureUnit = 'celsius',
  windSpeedUnit = 'kmh',
  precipitationUnit = 'mm',
  timezone = 'auto',
  showAlerts = true,
  showForecast = true,
  showDetails = true,
  refreshInterval = 15,
  class: className = '',
  ariaLabel,
  ...rest
} = Astro.props;

// Tailwind 4 CSS classes based on props
const sizeClasses = {
  xs: 'text-xs p-2 rounded-md',
  sm: 'text-sm p-3 rounded-lg',
  md: 'text-base p-4 rounded-lg',
  lg: 'text-lg p-6 rounded-xl',
  xl: 'text-xl p-8 rounded-2xl',
};

const themeClasses = {
  default: 'weather-card weather-card--default',
  blue: 'weather-card weather-card--blue',
  green: 'weather-card weather-card--green',
  orange: 'weather-card weather-card--orange',
  red: 'weather-card weather-card--red',
  purple: 'weather-card weather-card--purple',
};

// Generate API URL based on parameters
function buildApiUrl() {
  const baseUrl = 'https://api.open-meteo.com/v1/forecast';
  const params = new URLSearchParams();

  if (latitude !== undefined && longitude !== undefined) {
    params.append('latitude', latitude.toString());
    params.append('longitude', longitude.toString());
  }

  params.append('temperature_unit', temperatureUnit);
  params.append('wind_speed_unit', windSpeedUnit);
  params.append('precipitation_unit', precipitationUnit);
  params.append('timezone', timezone);

  // Add parameters based on variant
  if (variant === 'current') {
    params.append(
      'current',
      'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m'
    );
  } else if (variant === 'forecast') {
    params.append(
      'daily',
      'weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,daylight_duration,sunshine_duration,uv_index_max,precipitation_sum,rain_sum,showers_sum,snowfall_sum,precipitation_hours,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant'
    );
    params.append('forecast_days', forecastDays.toString());
  } else if (variant === 'detailed') {
    params.append(
      'current',
      'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m'
    );
    params.append(
      'hourly',
      'temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,wind_gusts_10m'
    );
    params.append(
      'daily',
      'weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,daylight_duration,sunshine_duration,uv_index_max,precipitation_sum,rain_sum,showers_sum,snowfall_sum,precipitation_hours,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant'
    );
    params.append('forecast_days', forecastDays.toString());
  }

  return `${baseUrl}?${params.toString()}`;
}

const apiUrl = buildApiUrl();
---

<div
  class={`
    weather-base relative border transition-all duration-200 ease-in-out
    ${sizeClasses[size]}
    ${themeClasses[theme]}
    ${className}
  `}
  role="region"
  aria-label={ariaLabel || `Weather information for ${location}`}
  data-weather-component
  data-variant={variant}
  data-size={size}
  data-theme={theme}
  data-api-url={apiUrl}
  data-coordinates={latitude && longitude ? `${latitude},${longitude}` : ''}
  data-show-alerts={showAlerts}
  data-show-forecast={showForecast}
  data-show-details={showDetails}
  data-refresh-interval={refreshInterval}
  {...rest}
>
  <!-- Loading State -->
  <div
    class="flex items-center justify-center gap-3 weather-loading"
    aria-live="polite"
    aria-label="Loading weather data"
  >
    <div
      class="w-6 h-6 border-2 border-current opacity-30 border-t-current rounded-full animate-spin"
      aria-hidden="true"
    >
    </div>
    <span class="font-medium"> Loading weather data... </span>
  </div>

  <!-- Error State -->
  <div class="text-center space-y-4 weather-error hidden" role="alert">
    <div class="text-4xl" aria-hidden="true">‚ö†Ô∏è</div>
    <div class="space-y-2">
      <h3 class="text-lg font-semibold">Weather data unavailable</h3>
      <p class="text-sm error-message"></p>
      <button
        class="retry-button px-4 py-2 font-semibold rounded-lg
          transition-colors duration-200 focus:outline-none"
        onclick="this.closest('.weather-base').weatherBase.init()"
        type="button"
        aria-label="Retry loading weather data"
      >
        Try Again
      </button>
    </div>
  </div>

  <!-- Weather Content -->
  <div class="weather-content hidden">
    <slot>
      <!-- Default weather display when no slot content is provided -->
      <div class="weather-default-content">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-bold weather-location">{location}</h3>
            <p class="text-sm font-semibold weather-description">
              Loading weather data...
            </p>
          </div>
          <div class="text-center">
            <div class="text-3xl weather-icon" aria-hidden="true">‚òÄÔ∏è</div>
            <span class="text-xl font-black weather-temperature">--¬∞</span>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div class="weather-detail">
            <span class="weather-text-muted font-semibold">Feels like</span>
            <span class="weather-feels-like font-bold">--¬∞</span>
          </div>
          <div class="weather-detail">
            <span class="weather-text-muted font-semibold">Humidity</span>
            <span class="weather-humidity font-bold">--%</span>
          </div>
          <div class="weather-detail">
            <span class="weather-text-muted font-semibold">Wind</span>
            <span class="weather-wind font-bold">-- km/h</span>
          </div>
          <div class="weather-detail">
            <span class="weather-text-muted font-semibold">Pressure</span>
            <span class="weather-pressure font-bold">-- hPa</span>
          </div>
        </div>
      </div>
    </slot>
  </div>
</div>

<script>
  // Weather codes mapping (client-side)
  const WEATHER_CODES = {
    0: { description: 'Clear sky', icon: '‚òÄÔ∏è', severity: 'none' },
    1: { description: 'Mainly clear', icon: 'üå§Ô∏è', severity: 'none' },
    2: { description: 'Partly cloudy', icon: '‚õÖ', severity: 'none' },
    3: { description: 'Overcast', icon: '‚òÅÔ∏è', severity: 'none' },
    45: { description: 'Fog', icon: 'üå´Ô∏è', severity: 'low' },
    48: { description: 'Depositing rime fog', icon: 'üå´Ô∏è', severity: 'low' },
    51: { description: 'Light drizzle', icon: 'üå¶Ô∏è', severity: 'low' },
    53: { description: 'Moderate drizzle', icon: 'üå¶Ô∏è', severity: 'low' },
    55: { description: 'Dense drizzle', icon: 'üåßÔ∏è', severity: 'medium' },
    56: {
      description: 'Light freezing drizzle',
      icon: 'üåßÔ∏è',
      severity: 'medium',
    },
    57: { description: 'Dense freezing drizzle', icon: 'üåßÔ∏è', severity: 'high' },
    61: { description: 'Slight rain', icon: 'üåßÔ∏è', severity: 'low' },
    63: { description: 'Moderate rain', icon: 'üåßÔ∏è', severity: 'medium' },
    65: { description: 'Heavy rain', icon: 'üåßÔ∏è', severity: 'high' },
    66: { description: 'Light freezing rain', icon: 'üåßÔ∏è', severity: 'high' },
    67: { description: 'Heavy freezing rain', icon: 'üåßÔ∏è', severity: 'high' },
    71: { description: 'Slight snow fall', icon: 'üå®Ô∏è', severity: 'low' },
    73: { description: 'Moderate snow fall', icon: 'üå®Ô∏è', severity: 'medium' },
    75: { description: 'Heavy snow fall', icon: '‚ùÑÔ∏è', severity: 'high' },
    77: { description: 'Snow grains', icon: 'üå®Ô∏è', severity: 'medium' },
    80: { description: 'Slight rain showers', icon: 'üå¶Ô∏è', severity: 'low' },
    81: {
      description: 'Moderate rain showers',
      icon: 'üå¶Ô∏è',
      severity: 'medium',
    },
    82: { description: 'Violent rain showers', icon: '‚õàÔ∏è', severity: 'high' },
    85: { description: 'Slight snow showers', icon: 'üå®Ô∏è', severity: 'low' },
    86: { description: 'Heavy snow showers', icon: '‚ùÑÔ∏è', severity: 'high' },
    95: { description: 'Thunderstorm', icon: '‚õàÔ∏è', severity: 'high' },
    96: {
      description: 'Thunderstorm with slight hail',
      icon: '‚õàÔ∏è',
      severity: 'high',
    },
    99: {
      description: 'Thunderstorm with heavy hail',
      icon: '‚õàÔ∏è',
      severity: 'extreme',
    },
  };

  class WeatherBase {
    constructor(element) {
      this.element = element;
      this.apiUrl = element.dataset.apiUrl;
      this.coordinates = element.dataset.coordinates;
      this.showAlerts = element.dataset.showAlerts === 'true';
      this.showForecast = element.dataset.showForecast === 'true';
      this.showDetails = element.dataset.showDetails === 'true';
      this.refreshInterval = parseInt(element.dataset.refreshInterval || '0');
      this.loadingEl = element.querySelector('.weather-loading');
      this.errorEl = element.querySelector('.weather-error');
      this.contentEl = element.querySelector('.weather-content');
      this.retryButton = element.querySelector('.retry-button');

      this.init();
    }

    async init() {
      this.retryButton?.addEventListener('click', () =>
        this.fetchWeatherData()
      );

      // If no coordinates provided, try to get user location
      if (!this.coordinates) {
        await this.getUserLocation();
      }

      await this.fetchWeatherData();
    }

    async getUserLocation() {
      if ('geolocation' in navigator) {
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: 10000,
              maximumAge: 300000, // 5 minutes
            });
          });

          const { latitude, longitude } = position.coords;
          this.coordinates = `${latitude},${longitude}`;

          // Update API URL with coordinates
          const url = new URL(this.apiUrl, window.location.origin);
          url.searchParams.set('latitude', latitude.toString());
          url.searchParams.set('longitude', longitude.toString());
          this.apiUrl = url.toString();
        } catch (error) {
          console.warn('Could not get user location:', error);
          this.showError(
            'Location access denied. Please provide coordinates manually.'
          );
          return;
        }
      }
    }

    async fetchWeatherData() {
      if (
        !this.apiUrl ||
        (!this.coordinates && !this.apiUrl.includes('latitude='))
      ) {
        this.showError(
          'No location provided. Please enable location access or provide coordinates.'
        );
        return;
      }

      this.showLoading();

      try {
        const response = await fetch(this.apiUrl);

        if (!response.ok) {
          throw new Error(
            `Weather API error: ${response.status} ${response.statusText}`
          );
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(data.reason || 'Weather API error');
        }

        this.handleWeatherData(data);
        this.showContent();
      } catch (error) {
        console.error('Weather fetch error:', error);
        this.showError(
          error.message || 'Failed to fetch weather data. Please try again.'
        );
      }
    }

    handleWeatherData(data) {
      // Store weather data on element for child components
      this.element.weatherData = data;

      // Store configuration for child components
      this.element.weatherConfig = {
        showAlerts: this.showAlerts,
        showForecast: this.showForecast,
        showDetails: this.showDetails,
        refreshInterval: this.refreshInterval,
      };

      // Update default weather display if no custom slot content
      this.updateDefaultDisplay(data);

      // Dispatch custom event with weather data and configuration
      this.element.dispatchEvent(
        new CustomEvent('weatherDataLoaded', {
          detail: {
            data,
            weatherCodes: WEATHER_CODES,
            config: this.element.weatherConfig,
          },
          bubbles: true,
        })
      );

      // Set up auto-refresh if enabled
      if (this.refreshInterval > 0) {
        this.setupAutoRefresh();
      }
    }

    updateDefaultDisplay(data) {
      const defaultContent = this.element.querySelector(
        '.weather-default-content'
      );
      if (!defaultContent) return;

      // Update based on data variant
      if (data.current) {
        this.updateCurrentWeather(data.current, defaultContent);
      } else if (data.daily) {
        this.updateDailyWeather(data.daily, defaultContent);
      }
    }

    updateCurrentWeather(current, container) {
      const tempUnit = this.element.dataset.temperatureUnit || 'celsius';
      const windUnit = this.element.dataset.windSpeedUnit || 'kmh';

      // Update weather icon and description
      const weatherInfo = this.getWeatherInfo(current.weather_code);
      const iconEl = container.querySelector('.weather-icon');
      const descEl = container.querySelector('.weather-description');
      if (iconEl && descEl) {
        iconEl.textContent = weatherInfo.icon;
        descEl.textContent = weatherInfo.description;
      }

      // Update temperature
      const tempEl = container.querySelector('.weather-temperature');
      if (tempEl && current.temperature_2m != null) {
        tempEl.textContent = this.formatTemperature(
          current.temperature_2m,
          tempUnit
        );
      }

      // Update feels like temperature
      const feelsLikeEl = container.querySelector('.weather-feels-like');
      if (feelsLikeEl && current.apparent_temperature != null) {
        feelsLikeEl.textContent = this.formatTemperature(
          current.apparent_temperature,
          tempUnit
        );
      }

      // Update humidity
      const humidityEl = container.querySelector('.weather-humidity');
      if (humidityEl && current.relative_humidity_2m != null) {
        humidityEl.textContent = `${Math.round(current.relative_humidity_2m)}%`;
      }

      // Update wind
      const windEl = container.querySelector('.weather-wind');
      if (windEl && current.wind_speed_10m != null) {
        windEl.textContent = this.formatWindSpeed(
          current.wind_speed_10m,
          windUnit
        );
      }

      // Update pressure
      const pressureEl = container.querySelector('.weather-pressure');
      if (pressureEl && current.pressure_msl != null) {
        pressureEl.textContent = `${Math.round(current.pressure_msl)} hPa`;
      }
    }

    updateDailyWeather(daily, container) {
      if (!daily.time || daily.time.length === 0) return;

      const tempUnit = this.element.dataset.temperatureUnit || 'celsius';
      const todayIndex = 0;

      // Update weather icon and description
      if (daily.weather_code && daily.weather_code[todayIndex] != null) {
        const weatherInfo = this.getWeatherInfo(daily.weather_code[todayIndex]);
        const iconEl = container.querySelector('.weather-icon');
        const descEl = container.querySelector('.weather-description');
        if (iconEl && descEl) {
          iconEl.textContent = weatherInfo.icon;
          descEl.textContent = weatherInfo.description;
        }
      }

      // Update temperature (show high/low for daily)
      const tempEl = container.querySelector('.weather-temperature');
      if (tempEl && daily.temperature_2m_max && daily.temperature_2m_min) {
        const high = this.formatTemperature(
          daily.temperature_2m_max[todayIndex],
          tempUnit
        );
        const low = this.formatTemperature(
          daily.temperature_2m_min[todayIndex],
          tempUnit
        );
        tempEl.textContent = `${high}/${low}`;
      }

      // Hide irrelevant fields for daily view
      const feelsLikeEl = container.querySelector('.weather-feels-like');
      const windEl = container.querySelector('.weather-wind');
      const pressureEl = container.querySelector('.weather-pressure');

      if (feelsLikeEl) feelsLikeEl.textContent = '--';
      if (windEl && daily.wind_speed_10m_max) {
        windEl.textContent = this.formatWindSpeed(
          daily.wind_speed_10m_max[todayIndex],
          'kmh'
        );
      }
      if (pressureEl) pressureEl.textContent = '--';
    }

    showLoading() {
      this.loadingEl.classList.remove('hidden');
      this.loadingEl.classList.add('flex');
      this.errorEl.classList.add('hidden');
      this.contentEl.classList.add('hidden');
    }

    showError(message) {
      this.loadingEl.classList.add('hidden');
      this.errorEl.classList.remove('hidden');
      this.contentEl.classList.add('hidden');

      const messageEl = this.errorEl.querySelector('.error-message');
      if (messageEl) {
        messageEl.textContent = message;
      }
    }

    showContent() {
      this.loadingEl.classList.add('hidden');
      this.errorEl.classList.add('hidden');
      this.contentEl.classList.remove('hidden');
    }

    // Utility method to get weather icon and description
    getWeatherInfo(code) {
      return (
        WEATHER_CODES[code] || {
          description: 'Unknown',
          icon: '‚ùì',
          severity: 'none',
        }
      );
    }

    // Utility method to format temperature
    formatTemperature(temp, unit = 'celsius') {
      if (temp == null) return 'N/A';
      const rounded = Math.round(temp * 10) / 10;
      const symbol = unit === 'fahrenheit' ? '¬∞F' : '¬∞C';
      return `${rounded}${symbol}`;
    }

    // Utility method to format wind speed
    formatWindSpeed(speed, unit = 'kmh') {
      if (speed == null) return 'N/A';
      const rounded = Math.round(speed * 10) / 10;
      const units = {
        kmh: 'km/h',
        ms: 'm/s',
        mph: 'mph',
        kn: 'kn',
      };
      return `${rounded} ${units[unit] || 'km/h'}`;
    }

    // Utility method to format wind direction
    formatWindDirection(degrees) {
      if (degrees == null) return 'N/A';

      const directions = [
        'N',
        'NNE',
        'NE',
        'ENE',
        'E',
        'ESE',
        'SE',
        'SSE',
        'S',
        'SSW',
        'SW',
        'WSW',
        'W',
        'WNW',
        'NW',
        'NNW',
      ];
      const index = Math.round(degrees / 22.5) % 16;
      return directions[index];
    }

    // Set up auto-refresh functionality
    setupAutoRefresh() {
      if (this.refreshTimer) {
        clearInterval(this.refreshTimer);
      }

      const intervalMs = this.refreshInterval * 60 * 1000; // Convert minutes to milliseconds
      this.refreshTimer = setInterval(() => {
        this.fetchWeatherData();
      }, intervalMs);
    }

    // Clean up resources
    destroy() {
      if (this.refreshTimer) {
        clearInterval(this.refreshTimer);
      }
    }
  }

  // Initialize all weather components
  document.addEventListener('DOMContentLoaded', () => {
    // Force dark mode detection and application
    function applyDarkModeStyles() {
      const isDark =
        document.documentElement.classList.contains('dark') ||
        document.documentElement.dataset.theme === 'dark' ||
        window.matchMedia('(prefers-color-scheme: dark)').matches;

      document.querySelectorAll('.weather-base').forEach((element) => {
        if (isDark) {
          element.style.setProperty('--weather-bg', '#1f2937', 'important');
          element.style.setProperty('--weather-text', '#f9fafb', 'important');
          element.style.setProperty(
            '--weather-text-muted',
            '#e5e7eb',
            'important'
          );
          element.style.setProperty('--weather-border', '#6b7280', 'important');
          element.style.backgroundColor = '#1f2937';
          element.style.color = '#f9fafb';
          element.style.borderColor = '#6b7280';
        } else {
          element.style.setProperty('--weather-bg', '#ffffff', 'important');
          element.style.setProperty('--weather-text', '#000000', 'important');
          element.style.setProperty(
            '--weather-text-muted',
            '#1f2937',
            'important'
          );
          element.style.setProperty('--weather-border', '#374151', 'important');
          element.style.backgroundColor = '#ffffff';
          element.style.color = '#000000';
          element.style.borderColor = '#374151';
        }
      });
    }

    // Apply styles immediately
    applyDarkModeStyles();

    // Listen for dark mode changes
    const darkModeMediaQuery = window.matchMedia(
      '(prefers-color-scheme: dark)'
    );
    darkModeMediaQuery.addEventListener('change', applyDarkModeStyles);

    // Also listen for class changes on documentElement
    const observer = new MutationObserver(applyDarkModeStyles);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class', 'data-theme'],
    });

    document.querySelectorAll('[data-weather-component]').forEach((element) => {
      new WeatherBase(element);
    });
  });

  // Export for use in other components
  window.WeatherBase = WeatherBase;
</script>

<style>
  /* Tailwind 4 CSS Custom Properties for Weather Base Component - WCAG AAA Enhanced */
  @layer components {
    .weather-base {
      /* CSS Custom Properties for Light Mode - WCAG AAA Compliant */
      --weather-bg: #ffffff;
      --weather-border: #374151;
      --weather-text: #000000;
      --weather-text-muted: #1f2937;
      --weather-loading: #374151;
      --weather-error: #7f1d1d;
      --weather-error-bg: #ffffff;
      --weather-success: #14532d;
      --weather-warning: #92400e;
      --weather-info: #1e40af;

      /* Animation timing */
      --weather-transition: cubic-bezier(0.4, 0, 0.2, 1);
      --weather-duration: 200ms;

      /* Enhanced spacing and sizing */
      --weather-radius-xs: 0.375rem;
      --weather-radius-sm: 0.5rem;
      --weather-radius-md: 0.5rem;
      --weather-radius-lg: 0.75rem;
      --weather-radius-xl: 1rem;

      --weather-padding-xs: 0.5rem;
      --weather-padding-sm: 0.75rem;
      --weather-padding-md: 1rem;
      --weather-padding-lg: 1.5rem;
      --weather-padding-xl: 2rem;

      /* Ensure proper background and text colors */
      background-color: var(--weather-bg);
      color: var(--weather-text);
      border-color: var(--weather-border);
    }

    /* Dark mode color scheme - Multiple selectors for robustness */
    .dark .weather-base,
    [data-theme='dark'] .weather-base,
    html.dark .weather-base,
    html[data-theme='dark'] .weather-base {
      --weather-bg: #1f2937 !important;
      --weather-border: #6b7280 !important;
      --weather-text: #f9fafb !important;
      --weather-text-muted: #e5e7eb !important;
      --weather-loading: #9ca3af !important;
      --weather-error: #fca5a5 !important;
      --weather-error-bg: #1f2937 !important;
      --weather-success: #86efac !important;
      --weather-warning: #fbbf24 !important;
      --weather-info: #60a5fa !important;

      background-color: var(--weather-bg) !important;
      color: var(--weather-text) !important;
      border-color: var(--weather-border) !important;
    }

    /* Media query fallback for dark mode */
    @media (prefers-color-scheme: dark) {
      .weather-base {
        --weather-bg: #1f2937 !important;
        --weather-border: #6b7280 !important;
        --weather-text: #f9fafb !important;
        --weather-text-muted: #e5e7eb !important;
        --weather-loading: #9ca3af !important;
        --weather-error: #fca5a5 !important;
        --weather-error-bg: #1f2937 !important;
        --weather-success: #86efac !important;
        --weather-warning: #fbbf24 !important;
        --weather-info: #60a5fa !important;

        background-color: var(--weather-bg) !important;
        color: var(--weather-text) !important;
        border-color: var(--weather-border) !important;
      }
    }

    /* Default content styling for better visibility */
    .weather-default-content {
      color: var(--weather-text);
    }

    .weather-default-content .weather-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .weather-default-content .weather-detail span:first-child {
      color: var(--weather-text);
      font-weight: 600;
    }

    .weather-default-content .weather-detail span:last-child {
      color: var(--weather-text);
      font-weight: 700;
    }

    /* Explicit text classes for proper contrast based on mode */
    .weather-text-muted {
      color: var(--weather-text-muted) !important;
      font-weight: 600 !important;
    }

    .weather-temperature,
    .weather-location,
    .weather-description,
    .weather-feels-like,
    .weather-humidity,
    .weather-wind,
    .weather-pressure {
      color: var(--weather-text) !important;
      font-weight: 700 !important;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .weather-base {
        --weather-border: currentColor;
        border-width: 2px;
      }

      .weather-loading .animate-spin {
        border-width: 3px;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      .weather-loading .animate-spin {
        animation: none;
      }

      .weather-base * {
        transition: none !important;
        animation: none !important;
      }
    }

    /* Focus management for accessibility */
    .weather-base button:focus-visible {
      outline: 2px solid var(--weather-info);
      outline-offset: 2px;
    }

    /* Size-specific adjustments */
    .weather-base[data-size='xs'] {
      font-size: 0.75rem;
      line-height: 1rem;
    }

    .weather-base[data-size='sm'] {
      font-size: 0.875rem;
      line-height: 1.25rem;
    }

    .weather-base[data-size='md'] {
      font-size: 1rem;
      line-height: 1.5rem;
    }

    .weather-base[data-size='lg'] {
      font-size: 1.125rem;
      line-height: 1.75rem;
    }

    .weather-base[data-size='xl'] {
      font-size: 1.25rem;
      line-height: 1.75rem;
    }

    /* Theme-specific color overrides - Light Mode WCAG AAA */
    .weather-base[data-theme='blue'] {
      --weather-info: #1e40af;
      --weather-bg: #f0f9ff;
      --weather-border: #374151;
      --weather-text: #000000;
      --weather-text-muted: #1f2937;
    }

    .weather-base[data-theme='green'] {
      --weather-info: #14532d;
      --weather-bg: #f0fdf4;
      --weather-border: #374151;
      --weather-text: #000000;
      --weather-text-muted: #1f2937;
    }

    .weather-base[data-theme='orange'] {
      --weather-info: #9a3412;
      --weather-bg: #fff7ed;
      --weather-border: #374151;
      --weather-text: #000000;
      --weather-text-muted: #1f2937;
    }

    .weather-base[data-theme='red'] {
      --weather-info: #7f1d1d;
      --weather-bg: #fef2f2;
      --weather-border: #374151;
      --weather-text: #000000;
      --weather-text-muted: #1f2937;
    }

    .weather-base[data-theme='purple'] {
      --weather-info: #581c87;
      --weather-bg: #faf5ff;
      --weather-border: #374151;
      --weather-text: #000000;
      --weather-text-muted: #1f2937;
    }

    /* Dark mode theme adjustments - Multiple selectors with !important */
    .dark .weather-base[data-theme='blue'],
    [data-theme='dark'] .weather-base[data-theme='blue'],
    html.dark .weather-base[data-theme='blue'] {
      --weather-bg: #1e3a8a !important;
      --weather-border: #3b82f6 !important;
      --weather-info: #93c5fd !important;
      --weather-text: #f9fafb !important;
      --weather-text-muted: #e5e7eb !important;
    }

    .dark .weather-base[data-theme='green'],
    [data-theme='dark'] .weather-base[data-theme='green'],
    html.dark .weather-base[data-theme='green'] {
      --weather-bg: #166534 !important;
      --weather-border: #22c55e !important;
      --weather-info: #86efac !important;
      --weather-text: #f9fafb !important;
      --weather-text-muted: #e5e7eb !important;
    }

    .dark .weather-base[data-theme='orange'],
    [data-theme='dark'] .weather-base[data-theme='orange'],
    html.dark .weather-base[data-theme='orange'] {
      --weather-bg: #c2410c !important;
      --weather-border: #f97316 !important;
      --weather-info: #fed7aa !important;
      --weather-text: #f9fafb !important;
      --weather-text-muted: #e5e7eb !important;
    }

    .dark .weather-base[data-theme='red'],
    [data-theme='dark'] .weather-base[data-theme='red'],
    html.dark .weather-base[data-theme='red'] {
      --weather-bg: #991b1b !important;
      --weather-border: #ef4444 !important;
      --weather-info: #fca5a5 !important;
      --weather-text: #f9fafb !important;
      --weather-text-muted: #e5e7eb !important;
    }

    .dark .weather-base[data-theme='purple'],
    [data-theme='dark'] .weather-base[data-theme='purple'],
    html.dark .weather-base[data-theme='purple'] {
      --weather-bg: #7c3aed !important;
      --weather-border: #a855f7 !important;
      --weather-info: #d8b4fe !important;
      --weather-text: #f9fafb !important;
      --weather-text-muted: #e5e7eb !important;
    }

    /* Loading spinner animation enhancement */
    @keyframes weather-pulse {
      0%,
      100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .weather-loading {
      animation: weather-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Weather severity color coding - WCAG AAA Enhanced (9:1+ contrast) */
    .weather-severity-none {
      color: var(--weather-text);
      font-weight: 600;
    }

    .weather-severity-low {
      color: #78350f;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .dark .weather-severity-low {
      color: #fbbf24;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }

    .weather-severity-medium {
      color: #7c2d12;
      font-weight: 800;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .dark .weather-severity-medium {
      color: #fbbf24;
      font-weight: 800;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }

    .weather-severity-high {
      color: #7f1d1d;
      font-weight: 900;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .dark .weather-severity-high {
      color: #ffffff;
      font-weight: 900;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .weather-severity-extreme {
      color: #7f1d1d;
      font-weight: 900;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .dark .weather-severity-extreme {
      color: #fca5a5;
      font-weight: 900;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }

    /* Loading state enhancements */
    .weather-loading {
      background-color: var(--weather-bg);
      color: var(--weather-text-muted);
    }

    .weather-loading .animate-spin {
      border-color: var(--weather-border);
      border-top-color: var(--weather-info);
    }

    /* Error state enhancements - Proper Light/Dark Mode */
    .weather-error {
      background-color: #fef2f2;
      color: #7f1d1d;
      border: 2px solid #7f1d1d;
    }

    .dark .weather-error {
      background-color: #7f1d1d;
      border-color: #fca5a5;
      color: #fef2f2;
    }

    /* Retry button proper contrast */
    .retry-button {
      background-color: #1e40af;
      color: #ffffff;
      border: 2px solid #1e40af;
      font-weight: 700;
    }

    .retry-button:hover {
      background-color: #1d4ed8;
      border-color: #1d4ed8;
      color: #ffffff;
    }

    .dark .retry-button {
      background-color: #60a5fa;
      color: #1f2937;
      border-color: #60a5fa;
      font-weight: 700;
    }

    .dark .retry-button:hover {
      background-color: #93c5fd;
      border-color: #93c5fd;
      color: #1f2937;
    }

    /* Print styles */
    @media print {
      .weather-base {
        border: 1px solid black;
        break-inside: avoid;
      }

      .weather-loading,
      .retry-button {
        display: none !important;
      }
    }

    /* WCAG AAA Interactive States */
    .retry-button:focus {
      outline: 3px solid var(--weather-info);
      outline-offset: 2px;
      box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.3);
    }

    .dark .retry-button:focus {
      outline-color: #60a5fa;
      box-shadow: 0 0 0 5px rgba(96, 165, 250, 0.3);
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .weather-base {
        border-width: 2px;
        border-color: CanvasText;
      }

      .weather-card {
        background-color: Canvas;
        color: CanvasText;
      }

      .weather-temperature,
      .weather-location {
        color: CanvasText;
        font-weight: 900;
      }
    }

    /* Motion reduction support */
    @media (prefers-reduced-motion: reduce) {
      .animate-spin {
        animation: none;
      }

      .weather-base * {
        transition: none !important;
      }
    }
  }
</style>
