---
/**
 * Spotlight - Onboarding highlight overlay
 *
 * Features:
 * - Highlight any element on page
 * - Tooltip positioning
 * - Multi-step tours
 * - Keyboard navigation
 * - Click-outside dismiss
 * - Smooth transitions
 *
 * @example
 * <Spotlight
 *   steps={[
 *     { target: '#btn-1', title: 'Click here', description: 'Start your journey' },
 *     { target: '#menu', title: 'Navigate', description: 'Find more options' },
 *   ]}
 *   autoStart
 * />
 */
import { cn } from '../utils/cn';

interface SpotlightStep {
  /** CSS selector for target element */
  target: string;
  /** Step title */
  title: string;
  /** Step description */
  description?: string;
  /** Tooltip position */
  position?: 'top' | 'bottom' | 'left' | 'right';
}

interface Props {
  /** Array of spotlight steps */
  steps: SpotlightStep[];
  /** Start tour automatically */
  autoStart?: boolean;
  /** Show step counter (1/3) */
  showProgress?: boolean;
  /** Allow closing via backdrop click */
  closeOnBackdrop?: boolean;
  /** Allow keyboard navigation (arrows, escape) */
  keyboardNav?: boolean;
  /** Padding around highlighted element */
  padding?: number;
  /** Custom labels */
  labels?: {
    next?: string;
    prev?: string;
    finish?: string;
    skip?: string;
  };
  /** Additional CSS classes */
  className?: string;
}

const {
  steps,
  autoStart = false,
  showProgress = true,
  closeOnBackdrop = true,
  keyboardNav = true,
  padding = 8,
  labels = {},
  className = '',
} = Astro.props;

const defaultLabels = {
  next: 'Next',
  prev: 'Back',
  finish: 'Done',
  skip: 'Skip',
  ...labels,
};

const id = `spotlight-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  id={id}
  class={cn('spotlight-container', className)}
  data-spotlight
  data-steps={JSON.stringify(steps)}
  data-auto-start={autoStart}
  data-close-on-backdrop={closeOnBackdrop}
  data-keyboard-nav={keyboardNav}
  data-padding={padding}
  data-labels={JSON.stringify(defaultLabels)}
  data-show-progress={showProgress}
  aria-hidden="true"
>
  <!-- Backdrop overlay -->
  <div class="spotlight-backdrop" data-spotlight-backdrop></div>

  <!-- Highlight cutout -->
  <div class="spotlight-highlight" data-spotlight-highlight></div>

  <!-- Tooltip -->
  <div
    class="spotlight-tooltip"
    data-spotlight-tooltip
    role="dialog"
    aria-modal="true"
  >
    <div class="spotlight-tooltip-content">
      <h3 class="spotlight-title" data-spotlight-title></h3>
      <p class="spotlight-description" data-spotlight-description></p>
    </div>

    <div class="spotlight-footer">
      <div class="spotlight-progress" data-spotlight-progress></div>
      <div class="spotlight-actions">
        <button
          type="button"
          class="spotlight-btn spotlight-btn-skip"
          data-spotlight-skip
        >
          {defaultLabels.skip}
        </button>
        <button
          type="button"
          class="spotlight-btn spotlight-btn-prev"
          data-spotlight-prev
        >
          {defaultLabels.prev}
        </button>
        <button
          type="button"
          class="spotlight-btn spotlight-btn-next"
          data-spotlight-next
        >
          {defaultLabels.next}
        </button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    class SpotlightTour {
      constructor(container) {
        this.container = container;
        this.steps = JSON.parse(container.dataset.steps || '[]');
        this.currentStep = 0;
        this.isActive = false;
        this.padding = parseInt(container.dataset.padding) || 8;
        this.labels = JSON.parse(container.dataset.labels || '{}');
        this.showProgress = container.dataset.showProgress === 'true';
        this.closeOnBackdrop = container.dataset.closeOnBackdrop === 'true';
        this.keyboardNav = container.dataset.keyboardNav === 'true';

        this.backdrop = container.querySelector('[data-spotlight-backdrop]');
        this.highlight = container.querySelector('[data-spotlight-highlight]');
        this.tooltip = container.querySelector('[data-spotlight-tooltip]');
        this.titleEl = container.querySelector('[data-spotlight-title]');
        this.descriptionEl = container.querySelector(
          '[data-spotlight-description]'
        );
        this.progressEl = container.querySelector('[data-spotlight-progress]');
        this.prevBtn = container.querySelector('[data-spotlight-prev]');
        this.nextBtn = container.querySelector('[data-spotlight-next]');
        this.skipBtn = container.querySelector('[data-spotlight-skip]');

        this.bindEvents();

        if (container.dataset.autoStart === 'true') {
          setTimeout(() => this.start(), 500);
        }
      }

      bindEvents() {
        this.prevBtn?.addEventListener('click', () => this.prev());
        this.nextBtn?.addEventListener('click', () => this.next());
        this.skipBtn?.addEventListener('click', () => this.end());

        if (this.closeOnBackdrop) {
          this.backdrop?.addEventListener('click', () => this.end());
        }

        if (this.keyboardNav) {
          document.addEventListener('keydown', (e) => {
            if (!this.isActive) return;
            if (e.key === 'Escape') this.end();
            if (e.key === 'ArrowRight') this.next();
            if (e.key === 'ArrowLeft') this.prev();
          });
        }

        window.addEventListener('resize', () => {
          if (this.isActive) this.positionElements();
        });
      }

      start() {
        if (this.steps.length === 0) return;
        this.isActive = true;
        this.currentStep = 0;
        this.container.setAttribute('aria-hidden', 'false');
        this.container.classList.add('active');
        document.body.style.overflow = 'hidden';
        this.showStep();
        this.container.dispatchEvent(
          new CustomEvent('spotlight:start', { bubbles: true })
        );
      }

      end() {
        this.isActive = false;
        this.container.setAttribute('aria-hidden', 'true');
        this.container.classList.remove('active');
        document.body.style.overflow = '';
        this.container.dispatchEvent(
          new CustomEvent('spotlight:end', { bubbles: true })
        );
      }

      next() {
        if (this.currentStep < this.steps.length - 1) {
          this.currentStep++;
          this.showStep();
        } else {
          this.end();
        }
      }

      prev() {
        if (this.currentStep > 0) {
          this.currentStep--;
          this.showStep();
        }
      }

      showStep() {
        const step = this.steps[this.currentStep];
        if (!step) return;

        const target = document.querySelector(step.target);
        if (!target) {
          console.warn(`Spotlight: Target "${step.target}" not found`);
          this.next();
          return;
        }

        // Update content
        this.titleEl.textContent = step.title || '';
        this.descriptionEl.textContent = step.description || '';
        this.descriptionEl.style.display = step.description ? 'block' : 'none';

        // Update progress
        if (this.showProgress) {
          this.progressEl.textContent = `${this.currentStep + 1} / ${this.steps.length}`;
          this.progressEl.style.display = 'block';
        } else {
          this.progressEl.style.display = 'none';
        }

        // Update buttons
        this.prevBtn.style.display =
          this.currentStep > 0 ? 'inline-flex' : 'none';
        this.nextBtn.textContent =
          this.currentStep === this.steps.length - 1
            ? this.labels.finish
            : this.labels.next;

        // Scroll target into view
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Position after scroll
        setTimeout(() => this.positionElements(target, step.position), 300);

        this.container.dispatchEvent(
          new CustomEvent('spotlight:step', {
            bubbles: true,
            detail: { step: this.currentStep, total: this.steps.length },
          })
        );
      }

      positionElements(target, position = 'bottom') {
        if (!target) {
          const step = this.steps[this.currentStep];
          target = document.querySelector(step?.target);
          position = step?.position || 'bottom';
        }
        if (!target) return;

        const rect = target.getBoundingClientRect();
        const pad = this.padding;

        // Position highlight
        this.highlight.style.top = `${rect.top - pad}px`;
        this.highlight.style.left = `${rect.left - pad}px`;
        this.highlight.style.width = `${rect.width + pad * 2}px`;
        this.highlight.style.height = `${rect.height + pad * 2}px`;

        // Position tooltip
        const tooltipRect = this.tooltip.getBoundingClientRect();
        let top, left;

        switch (position) {
          case 'top':
            top = rect.top - tooltipRect.height - 16;
            left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            break;
          case 'bottom':
            top = rect.bottom + 16;
            left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            break;
          case 'left':
            top = rect.top + rect.height / 2 - tooltipRect.height / 2;
            left = rect.left - tooltipRect.width - 16;
            break;
          case 'right':
            top = rect.top + rect.height / 2 - tooltipRect.height / 2;
            left = rect.right + 16;
            break;
          default:
            top = rect.bottom + 16;
            left = rect.left + rect.width / 2 - tooltipRect.width / 2;
        }

        // Keep tooltip in viewport
        const maxLeft = window.innerWidth - tooltipRect.width - 16;
        const maxTop = window.innerHeight - tooltipRect.height - 16;
        left = Math.max(16, Math.min(left, maxLeft));
        top = Math.max(16, Math.min(top, maxTop));

        this.tooltip.style.top = `${top}px`;
        this.tooltip.style.left = `${left}px`;
      }
    }

    // Initialize all spotlights
    document.querySelectorAll('[data-spotlight]').forEach((el) => {
      const tour = new SpotlightTour(el);
      el._spotlight = tour;
    });

    // Global API
    window.Spotlight = {
      start(id) {
        const el = document.querySelector(id || '[data-spotlight]');
        el?._spotlight?.start();
      },
      end(id) {
        const el = document.querySelector(id || '[data-spotlight]');
        el?._spotlight?.end();
      },
    };
  })();
</script>

<style>
  .spotlight-container {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
  }

  .spotlight-container.active {
    display: block;
  }

  .spotlight-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    transition: opacity 0.3s ease;
  }

  .spotlight-highlight {
    position: fixed;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
    border-radius: 8px;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 1;
  }

  .spotlight-tooltip {
    position: fixed;
    background: rgb(30 41 59);
    border: 1px solid rgb(71 85 105);
    border-radius: 12px;
    padding: 1rem;
    max-width: 320px;
    z-index: 2;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .spotlight-title {
    font-size: 1rem;
    font-weight: 600;
    color: rgb(241 245 249);
    margin: 0 0 0.5rem 0;
  }

  .spotlight-description {
    font-size: 0.875rem;
    color: rgb(148 163 184);
    margin: 0;
    line-height: 1.5;
  }

  .spotlight-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgb(51 65 85);
  }

  .spotlight-progress {
    font-size: 0.75rem;
    color: rgb(100 116 139);
  }

  .spotlight-actions {
    display: flex;
    gap: 0.5rem;
  }

  .spotlight-btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    border: none;
  }

  .spotlight-btn-skip {
    background: transparent;
    color: rgb(148 163 184);
  }

  .spotlight-btn-skip:hover {
    color: rgb(241 245 249);
  }

  .spotlight-btn-prev {
    background: rgb(51 65 85);
    color: rgb(241 245 249);
  }

  .spotlight-btn-prev:hover {
    background: rgb(71 85 105);
  }

  .spotlight-btn-next {
    background: rgb(59 130 246);
    color: white;
  }

  .spotlight-btn-next:hover {
    background: rgb(37 99 235);
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .spotlight-backdrop,
    .spotlight-highlight,
    .spotlight-tooltip {
      transition: none;
    }
  }

  /* High contrast */
  @media (prefers-contrast: high) {
    .spotlight-tooltip {
      border-width: 2px;
    }
  }
</style>
