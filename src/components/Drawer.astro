---
interface Props {
  id: string;
  title?: string;
  position?: 'left' | 'right';
  size?: 'sm' | 'md' | 'lg' | 'full';
  dismissible?: boolean;
  className?: string;
}

const {
  id,
  title,
  position = 'right',
  size = 'md',
  dismissible = true,
  className = '',
} = Astro.props;

const sizeClasses = {
  sm: 'max-w-xs w-80',
  md: 'max-w-md w-96',
  lg: 'max-w-lg w-[30rem]',
  full: 'max-w-full w-full sm:w-4/5 lg:w-3/5',
};

const positionClasses = {
  left: 'left-0',
  right: 'right-0',
};
---

<div
  id={id}
  class="fixed inset-0 z-50 invisible"
  data-drawer
  aria-hidden="true"
>
  <div
    class="absolute inset-0 bg-slate-950/80 opacity-0 transition-opacity duration-300"
    data-drawer-backdrop
  >
  </div>

  <div
    class={`absolute top-0 ${positionClasses[position]} h-full ${sizeClasses[size]} w-full border-2 border-slate-300/90 bg-white text-slate-900 shadow-2xl ${
      position === 'left' ? 'border-r-2' : 'border-l-2'
    } transform transition-transform duration-300 ease-out ${
      position === 'left' ? '-translate-x-full' : 'translate-x-full'
    } ${className} dark:border-slate-600/90 dark:bg-slate-800 dark:text-slate-100`}
    data-drawer-panel
    data-position={position}
    role="dialog"
    aria-modal="true"
    aria-labelledby={title ? `${id}-title` : undefined}
  >
    <div class="flex flex-col h-full">
      {
        (title || dismissible) && (
          <header class="flex items-center justify-between border-b-2 border-slate-300/80 bg-slate-50/50 px-6 py-4 dark:border-slate-600/80 dark:bg-slate-700/30">
            {title && (
              <h2 
                id={`${id}-title`}
                class="text-lg font-semibold text-slate-900 dark:text-slate-100"
              >
                {title}
              </h2>
            )}
            {dismissible && (
              <button
                type="button"
                class="ml-auto inline-flex h-10 w-10 items-center justify-center rounded-full border border-transparent bg-white/90 text-slate-800 transition-colors duration-200 hover:bg-slate-100 hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:bg-slate-700/90 dark:text-slate-100 dark:hover:bg-slate-600 dark:hover:text-slate-50 dark:focus-visible:ring-blue-400 dark:focus-visible:ring-offset-slate-800"
                data-drawer-close
                aria-label="Close drawer"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            )}
          </header>
        )
      }

      <div
        class="flex-1 overflow-y-auto px-6 py-6 text-sm leading-relaxed text-slate-800 dark:text-slate-200"
      >
        <slot />
      </div>

      <footer class="border-t-2 border-slate-300/80 bg-slate-50/30 px-6 py-4 dark:border-slate-600/80 dark:bg-slate-700/20">
        <slot name="actions">
          {
            dismissible && (
              <button
                type="button"
                class="rounded-lg border border-slate-300/90 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 transition-colors duration-200 hover:bg-slate-50 hover:text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:border-slate-500/90 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:hover:text-slate-50 dark:focus-visible:ring-blue-400 dark:focus-visible:ring-offset-slate-800"
                data-drawer-close
              >
                Close
              </button>
            )
          }
        </slot>
      </footer>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    const drawers = Array.from(
      document.querySelectorAll('[data-drawer]')
    ).filter((el) => el instanceof HTMLElement);
    if (!drawers.length) return;

    const lastFocusMap = new WeakMap();

    const getFocusableChildren = (container) =>
      Array.from(
        container.querySelectorAll(
          'a[href], button:not([disabled]), textarea, input, select, [tabindex]'
        )
      ).filter(
        (el) =>
          el instanceof HTMLElement &&
          el.tabIndex !== -1 &&
          !el.hasAttribute('disabled')
      );

    const closeDrawer = (drawer) => {
      if (!drawer) return;
      const backdrop = drawer.querySelector('[data-drawer-backdrop]');
      const panel = drawer.querySelector('[data-drawer-panel]');
      if (backdrop instanceof HTMLElement) {
        backdrop.classList.remove('opacity-100');
        backdrop.classList.add('opacity-0');
      }
      if (panel instanceof HTMLElement) {
        const position =
          panel.getAttribute('data-position') === 'left' ? 'left' : 'right';
        panel.classList.remove('translate-x-0');
        panel.classList.add(
          position === 'left' ? '-translate-x-full' : 'translate-x-full'
        );
      }
      drawer.setAttribute('aria-hidden', 'true');
      window.setTimeout(() => {
        drawer.classList.add('invisible');
      }, 200);
      const last = lastFocusMap.get(drawer);
      if (last instanceof HTMLElement) {
        last.focus({ preventScroll: true });
      }
      if (!document.querySelector('[data-drawer][aria-hidden="false"]')) {
        document.body.style.removeProperty('overflow');
      }
    };

    drawers.forEach((drawer) => {
      const backdrop = drawer.querySelector('[data-drawer-backdrop]');
      const panel = drawer.querySelector('[data-drawer-panel]');
      const closeButtons = drawer.querySelectorAll('[data-drawer-close]');

      closeButtons.forEach((button) => {
        button.addEventListener('click', () => closeDrawer(drawer));
      });

      if (backdrop instanceof HTMLElement) {
        backdrop.addEventListener('click', () => closeDrawer(drawer));
      }

      drawer.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeDrawer(drawer);
        } else if (event.key === 'Tab' && panel instanceof HTMLElement) {
          const focusable = getFocusableChildren(panel);
          if (!focusable.length) return;
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (event.shiftKey && document.activeElement === first) {
            event.preventDefault();
            last.focus({ preventScroll: true });
          } else if (!event.shiftKey && document.activeElement === last) {
            event.preventDefault();
            first.focus({ preventScroll: true });
          }
        }
      });
    });

    const openDrawer = (drawer) => {
      if (!drawer) return;
      const backdrop = drawer.querySelector('[data-drawer-backdrop]');
      const panel = drawer.querySelector('[data-drawer-panel]');
      if (!(panel instanceof HTMLElement)) return;
      lastFocusMap.set(
        drawer,
        document.activeElement instanceof HTMLElement
          ? document.activeElement
          : null
      );
      drawer.classList.remove('invisible');
      requestAnimationFrame(() => {
        if (backdrop instanceof HTMLElement) {
          backdrop.classList.remove('opacity-0');
          backdrop.classList.add('opacity-100');
        }
        panel.classList.remove('-translate-x-full', 'translate-x-full');
        panel.classList.add('translate-x-0');
      });
      drawer.setAttribute('aria-hidden', 'false');
      document.body.style.setProperty('overflow', 'hidden');
      const focusable = getFocusableChildren(panel);
      (focusable[0] || panel).focus({ preventScroll: true });
    };

    document.addEventListener('click', (event) => {
      const trigger =
        event.target instanceof HTMLElement
          ? event.target.closest('[data-drawer-trigger]')
          : null;
      if (!trigger) return;
      const targetId = trigger.getAttribute('data-drawer-trigger');
      if (!targetId) return;
      const drawer = document.getElementById(targetId);
      if (!(drawer instanceof HTMLElement)) return;
      openDrawer(drawer);
    });
  })();
</script>
