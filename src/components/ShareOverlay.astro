---
import { cn } from '../utils/cn';

/**
 * ShareOverlay - Accessible share dialog with WCAG AAA compliance
 * Provides social sharing and copy-to-clipboard functionality with proper keyboard navigation
 */

interface ShareTarget {
  name: string;
  href: string;
  icon: string;
  label: string;
}

interface Props {
  /** URL to share (defaults to current page URL) */
  url?: string;
  /** Title for sharing (used in social media posts) */
  title?: string;
  /** Description for sharing */
  description?: string;
  /** Whether the overlay is open */
  open?: boolean;
  /** Additional share targets beyond the default ones */
  customTargets?: ShareTarget[];
  /** Whether to show default share targets */
  showDefaultTargets?: boolean;
  /** Custom ID for the overlay */
  id?: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  url,
  title = '',
  description = '',
  open = false,
  customTargets = [],
  showDefaultTargets = true,
  id: propId,
  class: className = '',
} = Astro.props;

// Generate unique IDs
const overlayId =
  propId || `share-overlay-${Math.random().toString(36).slice(2, 9)}`;
const inputId = `${overlayId}-url`;
const headingId = `${overlayId}-title`;

// URL and content processing
const shareUrl = url || Astro.url.toString();
const encodedUrl = encodeURIComponent(shareUrl);
const encodedTitle = encodeURIComponent(title);
const encodedDescription = encodeURIComponent(description);

// Default share targets with accessibility improvements
const defaultTargets: ShareTarget[] = showDefaultTargets
  ? [
      {
        name: 'X (Twitter)',
        href: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}${description ? `&via=${encodedDescription}` : ''}`,
        icon: 'twitter',
        label: 'Share on X (Twitter)',
      },
      {
        name: 'Facebook',
        href: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
        icon: 'facebook',
        label: 'Share on Facebook',
      },
      {
        name: 'LinkedIn',
        href: `https://www.linkedin.com/shareArticle?mini=true&url=${encodedUrl}&title=${encodedTitle}&summary=${encodedDescription}`,
        icon: 'linkedin',
        label: 'Share on LinkedIn',
      },
      {
        name: 'Email',
        href: `mailto:?subject=${encodedTitle}&body=${encodedDescription}%0A%0A${encodedUrl}`,
        icon: 'email',
        label: 'Share via Email',
      },
    ]
  : [];

const allTargets = [...defaultTargets, ...customTargets];

// WCAG AAA compliant styling classes
const overlayClasses = cn(
  'fixed inset-0 z-50 flex items-center justify-center min-h-screen px-4',
  'backdrop-blur-sm transition-opacity duration-200',
  !open && 'hidden'
);

const backdropClasses = cn(
  'absolute inset-0 bg-black/75 transition-opacity duration-200'
);

const dialogClasses = cn(
  'relative z-10 w-full max-w-lg mx-auto my-auto rounded-xl shadow-2xl',
  'bg-white dark:bg-gray-900',
  'border border-gray-200 dark:border-gray-700',
  'p-6 space-y-6',
  'transform transition-all duration-200',
  className
);

const headerClasses = cn('flex items-center justify-between gap-4');

const titleClasses = cn(
  'text-xl font-semibold',
  'text-gray-900 dark:text-gray-100'
);

const closeButtonClasses = cn(
  'inline-flex items-center justify-center',
  'w-10 h-10 rounded-lg',
  'text-gray-500 dark:text-gray-400',
  'hover:text-gray-700 dark:hover:text-gray-200',
  'hover:bg-gray-100 dark:hover:bg-gray-800',
  'focus:outline-none focus:ring-2 focus:ring-blue-600 dark:focus:ring-blue-400',
  'focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900',
  'transition-colors duration-200'
);

const urlSectionClasses = cn('space-y-3');

const labelClasses = cn(
  'block text-sm font-medium',
  'text-gray-900 dark:text-gray-100',
  'mb-2'
);

const inputWrapperClasses = cn('flex gap-3');

const inputClasses = cn(
  'flex-1 px-3 py-2.5 text-sm',
  'bg-white dark:bg-gray-800',
  'border border-gray-300 dark:border-gray-600',
  'text-gray-900 dark:text-gray-100',
  'rounded-lg transition-colors duration-200',
  'focus:outline-none focus:ring-2 focus:ring-blue-600 dark:focus:ring-blue-400',
  'focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900',
  'focus:border-blue-600 dark:focus:border-blue-400'
);

const copyButtonClasses = cn(
  'inline-flex items-center justify-center gap-2',
  'px-4 py-2.5 text-sm font-medium',
  'bg-blue-600 dark:bg-blue-500',
  'text-white dark:text-gray-900',
  'border border-blue-600 dark:border-blue-500',
  'rounded-lg transition-colors duration-200',
  'hover:bg-blue-700 dark:hover:bg-blue-400',
  'focus:outline-none focus:ring-2 focus:ring-blue-600 dark:focus:ring-blue-400',
  'focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900',
  'disabled:opacity-50 disabled:cursor-not-allowed'
);

const shareButtonsClasses = cn('grid grid-cols-2 sm:grid-cols-4 gap-3');

const shareButtonClasses = cn(
  'inline-flex flex-col items-center justify-center gap-2',
  'p-4 text-sm font-medium',
  'bg-gray-50 dark:bg-gray-800',
  'text-gray-900 dark:text-gray-100',
  'border border-gray-200 dark:border-gray-700',
  'rounded-lg transition-colors duration-200',
  'hover:bg-gray-100 dark:hover:bg-gray-700',
  'hover:border-gray-300 dark:hover:border-gray-600',
  'focus:outline-none focus:ring-2 focus:ring-blue-600 dark:focus:ring-blue-400',
  'focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900',
  'no-underline'
);

// Icon components for social platforms
const getIcon = (iconType: string) => {
  const iconClasses = 'w-6 h-6 flex-shrink-0';

  switch (iconType) {
    case 'twitter':
      return `<svg class="${iconClasses}" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>`;
    case 'facebook':
      return `<svg class="${iconClasses}" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
      </svg>`;
    case 'linkedin':
      return `<svg class="${iconClasses}" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
      </svg>`;
    case 'email':
      return `<svg class="${iconClasses}" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>`;
    default:
      return `<svg class="${iconClasses}" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
      </svg>`;
  }
};
---

<div
  class={overlayClasses}
  id={overlayId}
  data-share-overlay
  data-open={open}
  role="dialog"
  aria-modal="true"
  aria-labelledby={headingId}
>
  <!-- Backdrop -->
  <div class={backdropClasses} data-share-backdrop aria-hidden="true"></div>

  <!-- Dialog -->
  <div class={dialogClasses}>
    <!-- Header -->
    <header class={headerClasses}>
      <h2 id={headingId} class={titleClasses}>Share</h2>
      <button
        type="button"
        class={closeButtonClasses}
        data-share-close
        aria-label="Close share dialog"
      >
        <svg
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"
          ></path>
        </svg>
      </button>
    </header>

    <!-- URL Section -->
    <div class={urlSectionClasses}>
      <label for={inputId} class={labelClasses}> Share this link </label>
      <div class={inputWrapperClasses}>
        <input
          id={inputId}
          class={inputClasses}
          value={shareUrl}
          readonly
          aria-describedby={`${inputId}-description`}
        />
        <button
          type="button"
          class={copyButtonClasses}
          data-share-copy
          aria-describedby={`${inputId}-copy-status`}
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="currentColor"
            aria-hidden="true"
          >
            <path
              d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"
            ></path>
            <path
              d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"
            ></path>
          </svg>
          Copy
        </button>
      </div>
      <p id={`${inputId}-description`} class="sr-only">
        Copy this URL to share the page
      </p>
      <p
        id={`${inputId}-copy-status`}
        class="sr-only"
        aria-live="polite"
        data-copy-status
      >
      </p>
    </div>

    <!-- Share Buttons -->
    {
      allTargets.length > 0 && (
        <div>
          <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">
            Share on social media
          </h3>
          <div class={shareButtonsClasses}>
            {allTargets.map((target) => (
              <a
                href={target.href}
                target="_blank"
                rel="noopener noreferrer"
                class={shareButtonClasses}
                aria-label={target.label}
              >
                <span set:html={getIcon(target.icon)} />
                <span class="text-xs text-center leading-tight">
                  {target.name}
                </span>
                <span class="sr-only"> (opens in a new tab)</span>
              </a>
            ))}
          </div>
        </div>
      )
    }
  </div>
</div>

<script is:inline define:vars={{ overlayId }}>
  (function () {
    const root = document.getElementById(overlayId);
    if (!(root instanceof HTMLElement)) return;

    // Modal state management
    const win = window;
    if (typeof win.__cometModalLockCount !== 'number') {
      win.__cometModalLockCount = 0;
    }
    if (typeof win.__cometModalOriginalOverflow !== 'string') {
      win.__cometModalOriginalOverflow = document.body.style.overflow || '';
    }

    // Get elements
    const closeButtons = root.querySelectorAll('[data-share-close]');
    const backdrop = root.querySelector('[data-share-backdrop]');
    const copyButton = root.querySelector('[data-share-copy]');
    const input = root.querySelector('input');
    const copyStatus = root.querySelector('[data-copy-status]');

    if (!(input instanceof HTMLInputElement)) return;

    // Focus management
    const focusableSelectors = [
      'a[href]',
      'area[href]',
      'button:not([disabled])',
      'input:not([disabled]):not([type="hidden"])',
      'select:not([disabled])',
      'textarea:not([disabled])',
      '[tabindex]:not([tabindex="-1"])',
    ].join(',');

    let returnFocus = null;

    const getFocusable = () =>
      Array.from(root.querySelectorAll(focusableSelectors)).filter(
        (el) => el instanceof HTMLElement && el.offsetParent !== null
      );

    const setOpenState = (isOpen) => {
      const wasOpen = root.getAttribute('data-open') === 'true';
      if (wasOpen === isOpen) {
        root.classList.toggle('hidden', !isOpen);
        return;
      }

      root.setAttribute('data-open', String(isOpen));
      root.classList.toggle('hidden', !isOpen);

      if (isOpen) {
        // Lock scroll
        win.__cometModalLockCount += 1;
        if (win.__cometModalLockCount === 1) {
          document.body.style.overflow = 'hidden';
        }

        // Store current focus and focus input
        returnFocus =
          document.activeElement instanceof HTMLElement
            ? document.activeElement
            : null;

        // Focus the input and select the URL
        setTimeout(() => {
          input.focus({ preventScroll: true });
          input.select();
        }, 100);

        // Announce to screen readers
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent =
          'Share dialog opened. URL selected for copying.';
        document.body.appendChild(announcement);
        setTimeout(() => document.body.removeChild(announcement), 1000);
      } else {
        // Unlock scroll
        win.__cometModalLockCount = Math.max(0, win.__cometModalLockCount - 1);
        if (win.__cometModalLockCount === 0) {
          document.body.style.overflow = win.__cometModalOriginalOverflow || '';
        }

        // Return focus
        if (returnFocus instanceof HTMLElement) {
          returnFocus.focus({ preventScroll: true });
        }
      }
    };

    // Keyboard navigation
    const handleKeydown = (event) => {
      if (root.getAttribute('data-open') !== 'true') return;

      if (event.key === 'Escape') {
        event.stopPropagation();
        setOpenState(false);
        return;
      }

      if (event.key === 'Tab') {
        const focusables = getFocusable();
        if (!focusables.length) return;

        const activeElement =
          document.activeElement instanceof HTMLElement
            ? document.activeElement
            : null;
        const currentIndex = activeElement
          ? focusables.indexOf(activeElement)
          : -1;

        let nextIndex = currentIndex;
        if (event.shiftKey) {
          nextIndex =
            currentIndex <= 0 ? focusables.length - 1 : currentIndex - 1;
        } else {
          nextIndex =
            currentIndex === focusables.length - 1 ? 0 : currentIndex + 1;
        }

        event.preventDefault();
        focusables[nextIndex].focus({ preventScroll: true });
      }
    };

    // Event listeners
    closeButtons.forEach((btn) => {
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        setOpenState(false);
      });
    });

    backdrop?.addEventListener('click', () => setOpenState(false));
    root.addEventListener('keydown', handleKeydown);

    // Copy functionality with better feedback
    copyButton?.addEventListener('click', async (event) => {
      event.preventDefault();
      if (!(copyButton instanceof HTMLElement)) return;

      const originalText = copyButton.textContent;

      try {
        await navigator.clipboard.writeText(input.value);

        // Visual feedback
        copyButton.textContent = 'Copied!';
        copyButton.setAttribute('aria-pressed', 'true');

        // Screen reader feedback
        if (copyStatus) {
          copyStatus.textContent = 'URL copied to clipboard';
        }

        // Reset after delay
        setTimeout(() => {
          copyButton.textContent = originalText;
          copyButton.removeAttribute('aria-pressed');
          if (copyStatus) {
            copyStatus.textContent = '';
          }
        }, 2000);
      } catch {
        // Fallback for older browsers
        try {
          input.select();
          document.execCommand('copy');
          copyButton.textContent = 'Copied!';
          if (copyStatus) {
            copyStatus.textContent = 'URL copied to clipboard';
          }
        } catch {
          copyButton.textContent = 'Copy failed';
          if (copyStatus) {
            copyStatus.textContent =
              'Failed to copy URL. Please copy manually.';
          }
        }

        setTimeout(() => {
          copyButton.textContent = originalText;
          if (copyStatus) {
            copyStatus.textContent = '';
          }
        }, 2000);
      }
    });

    // Global registry for programmatic control
    if (!win.__cometShareOverlayRegistry) {
      win.__cometShareOverlayRegistry = new Map();
    }

    win.__cometShareOverlayRegistry.set(root.id, {
      open: () => setOpenState(true),
      close: () => setOpenState(false),
      toggle: () => setOpenState(root.getAttribute('data-open') !== 'true'),
    });

    // Initialize state
    if (root.getAttribute('data-open') === 'true') {
      setOpenState(true);
    }
  })();
</script>
