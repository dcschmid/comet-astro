---
import { cn } from '../utils/cn';

interface Props {
  /** Visual variant of the prose container */
  variant?: 'default' | 'minimal' | 'bordered' | 'elevated' | 'article';
  /** Typography size scale */
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl' | '2xl';
  /** Color scheme variant */
  theme?: 'default' | 'invert' | 'muted' | 'high-contrast';
  /** Maximum width constraint */
  maxWidth?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | 'full' | 'none';
  /** Enable reading mode optimizations */
  readingMode?: boolean;
  /** HTML content to render (alternative to slot) */
  html?: string;
  /** Disable automatic text processing */
  raw?: boolean;
  /** Custom aria-label for accessibility */
  ariaLabel?: string;
  /** ID of element that describes the prose content */
  ariaDescribedBy?: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  variant = 'default',
  size = 'lg',
  theme = 'default',
  maxWidth = 'lg',
  readingMode = false,
  html = undefined,
  raw = false,
  ariaLabel,
  ariaDescribedBy,
  class: className = '',
} = Astro.props;

// Sanitize HTML content
let sanitizedHtml = html;
if (typeof html === 'string' && !raw) {
  sanitizedHtml = html
    .replace(/\\n/g, '\n')
    .replace(/\n?\s*```\s*$/m, '')
    .replace(/```/g, '')
    .replace(/\\`/g, '')
    .replace(/&#96;|&#x60;|&grave;/g, '')
    .trim();
}

// Base prose size classes
const sizeClasses = {
  xs: 'prose-sm',
  sm: 'prose-sm',
  md: 'prose',
  lg: 'prose-lg',
  xl: 'prose-xl',
  '2xl': 'prose-2xl',
};

// Max width constraints
const maxWidthClasses = {
  sm: 'max-w-sm',
  md: 'max-w-md',
  lg: 'max-w-3xl',
  xl: 'max-w-4xl',
  '2xl': 'max-w-6xl',
  full: 'max-w-full',
  none: 'max-w-none',
};

// Variant styles
const variantClasses = {
  default: '',
  minimal:
    'prose-headings:font-medium prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg',
  bordered: 'border border-gray-200 dark:border-gray-700 rounded-lg p-6',
  elevated:
    'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm',
  article:
    'prose-headings:scroll-mt-20 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-h4:text-lg',
};

// Theme color schemes with WCAG AAA compliance
const themeClasses = {
  default: cn(
    // Base text colors with 7:1+ contrast ratios
    'text-gray-900 dark:text-gray-100',
    // Headings with enhanced contrast
    'prose-headings:text-gray-900 dark:prose-headings:text-gray-100',
    // Paragraph text with optimal contrast
    'prose-p:text-gray-800 dark:prose-p:text-gray-200',
    // Strong/bold text
    'prose-strong:text-gray-900 dark:prose-strong:text-gray-100',
    // Code styling with sufficient contrast
    'prose-code:text-blue-800 dark:prose-code:text-blue-200',
    'prose-code:bg-blue-50 dark:prose-code:bg-blue-900/30',
    'prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:font-mono prose-code:text-sm',
    // Links with enhanced accessibility (WCAG AAA intent)
    // Light: use a deep blue for strong contrast on white backgrounds
    'prose-a:text-blue-900',
    'prose-a:no-underline prose-a:font-medium',
    // Dark: use a light blue that remains readable on dark backgrounds
    'dark:prose-a:text-blue-200',
    'hover:prose-a:text-blue-800',
    'dark:hover:prose-a:text-blue-100',
    'hover:prose-a:underline',
    // Blockquotes
    'prose-blockquote:text-gray-700 dark:prose-blockquote:text-gray-300',
    'prose-blockquote:border-gray-300 dark:prose-blockquote:border-gray-600',
    'prose-blockquote:bg-gray-50 dark:prose-blockquote:bg-gray-800/50',
    'prose-blockquote:py-2 prose-blockquote:px-4 prose-blockquote:rounded-r-md',
    // Lists
    'prose-ul:text-gray-800 dark:prose-ul:text-gray-200',
    'prose-ol:text-gray-800 dark:prose-ol:text-gray-200',
    'prose-li:text-gray-800 dark:prose-li:text-gray-200',
    // Images and media
    'prose-img:rounded-lg prose-img:shadow-sm',
    'prose-img:border prose-img:border-gray-200 dark:prose-img:border-gray-700',
    // Horizontal rules
    'prose-hr:border-gray-300 dark:prose-hr:border-gray-600',
    // Tables
    'prose-table:border-collapse prose-table:border prose-table:border-gray-300 dark:prose-table:border-gray-600',
    'prose-th:bg-gray-50 dark:prose-th:bg-gray-800 prose-th:text-gray-900 dark:prose-th:text-gray-100',
    'prose-td:text-gray-800 dark:prose-td:text-gray-200',
    'prose-th:border prose-th:border-gray-300 dark:prose-th:border-gray-600',
    'prose-td:border prose-td:border-gray-300 dark:prose-td:border-gray-600'
  ),

  invert: cn(
    'text-gray-100',
    'prose-headings:text-gray-100',
    'prose-p:text-gray-200',
    'prose-strong:text-gray-100',
    'prose-code:text-blue-200 prose-code:bg-blue-900/40',
    'prose-a:text-blue-300 hover:prose-a:text-blue-200',
    'prose-blockquote:text-gray-300 prose-blockquote:border-gray-500',
    'prose-hr:border-gray-500'
  ),

  muted: cn(
    'text-gray-600 dark:text-gray-400',
    'prose-headings:text-gray-700 dark:prose-headings:text-gray-300',
    'prose-p:text-gray-600 dark:prose-p:text-gray-400',
    'prose-strong:text-gray-700 dark:prose-strong:text-gray-300',
    'prose-code:text-gray-700 dark:prose-code:text-gray-300',
    'prose-a:text-blue-600 dark:prose-a:text-blue-400',
    'hover:prose-a:text-blue-700 dark:hover:prose-a:text-blue-300'
  ),

  'high-contrast': cn(
    'text-black dark:text-white',
    'prose-headings:text-black dark:prose-headings:text-white',
    'prose-p:text-black dark:prose-p:text-white',
    'prose-strong:text-black dark:prose-strong:text-white',
    'prose-code:text-black dark:prose-code:text-white',
    'prose-code:bg-yellow-200 dark:prose-code:bg-yellow-800',
    'prose-a:text-blue-800 dark:prose-a:text-blue-200',
    'prose-a:underline prose-a:decoration-2',
    'hover:prose-a:decoration-4'
  ),
};

// Reading mode optimizations
const readingModeClasses = readingMode
  ? cn(
      'prose-headings:leading-tight',
      'prose-p:leading-relaxed prose-p:mb-6',
      'prose-li:leading-relaxed',
      'prose-blockquote:leading-relaxed',
      'tracking-wide',
      'selection:bg-blue-100 dark:selection:bg-blue-900'
    )
  : '';

const proseClasses = cn(
  'prose',
  sizeClasses[size],
  maxWidthClasses[maxWidth],
  variantClasses[variant],
  themeClasses[theme],
  readingModeClasses,
  // Focus management for accessibility
  'focus-within:outline-none',
  // Smooth scrolling for anchor links
  'scroll-smooth',
  className
);
---

<article
  class={proseClasses}
  role="article"
  aria-label={ariaLabel}
  aria-describedby={ariaDescribedBy}
>
  {sanitizedHtml ? <div set:html={sanitizedHtml} /> : <slot />}
</article>
