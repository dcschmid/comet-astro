---
interface Command {
  id: string;
  label: string;
  description?: string;
  icon?: string;
  action?: string;
  keywords?: string[];
}

interface Props {
  commands?: Command[];
  placeholder?: string;
  shortcut?: string;
  className?: string;
}

const {
  commands = [],
  placeholder = 'Search commands...',
  shortcut = 'Ctrl+K',
  className = '',
} = Astro.props as Props & Record<string, any>;
---

<div
  class="fixed inset-0 z-50 flex items-start justify-center bg-black/60 pt-16 backdrop-blur-sm transition duration-200 ease-out invisible opacity-0"
  data-command-menu
  aria-hidden="true"
>
  <div
    class={`w-full max-w-xl mx-4 overflow-hidden rounded-2xl border border-slate-300 bg-white text-slate-900 shadow-2xl ring-1 ring-black/10 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 ${className}`}
    role="dialog"
    aria-modal="true"
    aria-label="Command menu"
  >
    <div class="relative px-4 py-3">
      <label for="comet-cmd-input" class="sr-only">{placeholder}</label>
      <input
        id="comet-cmd-input"
        type="text"
        placeholder={placeholder}
        class="w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm font-semibold text-slate-900 placeholder-slate-500 shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-600 focus-visible:ring-offset-white dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100 dark:placeholder-slate-500 dark:focus-visible:ring-blue-400 dark:focus-visible:ring-offset-slate-950"
        data-command-input
        role="combobox"
        aria-expanded="false"
        aria-autocomplete="list"
        aria-haspopup="listbox"
        aria-controls="comet-cmd-list"
      />
      <div
        class="absolute right-4 top-3.5 hidden gap-1 rounded-md border border-slate-300 bg-white px-2 py-1 text-[10px] font-semibold text-slate-600 sm:inline-flex dark:border-slate-600 dark:bg-slate-900 dark:text-slate-300"
      >
        <span class="text-xs">{shortcut}</span>
        <span class="opacity-60">Esc</span>
      </div>
    </div>

    <div
      id="comet-cmd-list"
      class="max-h-80 overflow-y-auto px-2 py-3"
      data-command-list
      role="listbox"
      aria-label="Available commands"
    >
      {
        commands?.length ? (
          commands.map((cmd, i) => (
            <button
              type="button"
              data-command-item
              data-command-id={cmd.id}
              data-command-action={cmd.action}
              data-command-keywords={cmd.keywords?.join(' ')}
              role="option"
              aria-selected="false"
              tabindex={i === 0 ? 0 : -1}
              class="group flex w-full items-start gap-3 rounded-lg px-3 py-2 text-left transition-colors bg-transparent hover:bg-sky-50 focus-visible:bg-sky-100 focus-visible:outline-none dark:hover:bg-sky-800/30 dark:focus-visible:bg-sky-800/30"
            >
              {cmd.icon && (
                <span
                  class="shrink-0 text-lg text-sky-600 dark:text-sky-300"
                  aria-hidden
                >
                  {cmd.icon}
                </span>
              )}
              <div class="flex-1">
                <div class="text-sm font-semibold text-slate-900 dark:text-slate-100">
                  {cmd.label}
                </div>
                {cmd.description && (
                  <p class="mt-0.5 text-xs text-slate-600 dark:text-slate-300">
                    {cmd.description}
                  </p>
                )}
              </div>
            </button>
          ))
        ) : (
          <div class="px-3 py-6 text-sm text-slate-600 dark:text-slate-400">
            No commands available
          </div>
        )
      }
    </div>

    <div
      class="border-t border-slate-200 bg-slate-50 px-4 py-2 text-xs font-medium text-slate-600 dark:border-slate-800 dark:bg-slate-900/60 dark:text-slate-400"
    >
      Press {shortcut} or Esc to close
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    const menu = document.querySelector('[data-command-menu]');
    if (!(menu instanceof HTMLElement)) return;
    const dialog = menu.querySelector('[role="dialog"]');
    const input = menu.querySelector('[data-command-input]');
    const list = menu.querySelector('[data-command-list]');
    if (!dialog || !input || !list) return;

    const getItems = () =>
      Array.from(list.querySelectorAll('[data-command-item]')).filter(
        function (el) {
          return el instanceof HTMLElement;
        }
      );
    const getVisibleItems = function () {
      return getItems().filter(function (item) {
        return !item.classList.contains('hidden');
      });
    };

    var activeIndex = -1;
    var isOpen = false;
    var lastFocused = null;

    var setAriaSelected = function (item, selected) {
      item.setAttribute('aria-selected', selected ? 'true' : 'false');
      item.tabIndex = selected ? 0 : -1;
      item.classList.toggle('ring-2', selected);
      item.classList.toggle('ring-sky-500', selected);
    };

    var resetActive = function () {
      getItems().forEach(function (item) {
        setAriaSelected(item, false);
      });
      activeIndex = -1;
    };

    var focusItem = function (index) {
      var visible = getVisibleItems();
      if (!visible.length) return;
      var clamped = Math.max(0, Math.min(index, visible.length - 1));
      visible.forEach(function (item, idx) {
        setAriaSelected(item, idx === clamped);
      });
      visible[clamped].focus({ preventScroll: true });
      activeIndex = clamped;
    };

    var filterCommands = function (query) {
      var normalized = (query || '').trim().toLowerCase();
      getItems().forEach(function (item) {
        var labelEl = item.querySelector('.text-sm');
        var label =
          labelEl && labelEl.textContent
            ? labelEl.textContent.toLowerCase()
            : '';
        var keywords = (
          item.getAttribute('data-command-keywords') || ''
        ).toLowerCase();
        var matches =
          !normalized ||
          label.indexOf(normalized) !== -1 ||
          keywords.indexOf(normalized) !== -1;
        item.classList.toggle('hidden', !matches);
      });
      resetActive();
      var visible = getVisibleItems();
      if (visible.length) visible[0].tabIndex = 0;
    };

    var open = function () {
      if (isOpen) return;
      isOpen = true;
      lastFocused =
        document.activeElement instanceof HTMLElement
          ? document.activeElement
          : null;
      menu.classList.remove('invisible');
      requestAnimationFrame(function () {
        menu.classList.remove('opacity-0');
      });
      menu.setAttribute('aria-hidden', 'false');
      input.setAttribute('aria-expanded', 'true');
      document.body.style.setProperty('overflow', 'hidden');
      setTimeout(function () {
        input.focus({ preventScroll: true });
      }, 20);
    };

    var close = function () {
      if (!isOpen) return;
      isOpen = false;
      menu.classList.add('opacity-0');
      menu.setAttribute('aria-hidden', 'true');
      input.setAttribute('aria-expanded', 'false');
      input.value = '';
      filterCommands('');
      document.body.style.removeProperty('overflow');
      setTimeout(function () {
        menu.classList.add('invisible');
      }, 150);
      if (lastFocused && typeof lastFocused.focus === 'function')
        lastFocused.focus({ preventScroll: true });
    };

    input.addEventListener('input', function () {
      filterCommands(input.value);
    });

    input.addEventListener('keydown', function (event) {
      var visible = getVisibleItems();
      if (!visible.length) return;
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        focusItem(0);
      } else if (event.key === 'Escape') {
        close();
      }
    });

    list.addEventListener('keydown', function (event) {
      var visible = getVisibleItems();
      if (!visible.length) return;
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        focusItem(activeIndex + 1);
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        focusItem(activeIndex - 1);
      } else if (event.key === 'Home') {
        event.preventDefault();
        focusItem(0);
      } else if (event.key === 'End') {
        event.preventDefault();
        focusItem(visible.length - 1);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        close();
      } else if (event.key === 'Enter') {
        event.preventDefault();
        var current = visible[activeIndex];
        if (current && typeof current.click === 'function') current.click();
      }
    });

    list.addEventListener('click', function (event) {
      var el = event.target;
      var item =
        el instanceof HTMLElement ? el.closest('[data-command-item]') : null;
      if (!(item instanceof HTMLElement)) return;
      var action = item.getAttribute('data-command-action');
      if (action) window.location.assign(action);
      close();
    });

    menu.addEventListener('click', function (event) {
      if (event.target === menu) close();
    });

    document.addEventListener('keydown', function (event) {
      if (
        (event.ctrlKey || event.metaKey) &&
        event.key &&
        event.key.toLowerCase() === 'k'
      ) {
        event.preventDefault();
        open();
      } else if (event.key === 'Escape') {
        close();
      }
    });

    filterCommands('');
  })();
</script>
