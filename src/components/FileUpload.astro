---
/**
 * FileUpload - accessible drag & drop upload area with WCAG AAA compliance
 */
interface Props {
  label?: string;
  description?: string;
  accept?: string;
  multiple?: boolean;
  maxFileSizeMb?: number;
  showFileList?: boolean;
  helpText?: string;
  className?: string;
  inputName?: string;
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'compact';
  ariaLabel?: string;
  ariaDescribedby?: string;
}

const {
  label = 'Upload files',
  description = 'Drag & drop files here, or click to browse.',
  accept = '',
  multiple = true,
  maxFileSizeMb = 10,
  showFileList = true,
  helpText = '',
  className = '',
  inputName,
  size = 'md',
  variant = 'default',
  ariaLabel,
  ariaDescribedby,
} = Astro.props as Props;

const sizeClasses = {
  sm: {
    container: 'p-6',
    icon: 'h-10 w-10 text-lg',
    title: 'text-base',
    description: 'text-sm',
  },
  md: {
    container: 'p-8',
    icon: 'h-12 w-12 text-xl',
    title: 'text-lg',
    description: 'text-sm',
  },
  lg: {
    container: 'p-10',
    icon: 'h-14 w-14 text-2xl',
    title: 'text-xl',
    description: 'text-base',
  },
};

const variantClasses = {
  default: 'rounded-2xl',
  compact: 'rounded-lg',
};

const id = `file-upload-${Math.random().toString(36).slice(2, 10)}`;
const descriptionId = `${id}-description`;
const helpId = helpText ? `${id}-help` : undefined;
const errorId = `${id}-error`;
---

<div
  id={id}
  data-file-upload
  data-multiple={multiple}
  data-max-size={maxFileSizeMb}
  data-show-list={showFileList}
  class={`space-y-4 ${className}`}
  aria-live="polite"
  aria-label={ariaLabel}
  aria-describedby={ariaDescribedby}
>
  <label
    data-file-dropzone
    class={`relative flex cursor-pointer flex-col items-center justify-center ${variantClasses[variant]} border-2 border-dashed border-slate-300/90 bg-slate-50 ${sizeClasses[size].container} text-center transition-colors duration-200 hover:border-blue-600 hover:bg-white focus-within:border-blue-600 focus-within:ring-4 focus-within:ring-blue-600 focus-within:ring-offset-2 focus-within:ring-offset-white dark:border-slate-600/90 dark:bg-slate-800 dark:hover:border-blue-400 dark:hover:bg-slate-700 dark:focus-within:ring-blue-400 dark:focus-within:ring-offset-slate-800`}
    aria-describedby={`${descriptionId}${helpId ? ` ${helpId}` : ''}`}
    data-base-describedby={`${descriptionId}${helpId ? ` ${helpId}` : ''}`}
  >
    <input
      type="file"
      class="absolute inset-0 h-full w-full cursor-pointer opacity-0"
      accept={accept}
      multiple={multiple}
      name={inputName}
      data-file-input
      aria-describedby={`${descriptionId}${helpId ? ` ${helpId}` : ''}`}
    />
    <div
      class="pointer-events-none flex flex-col items-center gap-4 text-slate-800 dark:text-slate-200"
    >
      <div
        class={`flex ${sizeClasses[size].icon} items-center justify-center rounded-full bg-blue-100 ${sizeClasses[size].icon.includes('text-') ? '' : 'text-xl'} text-blue-700 shadow-sm dark:bg-blue-500/20 dark:text-blue-300`}
        aria-hidden="true"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          aria-hidden="true"
        >
          <path
            d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
      <div class="text-slate-800 dark:text-slate-200">
        <p
          class={`${sizeClasses[size].title} font-semibold text-slate-900 dark:text-slate-100`}
        >
          {label}
        </p>
        <p
          class={`mt-2 ${sizeClasses[size].description} text-slate-700 dark:text-slate-300`}
          id={descriptionId}
        >
          {description}
        </p>
        {
          maxFileSizeMb && (
            <p class="mt-3 text-xs font-medium uppercase tracking-wide text-slate-600 dark:text-slate-400">
              Max size {maxFileSizeMb} MB
            </p>
          )
        }
      </div>
    </div>
  </label>

  {
    helpText && (
      <p class="text-sm text-slate-700 dark:text-slate-300" id={helpId}>
        {helpText}
      </p>
    )
  }

  <div
    class="hidden rounded-xl border-2 border-slate-300/90 bg-slate-50 p-4 text-sm text-slate-800 dark:border-slate-600/90 dark:bg-slate-800 dark:text-slate-200"
    data-file-empty
  >
    No files selected yet.
  </div>

  <ul
    class="divide-y divide-slate-300/90 overflow-hidden rounded-xl border-2 border-slate-300/90 bg-white text-slate-900 shadow-sm dark:divide-slate-600/90 dark:border-slate-600/90 dark:bg-slate-800 dark:text-slate-100"
    data-file-list
    hidden={!showFileList}
    role="list"
  >
  </ul>

  <p
    class="hidden text-sm font-medium text-red-700 dark:text-red-300"
    data-file-error
    id={errorId}
    role="alert"
  >
  </p>
</div>

<script is:inline>
  (function setupFileUpload() {
    const root = document.getElementById('${id}');
    if (!(root instanceof HTMLElement)) return;

    const input = root.querySelector('[data-file-input]');
    if (!(input instanceof HTMLInputElement)) return;

    const dropzone = root.querySelector('[data-file-dropzone]');
    const fileList = root.querySelector('[data-file-list]');
    const emptyState = root.querySelector('[data-file-empty]');
    const errorEl = root.querySelector('[data-file-error]');

    const maxSizeMb = Number.parseFloat(root.dataset.maxSize || '0');
    const showList = root.dataset.showList === 'true';
    const allowMultiple = root.dataset.multiple !== 'false';
    const errorIdentifier =
      errorEl instanceof HTMLElement ? errorEl.id || '' : '';

    const formatBytes = (bytes) => {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      const power = Math.min(
        units.length - 1,
        Math.floor(Math.log(bytes) / Math.log(1024))
      );
      return `${(bytes / Math.pow(1024, power)).toFixed(power === 0 ? 0 : 1)} ${units[power]}`;
    };

    const escapeHTML = (value) =>
      String(value).replace(/[&<>"']/g, (char) => {
        switch (char) {
          case '&':
            return '&amp;';
          case '<':
            return '&lt;';
          case '>':
            return '&gt;';
          case '"':
            return '&quot;';
          case "'":
            return '&#39;';
          default:
            return char;
        }
      });

    const renderList = (files) => {
      if (!(fileList instanceof HTMLElement)) return;
      if (files.length === 0) {
        fileList.innerHTML = '';
        fileList.hidden = !showList;
        if (emptyState instanceof HTMLElement)
          emptyState.classList.remove('hidden');
        return;
      }

      fileList.hidden = !showList;
      fileList.innerHTML = files
        .map(
          (file, index) => `
            <li class="flex items-center justify-between gap-4 px-4 py-4 text-sm text-slate-900 dark:text-slate-100">
              <div class="min-w-0 flex-1">
                <p class="truncate font-semibold text-slate-900 dark:text-slate-100">${escapeHTML(file.name)}</p>
                <p class="text-xs font-medium text-slate-600 dark:text-slate-400">${formatBytes(file.size)}</p>
              </div>
              <button type="button" class="inline-flex items-center gap-2 rounded-lg border-2 border-red-300/90 bg-red-50 px-3 py-2 text-xs font-semibold text-red-800 transition-colors duration-200 hover:border-red-400 hover:bg-red-100 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-red-600 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:border-red-600/90 dark:bg-red-500/10 dark:text-red-300 dark:hover:bg-red-500/20 dark:hover:border-red-500 dark:focus-visible:ring-red-400 dark:focus-visible:ring-offset-slate-800" data-file-remove="${index}" aria-label="Remove ${escapeHTML(file.name)}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Remove</span>
              </button>
            </li>
          `
        )
        .join('');
      if (emptyState instanceof HTMLElement) emptyState.classList.add('hidden');
    };

    let selectedFiles = [];

    const emitChange = () => {
      root.dispatchEvent(
        new CustomEvent('file-upload:change', {
          bubbles: true,
          detail: { files: selectedFiles.slice(), input },
        })
      );
    };

    const baseDescribedBy =
      dropzone instanceof HTMLElement
        ? dropzone.getAttribute('data-base-describedby') || ''
        : '';
    const setDescribedBy = (hasError) => {
      if (!(dropzone instanceof HTMLElement)) return;
      const ids = [
        baseDescribedBy.trim(),
        hasError ? errorIdentifier : null,
      ].filter(Boolean);
      if (ids.length > 0) {
        dropzone.setAttribute('aria-describedby', ids.join(' '));
      } else {
        dropzone.removeAttribute('aria-describedby');
      }
    };

    const setError = (message) => {
      if (!(errorEl instanceof HTMLElement)) return;
      if (!message) {
        errorEl.textContent = '';
        errorEl.classList.add('hidden');
        errorEl.setAttribute('aria-hidden', 'true');
        setDescribedBy(false);
      } else {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        errorEl.setAttribute('aria-hidden', 'false');
        setDescribedBy(true);
      }
    };

    const handleFiles = (files) => {
      const incoming = Array.from(files);
      const maxSize = maxSizeMb > 0 ? maxSizeMb * 1024 * 1024 : Infinity;
      const filtered = [];
      let rejected = 0;

      incoming.forEach((file) => {
        if (file.size > maxSize) {
          rejected += 1;
          return;
        }
        filtered.push(file);
      });

      if (!allowMultiple) {
        selectedFiles = filtered.slice(0, 1);
      } else {
        selectedFiles = selectedFiles.concat(filtered);
      }

      renderList(selectedFiles);
      emitChange();

      if (rejected > 0) {
        setError(
          `Skipped ${rejected} file${rejected === 1 ? '' : 's'} exceeding ${maxSizeMb} MB.`
        );
      } else {
        setError(null);
      }
    };

    input.addEventListener('change', () => {
      if (!input.files) return;
      selectedFiles = [];
      handleFiles(input.files);
    });

    if (dropzone instanceof HTMLElement) {
      dropzone.addEventListener('dragenter', (event) => {
        event.preventDefault();
        dropzone.classList.add(
          'border-blue-600',
          'bg-blue-50',
          'dark:bg-slate-700',
          'dark:border-blue-400'
        );
      });

      dropzone.addEventListener('dragover', (event) => {
        event.preventDefault();
      });

      dropzone.addEventListener('dragleave', (event) => {
        if (event.target === dropzone) {
          dropzone.classList.remove(
            'border-blue-600',
            'bg-blue-50',
            'dark:bg-slate-700',
            'dark:border-blue-400'
          );
        }
      });

      dropzone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropzone.classList.remove(
          'border-blue-600',
          'bg-blue-50',
          'dark:bg-slate-700',
          'dark:border-blue-400'
        );
        const dt = event.dataTransfer;
        if (!dt || !dt.files || dt.files.length === 0) return;
        selectedFiles = [];
        handleFiles(dt.files);
        input.files = dt.files;
      });
    }

    if (fileList instanceof HTMLElement) {
      fileList.addEventListener('click', (event) => {
        const target =
          event.target instanceof HTMLElement ? event.target : null;
        if (!target) return;
        const indexAttr = target.getAttribute('data-file-remove');
        if (!indexAttr) return;
        const index = Number.parseInt(indexAttr, 10);
        if (Number.isNaN(index)) return;
        selectedFiles.splice(index, 1);
        renderList(selectedFiles);
        emitChange();
        if (selectedFiles.length === 0 && emptyState instanceof HTMLElement) {
          emptyState.classList.remove('hidden');
        }
      });
    }

    root.addEventListener('file-upload:clear', () => {
      selectedFiles = [];
      renderList(selectedFiles);
      input.value = '';
      emitChange();
    });

    root.addEventListener('file-upload:set-error', (event) => {
      const detail = event && 'detail' in event ? event.detail : null;
      setError(
        detail && typeof detail.message === 'string' ? detail.message : null
      );
    });

    if (emptyState instanceof HTMLElement) {
      emptyState.classList.toggle('hidden', selectedFiles.length > 0);
    }
    setDescribedBy(false);
    renderList(selectedFiles);
  })();
</script>
