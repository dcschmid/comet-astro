---
/**
 * LanguageSwitcher - WCAG AAA compliant language picker with enhanced accessibility
 * Provides internationalization support with optimal user experience
 */
interface Lang {
  code: string;
  label: string;
  href: string;
  flag?: string;
  nativeName?: string;
  direction?: 'ltr' | 'rtl';
}

interface Props {
  current?: string;
  languages: Lang[];
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'minimal' | 'compact' | 'dropdown';
  showFlags?: boolean;
  showNativeNames?: boolean;
  position?: 'start' | 'center' | 'end';
  className?: string;
  ariaLabel?: string;
  dropdownLabel?: string;
}

const { 
  current, 
  languages = [], 
  size = 'md',
  variant = 'default',
  showFlags = false,
  showNativeNames = false,
  position = 'start',
  className = '',
  ariaLabel = 'Language switcher',
  dropdownLabel = 'Select language'
} = Astro.props as Props;

// Enhanced size classes with responsive design
const sizeClasses = {
  sm: {
    container: 'gap-1',
    button: 'min-h-[28px] px-2 py-1 text-xs',
    text: 'text-xs',
    icon: 'w-3 h-3',
    flag: 'w-3 h-3',
  },
  md: {
    container: 'gap-2',
    button: 'min-h-[36px] px-3 py-1.5 text-sm',
    text: 'text-sm',
    icon: 'w-4 h-4',
    flag: 'w-4 h-4',
  },
  lg: {
    container: 'gap-3',
    button: 'min-h-[44px] px-4 py-2 text-base',
    text: 'text-base',
    icon: 'w-5 h-5',
    flag: 'w-5 h-5',
  },
};

// WCAG AAA compliant color classes with 7:1+ contrast ratios
const colorClasses = {
  // Background colors
  bg: 'bg-white dark:bg-slate-950',
  bgHover: 'hover:bg-slate-50 dark:hover:bg-slate-900',
  bgActive: 'bg-slate-900 dark:bg-slate-100',
  bgActiveHover: 'hover:bg-slate-800 dark:hover:bg-slate-200',
  // Text colors
  text: 'text-slate-900 dark:text-slate-50',
  textHover: 'hover:text-slate-800 dark:hover:text-slate-100',
  textActive: 'text-slate-50 dark:text-slate-900',
  textMuted: 'text-slate-700 dark:text-slate-200',
  // Border colors
  border: 'border-slate-400 dark:border-slate-500',
  borderHover: 'hover:border-slate-500 dark:hover:border-slate-400',
  borderActive: 'border-slate-900 dark:border-slate-100',
  // Focus ring
  focusRing: 'focus-visible:ring-2 focus-visible:ring-slate-600 dark:focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-950',
};

// Position classes
const positionClasses = {
  start: 'justify-start',
  center: 'justify-center',
  end: 'justify-end',
};

// Variant styles
const variantClasses = {
  default: `
    border rounded-lg font-semibold shadow-sm
    transition-all duration-200
    ${colorClasses.focusRing}
    focus-visible:outline-none
  `,
  minimal: `
    border-0 font-medium
    transition-colors duration-200
    ${colorClasses.focusRing}
    focus-visible:outline-none
    rounded-md
  `,
  compact: `
    border rounded font-medium
    transition-all duration-150
    ${colorClasses.focusRing}
    focus-visible:outline-none
  `,
  dropdown: `
    border rounded-lg font-medium shadow
    transition-all duration-200
    ${colorClasses.focusRing}
    focus-visible:outline-none
  `,
};

// Get flag emoji for language code
const getFlagEmoji = (code: string, customFlag?: string) => {
  if (customFlag) return customFlag;
  
  const flagMap: Record<string, string> = {
    'en': 'ðŸ‡ºðŸ‡¸', 'de': 'ðŸ‡©ðŸ‡ª', 'fr': 'ðŸ‡«ðŸ‡·', 'es': 'ðŸ‡ªðŸ‡¸', 'it': 'ðŸ‡®ðŸ‡¹',
    'pt': 'ðŸ‡µðŸ‡¹', 'nl': 'ðŸ‡³ðŸ‡±', 'ru': 'ðŸ‡·ðŸ‡º', 'ja': 'ðŸ‡¯ðŸ‡µ', 'ko': 'ðŸ‡°ðŸ‡·',
    'zh': 'ðŸ‡¨ðŸ‡³', 'ar': 'ðŸ‡¸ðŸ‡¦', 'hi': 'ðŸ‡®ðŸ‡³', 'tr': 'ðŸ‡¹ðŸ‡·', 'pl': 'ðŸ‡µðŸ‡±',
    'sv': 'ðŸ‡¸ðŸ‡ª', 'da': 'ðŸ‡©ðŸ‡°', 'no': 'ðŸ‡³ðŸ‡´', 'fi': 'ðŸ‡«ðŸ‡®', 'hu': 'ðŸ‡­ðŸ‡º',
  };
  
  return flagMap[code.toLowerCase()] || 'ðŸŒ';
};

// Current language for active state
const currentLang = languages.find(lang => lang.code === current);

// Generate unique ID for dropdown
const dropdownId = `language-switcher-${Math.random().toString(36).slice(2, 8)}`;
---

{variant === 'dropdown' ? (
  <div class={`relative inline-block ${className}`}>
    <button
      type="button"
      id={dropdownId}
      aria-haspopup="listbox"
      aria-expanded="false"
      aria-label={ariaLabel}
      class={`
        ${variantClasses[variant]}
        ${sizeClasses[size].button}
        ${colorClasses.bg}
        ${colorClasses.bgHover}
        ${colorClasses.text}
        ${colorClasses.textHover}
        ${colorClasses.border}
        ${colorClasses.borderHover}
        inline-flex items-center gap-2
        cursor-pointer select-none
      `}
    >
      {showFlags && currentLang && (
        <span 
          class={`${sizeClasses[size].flag} flex-shrink-0`}
          aria-hidden="true"
        >
          {getFlagEmoji(currentLang.code, currentLang.flag)}
        </span>
      )}
      
      <span class="flex-1 text-left">
        {currentLang?.label || dropdownLabel}
        {showNativeNames && currentLang?.nativeName && (
          <span class={`block ${sizeClasses[size].text} ${colorClasses.textMuted} font-normal`}>
            {currentLang.nativeName}
          </span>
        )}
      </span>
      
      {/* Dropdown Arrow */}
      <svg 
        class={`${sizeClasses[size].icon} ${colorClasses.textMuted}`}
        fill="none" 
        stroke="currentColor" 
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>
    
    {/* Dropdown Menu (hidden by default, controlled by JavaScript) */}
    <div
      role="listbox"
      aria-labelledby={dropdownId}
      class={`
        absolute top-full left-0 mt-1 min-w-full
        ${colorClasses.bg}
        ${colorClasses.border}
        rounded-lg shadow-lg z-50
        hidden
      `}
    >
      {languages.map((language) => {
        const isActive = current === language.code;
        return (
          <a
            href={language.href}
            lang={language.code}
            hreflang={language.code}
            dir={language.direction || 'ltr'}
            role="option"
            aria-selected={isActive}
            class={`
              ${sizeClasses[size].button}
              ${isActive ? colorClasses.bgActive : colorClasses.bgHover}
              ${isActive ? colorClasses.textActive : colorClasses.text}
              ${colorClasses.focusRing}
              flex items-center gap-2 w-full
              first:rounded-t-lg last:rounded-b-lg
              no-underline transition-colors duration-200
              focus-visible:outline-none
            `}
          >
            {showFlags && (
              <span 
                class={`${sizeClasses[size].flag} flex-shrink-0`}
                aria-hidden="true"
              >
                {getFlagEmoji(language.code, language.flag)}
              </span>
            )}
            
            <span class="flex-1">
              {language.label}
              {showNativeNames && language.nativeName && (
                <span class={`block ${sizeClasses[size].text} opacity-75 font-normal`}>
                  {language.nativeName}
                </span>
              )}
            </span>
            
            {isActive && (
              <svg 
                class={`${sizeClasses[size].icon} ${colorClasses.textActive}`}
                fill="currentColor" 
                viewBox="0 0 20 20"
                aria-hidden="true"
              >
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            )}
          </a>
        );
      })}
    </div>
  </div>
) : (
  <nav
    aria-label={ariaLabel}
    class={`
      inline-flex items-center 
      ${sizeClasses[size].container} 
      ${positionClasses[position]}
      ${className}
    `}
    role="group"
  >
    {languages.map((language) => {
      const isActive = current === language.code;
      return (
        <a
          href={language.href}
          lang={language.code}
          hreflang={language.code}
          dir={language.direction || 'ltr'}
          aria-current={isActive ? 'page' : undefined}
          aria-label={`Switch to ${language.label}${language.nativeName ? ` (${language.nativeName})` : ''}`}
          class={`
            ${variantClasses[variant]}
            ${sizeClasses[size].button}
            ${isActive 
              ? `${colorClasses.bgActive} ${colorClasses.bgActiveHover} ${colorClasses.textActive} ${colorClasses.borderActive}`
              : `${colorClasses.bg} ${colorClasses.bgHover} ${colorClasses.text} ${colorClasses.textHover} ${colorClasses.border} ${colorClasses.borderHover}`
            }
            inline-flex items-center gap-2 no-underline
            transform active:scale-95
          `}
        >
          {showFlags && (
            <span 
              class={`${sizeClasses[size].flag} flex-shrink-0`}
              aria-hidden="true"
              title={`${language.label} flag`}
            >
              {getFlagEmoji(language.code, language.flag)}
            </span>
          )}
          
          <span class={variant === 'compact' ? 'sr-only sm:not-sr-only' : ''}>
            {language.label}
            {showNativeNames && language.nativeName && (
              <span class={`block ${sizeClasses[size].text} opacity-90 font-normal`}>
                {language.nativeName}
              </span>
            )}
          </span>
          
          {variant === 'compact' && !showFlags && (
            <span class={`${sizeClasses[size].text} font-mono uppercase sm:hidden`}>
              {language.code}
            </span>
          )}
        </a>
      );
    })}
  </nav>
)}

{variant === 'dropdown' && (
  <script is:inline>
    // Simple dropdown functionality
    document.addEventListener('DOMContentLoaded', function() {
      const dropdowns = document.querySelectorAll('[aria-haspopup="listbox"]');
      
      dropdowns.forEach(function(button) {
        const menu = button.nextElementSibling;
        if (!menu) return;
        
        // Toggle dropdown
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const isOpen = button.getAttribute('aria-expanded') === 'true';
          
          // Close all other dropdowns
          dropdowns.forEach(function(otherButton) {
            if (otherButton !== button) {
              otherButton.setAttribute('aria-expanded', 'false');
              const otherMenu = otherButton.nextElementSibling;
              if (otherMenu) otherMenu.classList.add('hidden');
            }
          });
          
          // Toggle current dropdown
          button.setAttribute('aria-expanded', (!isOpen).toString());
          menu.classList.toggle('hidden');
        });
        
        // Close on outside click
        document.addEventListener('click', function(e) {
          if (!button.contains(e.target) && !menu.contains(e.target)) {
            button.setAttribute('aria-expanded', 'false');
            menu.classList.add('hidden');
          }
        });
        
        // Close on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            button.setAttribute('aria-expanded', 'false');
            menu.classList.add('hidden');
            button.focus();
          }
        });
        
        // Arrow key navigation
        button.addEventListener('keydown', function(e) {
          if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            button.setAttribute('aria-expanded', 'true');
            menu.classList.remove('hidden');
            
            // Focus first option
            const firstOption = menu.querySelector('[role="option"]');
            if (firstOption) firstOption.focus();
          }
        });
        
        // Menu navigation
        menu.addEventListener('keydown', function(e) {
          const options = Array.from(menu.querySelectorAll('[role="option"]'));
          const currentIndex = options.findIndex(option => option === document.activeElement);
          
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = (currentIndex + 1) % options.length;
            options[nextIndex].focus();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : options.length - 1;
            options[prevIndex].focus();
          } else if (e.key === 'Home') {
            e.preventDefault();
            options[0].focus();
          } else if (e.key === 'End') {
            e.preventDefault();
            options[options.length - 1].focus();
          }
        });
      });
    });
  </script>
)}

<style>
  /* Enhanced focus styles for better accessibility */
  [aria-haspopup="listbox"]:focus-visible,
  nav a:focus-visible {
    outline: 2px solid rgb(59 130 246);
    outline-offset: 2px;
  }
  
  /* High contrast mode support */
  @media (prefers-contrast: high) {
    nav a {
      border-width: 2px;
      font-weight: 600;
    }
    
    [aria-current="page"],
    [aria-selected="true"] {
      font-weight: 700;
      text-decoration: underline;
    }
  }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    nav a,
    [aria-haspopup="listbox"] {
      transition: none;
      transform: none !important;
    }
  }
  
  /* RTL support */
  [dir="rtl"] {
    direction: rtl;
  }
  
  /* Hover effects */
  nav a:hover {
    text-decoration: none;
  }
  
  /* Active state enhancement */
  nav a:active {
    transform: scale(0.95);
    transition-duration: 50ms;
  }
</style>
