---
interface Props {
  name: string;
  label?: string;
  value?: string;
  checked?: boolean;
  indeterminate?: boolean;
  disabled?: boolean;
  required?: boolean;
  helperText?: string;
  error?: string;
  size?: 'sm' | 'md' | 'lg';
  ariaLabel?: string; // for icon-only / no visible label use
  className?: string;
  id?: string;
}

const {
  name,
  label,
  value,
  checked = false,
  indeterminate = false,
  disabled = false,
  required = false,
  helperText,
  error,
  size = 'md',
  ariaLabel,
  className = '',
  id = name + (value ? `-${value}` : ''),
} = Astro.props as Props;

// Size map (box + label spacing)
const sizeMap: Record<string, string> = {
  sm: 'h-4 w-4',
  md: 'h-5 w-5',
  lg: 'h-6 w-6',
};
const boxSize = sizeMap[size];

// Label typography & spacing per size
const labelSizeMap: Record<string, string> = {
  sm: 'text-xs leading-4',
  md: 'text-sm leading-5',
  lg: 'text-base leading-6',
};
const labelSize = labelSizeMap[size];

const gapSizeMap: Record<string, string> = {
  sm: 'gap-1.5',
  md: 'gap-2',
  lg: 'gap-2.5',
};
const gapSize = gapSizeMap[size];

// Compose classes ensuring AAA contrast for default (border slate-500 dark: slate-400) and checked (bg-blue-600 dark:bg-blue-500 + white check) states.
const baseBox =
  'rounded-sm border transition-colors duration-150 ease-out focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50 dark:focus-visible:ring-offset-slate-900';
const uncheckedBorder =
  'border-slate-500 dark:border-slate-400 bg-white dark:bg-slate-900';
const checkedClasses =
  'checked:bg-blue-600 dark:checked:bg-blue-500 checked:border-blue-600 dark:checked:border-blue-500';
const indeterminateClasses = indeterminate
  ? 'bg-blue-600 dark:bg-blue-500 border-blue-600 dark:border-blue-500'
  : '';
const errorClasses = error
  ? 'border-rose-600 dark:border-rose-500 focus-visible:ring-rose-600 dark:focus-visible:ring-rose-500'
  : '';
const disabledClasses = disabled
  ? 'opacity-60 cursor-not-allowed'
  : 'cursor-pointer';

// Helper/error description id
const descriptionId = error || helperText ? `${id}-desc` : undefined;

// We render native checkbox for a11y. Indeterminate set via script once (progressive enhancement)
const script = indeterminate
  ? `<script>document.getElementById('${id}')?.indeterminate = true;</script>`
  : '';
---

<div
  class={`flex items-start ${gapSize} text-slate-800 dark:text-slate-100 ${className}`}
>
  <input
    type="checkbox"
    id={id}
    name={name}
    value={value}
    checked={checked}
    disabled={disabled}
    required={required}
    aria-invalid={error ? 'true' : undefined}
    aria-describedby={descriptionId}
    aria-label={!label && ariaLabel ? ariaLabel : undefined}
    class={`${boxSize} ${baseBox} ${uncheckedBorder} ${checkedClasses} ${indeterminateClasses} ${errorClasses} ${disabledClasses} mt-0.5 appearance-none`}
  />
  {
    label && (
      <label
        for={id}
        class={`${labelSize} ${disabled ? 'opacity-50' : 'cursor-pointer'}`}
      >
        {label}
        {required && <span class="ml-1 text-rose-500">*</span>}
      </label>
    )
  }
  <div class="flex flex-col">
    {
      error && (
        <p
          id={descriptionId}
          class="mt-1 text-xs font-medium text-rose-600 dark:text-rose-500"
        >
          {error}
        </p>
      )
    }
    {
      !error && helperText && (
        <p
          id={descriptionId}
          class="mt-1 text-xs text-slate-600 dark:text-slate-300"
        >
          {helperText}
        </p>
      )
    }
  </div>
  {indeterminate && <Fragment set:html={script} />}
</div>
