---
import EmbedBase from './EmbedBase.astro';

/**
 * AppleMusicEmbed - WCAG AAA compliant Apple Music and Podcasts embed
 * Provides accessible Apple media integration with proper loading states and error handling
 */
interface Props {
  /** Apple Music or Podcasts URL */
  url: string;
  /** Type of Apple content */
  type?: 'song' | 'album' | 'playlist' | 'podcast' | 'episode' | 'auto';
  /** Visual theme variant */
  variant?: 'default' | 'minimal' | 'card';
  /** Show loading state */
  showLoading?: boolean;
  /** Accessible title for screen readers */
  title?: string;
  /** CSS class for styling */
  class?: string;
  /** Allow fullscreen playback */
  allowFullscreen?: boolean;
  /** ARIA label for accessibility */
  ariaLabel?: string;
  /** Additional iframe attributes */
  [key: string]: any;
}

const {
  url,
  type = 'auto',
  variant = 'default',
  showLoading = true,
  title,
  class: className = '',
  allowFullscreen = true,
  ariaLabel,
  ...props
} = Astro.props;

// Build Apple Music/Podcasts embed URL
const buildAppleEmbedUrl = (): string => {
  try {
    const target = new URL(url);

    // If already an embed URL, return as-is
    if (target.hostname.startsWith('embed.')) {
      return target.toString();
    }

    // Convert Apple Music URLs to embed format
    if (target.hostname.endsWith('music.apple.com')) {
      target.hostname = 'embed.music.apple.com';
      return target.toString();
    }

    // Convert Apple Podcasts URLs to embed format
    if (target.hostname.endsWith('podcasts.apple.com')) {
      target.hostname = 'embed.podcasts.apple.com';
      return target.toString();
    }

    // Return original URL if not a recognized Apple domain
    return target.toString();
  } catch (error) {
    console.warn('Failed to parse Apple URL:', error);
    return url;
  }
};

// Determine content type and appropriate aspect ratio
const getAppleContentType = (): string => {
  if (type !== 'auto') return type;

  try {
    const target = new URL(url);

    // Check for podcasts domain
    if (target.hostname.includes('podcasts.apple.com')) {
      return target.pathname.includes('/episode/') ? 'episode' : 'podcast';
    }

    // Check for music domain patterns
    if (target.hostname.includes('music.apple.com')) {
      const path = target.pathname;
      const hasTrackParam = target.searchParams.has('i');

      if (
        path.includes('/song/') ||
        path.includes('/track/') ||
        hasTrackParam
      ) {
        return 'song';
      }
      if (path.includes('/album/')) {
        return 'album';
      }
      if (path.includes('/playlist/')) {
        return 'playlist';
      }
    }

    return 'album'; // Default fallback
  } catch {
    return 'album';
  }
};

// Get aspect ratio based on content type
const getAppleAspectRatio = (): string => {
  const contentType = getAppleContentType();

  switch (contentType) {
    case 'song':
    case 'episode':
      return '16/7'; // Compact player ~175px height
    case 'album':
    case 'playlist':
    case 'podcast':
      return '16/9'; // Standard player ~450px height
    default:
      return '16/9';
  }
};

const embedUrl = buildAppleEmbedUrl();
const contentType = getAppleContentType();
const finalAspectRatio = getAppleAspectRatio();

// Generate appropriate title
const finalTitle =
  title || `Apple ${contentType === 'episode' ? 'Podcast' : 'Music'} Embed`;

// Generate ARIA label for screen readers
const finalAriaLabel =
  ariaLabel ||
  `Apple ${contentType === 'episode' ? 'podcast' : 'music'} player${title ? `: ${title}` : ''}`;
---

<EmbedBase
  src={embedUrl}
  title={finalTitle}
  aspectRatio={finalAspectRatio}
  variant={variant}
  showLoading={showLoading}
  class={className}
  ariaLabel={finalAriaLabel}
  allowFullscreen={allowFullscreen}
  allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
  sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
  referrerPolicy="strict-origin-when-cross-origin"
  {...props}
/>
