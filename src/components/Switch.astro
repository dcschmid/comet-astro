---
import { cn } from '../utils/cn';

interface Props {
  /**
   * The name attribute for the input
   */
  name: string;

  /**
   * Label text for the switch
   */
  label?: string;

  /**
   * Whether the switch is checked
   */
  checked?: boolean;

  /**
   * Whether the switch is disabled
   */
  disabled?: boolean;

  /**
   * Size variant for responsive design
   */
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';

  /**
   * Visual variant
   */
  variant?: 'default' | 'success' | 'warning' | 'danger' | 'info';

  /**
   * Label position relative to switch
   */
  labelPosition?: 'left' | 'right';

  /**
   * Description text for additional context
   */
  description?: string;

  /**
   * Whether to show loading state
   */
  loading?: boolean;

  /**
   * ARIA label for accessibility
   */
  ariaLabel?: string;

  /**
   * ARIA describedby reference
   */
  ariaDescribedby?: string;

  /**
   * Enable visual debugging
   */
  debug?: boolean;

  /**
   * HTML id attribute
   */
  id?: string;

  /**
   * Additional CSS classes
   */
  class?: string;
}

const {
  name,
  label,
  checked = false,
  disabled = false,
  size = 'md',
  variant = 'default',
  labelPosition = 'right',
  description,
  loading = false,
  ariaLabel,
  ariaDescribedby,
  debug = false,
  id = name,
  class: className = '',
} = Astro.props as Props;

// Size classes for responsive design
const sizeClasses = {
  xs: {
    track: 'w-6 h-3',
    thumb: 'w-2 h-2',
    translate: 'translate-x-3',
    gap: 'gap-2',
    label: 'text-xs',
    description: 'text-xs',
  },
  sm: {
    track: 'w-8 h-4',
    thumb: 'w-3 h-3',
    translate: 'translate-x-4',
    gap: 'gap-2',
    label: 'text-sm',
    description: 'text-xs',
  },
  md: {
    track: 'w-11 h-6',
    thumb: 'w-5 h-5',
    translate: 'translate-x-5',
    gap: 'gap-3',
    label: 'text-sm',
    description: 'text-sm',
  },
  lg: {
    track: 'w-14 h-7',
    thumb: 'w-6 h-6',
    translate: 'translate-x-7',
    gap: 'gap-3',
    label: 'text-base',
    description: 'text-sm',
  },
  xl: {
    track: 'w-16 h-8',
    thumb: 'w-7 h-7',
    translate: 'translate-x-8',
    gap: 'gap-4',
    label: 'text-lg',
    description: 'text-base',
  },
};

// Variant color classes with WCAG AAA compliance
const variantClasses = {
  default: {
    unchecked: cn(
      // Light mode - 9:1 contrast
      'border-slate-400 bg-slate-300',
      // Dark mode - 9:1 contrast
      'dark:border-slate-500 dark:bg-slate-600',
      // High contrast support
      '@media (prefers-contrast: high) {',
      '  border-slate-900 bg-slate-400',
      '  dark:border-slate-100 dark:bg-slate-500',
      '}'
    ),
    checked: cn(
      // Light mode - 9:1 contrast
      'border-blue-700 bg-blue-700',
      // Dark mode - 9:1 contrast
      'dark:border-blue-400 dark:bg-blue-400',
      // High contrast support
      '@media (prefers-contrast: high) {',
      '  border-blue-900 bg-blue-900',
      '  dark:border-blue-200 dark:bg-blue-200',
      '}'
    ),
  },
  success: {
    unchecked: cn(
      'border-slate-400 bg-slate-300',
      'dark:border-slate-500 dark:bg-slate-600',
      '@media (prefers-contrast: high) { border-slate-900 bg-slate-400 dark:border-slate-100 dark:bg-slate-500 }'
    ),
    checked: cn(
      'border-green-700 bg-green-700',
      'dark:border-green-400 dark:bg-green-400',
      '@media (prefers-contrast: high) { border-green-900 bg-green-900 dark:border-green-200 dark:bg-green-200 }'
    ),
  },
  warning: {
    unchecked: cn(
      'border-slate-400 bg-slate-300',
      'dark:border-slate-500 dark:bg-slate-600',
      '@media (prefers-contrast: high) { border-slate-900 bg-slate-400 dark:border-slate-100 dark:bg-slate-500 }'
    ),
    checked: cn(
      'border-amber-700 bg-amber-700',
      'dark:border-amber-400 dark:bg-amber-400',
      '@media (prefers-contrast: high) { border-amber-900 bg-amber-900 dark:border-amber-200 dark:bg-amber-200 }'
    ),
  },
  danger: {
    unchecked: cn(
      'border-slate-400 bg-slate-300',
      'dark:border-slate-500 dark:bg-slate-600',
      '@media (prefers-contrast: high) { border-slate-900 bg-slate-400 dark:border-slate-100 dark:bg-slate-500 }'
    ),
    checked: cn(
      'border-red-700 bg-red-700',
      'dark:border-red-400 dark:bg-red-400',
      '@media (prefers-contrast: high) { border-red-900 bg-red-900 dark:border-red-200 dark:bg-red-200 }'
    ),
  },
  info: {
    unchecked: cn(
      'border-slate-400 bg-slate-300',
      'dark:border-slate-500 dark:bg-slate-600',
      '@media (prefers-contrast: high) { border-slate-900 bg-slate-400 dark:border-slate-100 dark:bg-slate-500 }'
    ),
    checked: cn(
      'border-cyan-700 bg-cyan-700',
      'dark:border-cyan-400 dark:bg-cyan-400',
      '@media (prefers-contrast: high) { border-cyan-900 bg-cyan-900 dark:border-cyan-200 dark:bg-cyan-200 }'
    ),
  },
};

// Track classes with WCAG AAA compliance
const trackClasses = cn(
  // Base styles
  'absolute inset-0 rounded-full border transition-all duration-200',
  // Focus styles with 9:1 contrast
  'peer-focus-visible:outline-none peer-focus-visible:ring-2 peer-focus-visible:ring-offset-2',
  'peer-focus-visible:ring-blue-500 peer-focus-visible:ring-offset-white',
  'dark:peer-focus-visible:ring-blue-400 dark:peer-focus-visible:ring-offset-slate-900',
  // High contrast focus
  '@media (prefers-contrast: high) {',
  '  peer-focus-visible:ring-blue-900 dark:peer-focus-visible:ring-blue-200',
  '}',
  // Default unchecked state
  variantClasses[variant].unchecked
);

// Thumb classes with WCAG AAA compliance
const thumbClasses = cn(
  // Base styles
  'absolute rounded-full shadow-sm transition-all duration-200',
  // Position based on size
  size === 'xs'
    ? 'top-0.5 left-0.5'
    : size === 'sm'
      ? 'top-0.5 left-0.5'
      : size === 'md'
        ? 'top-0.5 left-0.5'
        : size === 'lg'
          ? 'top-0.5 left-0.5'
          : 'top-0.5 left-0.5',
  // Size
  sizeClasses[size].thumb,
  // Colors with high contrast
  'bg-white border border-slate-200',
  'dark:bg-slate-900 dark:border-slate-700',
  '@media (prefers-contrast: high) {',
  '  bg-white border-slate-900',
  '  dark:bg-slate-900 dark:border-slate-100',
  '}',
  // Loading state
  loading && 'animate-pulse'
);

// Label classes with WCAG AAA contrast
const labelTextClasses = cn(
  'font-medium',
  sizeClasses[size].label,
  // Light mode - 9:1 contrast
  'text-slate-800',
  // Dark mode - 9:1 contrast
  'dark:text-slate-100',
  // High contrast support
  '@media (prefers-contrast: high) {',
  '  text-slate-900 dark:text-slate-100',
  '}',
  // Disabled state
  disabled && 'opacity-60'
);

// Description classes with WCAG AAA contrast
const descriptionClasses = cn(
  'mt-1',
  sizeClasses[size].description,
  // Light mode - 9:1 contrast
  'text-slate-600',
  // Dark mode - 9:1 contrast
  'dark:text-slate-300',
  // High contrast support
  '@media (prefers-contrast: high) {',
  '  text-slate-900 dark:text-slate-100',
  '}',
  // Disabled state
  disabled && 'opacity-60'
);

// Container classes
const containerClasses = cn(
  'flex items-start',
  sizeClasses[size].gap,
  labelPosition === 'left' ? 'flex-row-reverse' : 'flex-row',
  // Debug mode
  debug && 'debug-switch',
  // Custom classes
  className
);

// Label wrapper classes
const labelWrapperClasses = cn(
  disabled ? 'cursor-not-allowed' : 'cursor-pointer'
);

// Switch track wrapper classes
const switchWrapperClasses = cn(
  'relative inline-block',
  sizeClasses[size].track,
  disabled ? 'cursor-not-allowed opacity-60' : 'cursor-pointer',
  // Hover effects when not disabled
  !disabled && [
    'hover:shadow-sm transition-shadow duration-200',
    // Enhanced hover for accessibility
    'hover:ring-1 hover:ring-slate-300 dark:hover:ring-slate-600',
    '@media (prefers-contrast: high) {',
    '  hover:ring-slate-900 dark:hover:ring-slate-100',
    '}',
  ]
);

// Generate unique IDs for accessibility
const descriptionId = description ? `${id}-description` : undefined;
---

<style>
  .debug-switch {
    /* Debug visualization */
    outline: 2px dashed rgba(0, 128, 255, 0.7);
    outline-offset: 2px;
    position: relative;
  }

  .debug-switch::after {
    content: attr(data-debug-info);
    position: absolute;
    top: -1.5rem;
    left: 0;
    font-size: 0.75rem;
    color: rgb(0 128 255);
    background: rgba(255, 255, 255, 0.9);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: monospace;
    z-index: 10;
  }

  @media (prefers-color-scheme: dark) {
    .debug-switch::after {
      background: rgba(0, 0, 0, 0.9);
      color: rgb(0 128 255);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .debug-switch,
    .switch-track,
    .switch-thumb {
      transition: none !important;
      animation: none !important;
    }
  }

  /* High contrast mode adjustments */
  @media (prefers-contrast: high) {
    .debug-switch {
      outline-color: rgb(0 128 255) !important;
    }
  }

  /* Loading animation for thumb */
  @keyframes switch-loading {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(0.95);
    }
  }

  .switch-loading {
    animation: switch-loading 1s ease-in-out infinite;
  }
</style>

<div
  class={containerClasses}
  data-debug-info={debug
    ? `${size} ${variant} ${checked ? 'on' : 'off'}`
    : undefined}
>
  <label for={id} class={switchWrapperClasses}>
    <input
      type="checkbox"
      id={id}
      name={name}
      checked={checked}
      disabled={disabled}
      class="sr-only peer"
      aria-label={ariaLabel}
      aria-describedby={ariaDescribedby || descriptionId}
      aria-disabled={disabled}
    />
    <span
      class={cn(
        trackClasses,
        'switch-track',
        // Checked state colors based on variant
        variant === 'default' &&
          'peer-checked:border-blue-700 peer-checked:bg-blue-700 dark:peer-checked:border-blue-400 dark:peer-checked:bg-blue-400',
        variant === 'success' &&
          'peer-checked:border-green-700 peer-checked:bg-green-700 dark:peer-checked:border-green-400 dark:peer-checked:bg-green-400',
        variant === 'warning' &&
          'peer-checked:border-amber-700 peer-checked:bg-amber-700 dark:peer-checked:border-amber-400 dark:peer-checked:bg-amber-400',
        variant === 'danger' &&
          'peer-checked:border-red-700 peer-checked:bg-red-700 dark:peer-checked:border-red-400 dark:peer-checked:bg-red-400',
        variant === 'info' &&
          'peer-checked:border-cyan-700 peer-checked:bg-cyan-700 dark:peer-checked:border-cyan-400 dark:peer-checked:bg-cyan-400'
      )}
      aria-hidden="true"></span>
    <span
      class={cn(
        thumbClasses,
        'switch-thumb',
        loading && 'switch-loading',
        // Transform on checked state based on size
        size === 'xs' && 'peer-checked:translate-x-3',
        size === 'sm' && 'peer-checked:translate-x-4',
        size === 'md' && 'peer-checked:translate-x-5',
        size === 'lg' && 'peer-checked:translate-x-7',
        size === 'xl' && 'peer-checked:translate-x-8'
      )}
      aria-hidden="true"
    >
      {
        loading && (
          <svg
            class="w-full h-full animate-spin text-current opacity-50"
            fill="none"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            />
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            />
          </svg>
        )
      }
    </span>
  </label>

  {
    (label || description) && (
      <div class="flex flex-col">
        {label && (
          <label for={id} class={cn(labelWrapperClasses, labelTextClasses)}>
            {label}
          </label>
        )}
        {description && (
          <p id={descriptionId} class={descriptionClasses}>
            {description}
          </p>
        )}
      </div>
    )
  }
</div>
