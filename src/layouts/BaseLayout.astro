---
/* BaseLayout.astro
 * A minimal, extensible, WCAG-focused layout skeleton for apps using Comet Astro.
 * Provides: semantic landmarks, skip link, font preference handling, theme toggle slot, optional nav/sidebar slots.
 */
import '../styles/tailwind.css';
import '../styles/accessible-fonts.css';
import '../styles/fontsource.css';
import SkipLink from '../components/SkipLink.astro';
import Container from '../components/Container.astro';

interface Props {
  title?: string;
  description?: string;
  lang?: string;
  /** Fixed font for the page (overrides user preference) */
  fontMode?:
    | 'default'
    | 'atkinson'
    | 'opendyslexic'
    | 'lexie'
    | 'opensans'
    | 'nunito'
    | 'lato'
    | 'ubuntu'
    | 'sourcesans'
    | 'sourcecode'
    | 'firacode'
    | 'ibmplexsans'
    | 'ibmplexmono'
    | 'spacegrotesk'
    | 'sylexiad'
    | 'tiresias'
    | 'braille';
  /** Enables high legibility (larger line height & word spacing) */
  highLegibility?: boolean;
  /** Provide a page heading (h1) directly here if not using slot in content */
  heading?: string;
  /** Constrain content width via Container */
  containerSize?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | 'full';
  /** Add global a11y status region */
  announceRegion?: boolean;
  /** Preload selected font (only when not default) */
  preloadFont?: boolean;
}

const {
  title = 'Comet Astro Page',
  description,
  lang = 'en',
  fontMode = 'atkinson',
  highLegibility = false,
  heading,
  containerSize = 'lg',
  announceRegion = true,
  preloadFont = true,
} = Astro.props as Props;

const liveId = `a11y-live-${Math.random().toString(36).slice(2, 8)}`;
const mainId = `main-${Math.random().toString(36).slice(2, 8)}`;
const fontClassMap: Record<string, string> = {
  default: 'font-default',
  atkinson: 'font-atkinson',
  opendyslexic: 'font-opendyslexic',
  opensans: 'font-opensans',
  nunito: 'font-nunito',
  lato: 'font-lato',
  ubuntu: 'font-ubuntu',
  sourcesans: 'font-sourcesans',
  sourcecode: 'font-sourcecode',
  firacode: 'font-firacode',
  ibmplexsans: 'font-ibmplexsans',
  ibmplexmono: 'font-ibmplexmono',
  spacegrotesk: 'font-spacegrotesk',
  sylexiad: 'font-sylexiad',
  tiresias: 'font-tiresias',
  braille: 'font-braille',
};
const resolvedFontClass = fontClassMap[fontMode] || fontClassMap.default;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {title && <title>{title}</title>}
    {description && <meta name="description" content={description} />}
    <meta name="color-scheme" content="dark light" />
    <script is:inline>
      (function () {
        const storageKey = 'comet-theme';
        const root = document.documentElement;
        const media = window.matchMedia('(prefers-color-scheme: dark)');
        const subscribers = new Set();
        function apply(mode) {
          const resolved =
            mode === 'system' ? (media.matches ? 'dark' : 'light') : mode;
          root.classList.toggle('dark', resolved === 'dark');
          root.dataset.themeMode = mode;
          root.dataset.themeResolved = resolved;
        }
        function read() {
          try {
            return localStorage.getItem(storageKey);
          } catch {
            return null;
          }
        }
        let current = ['light', 'dark'].includes(read() || '')
          ? read()
          : 'system';
        apply(current);
        function notify(m) {
          subscribers.forEach((fn) => {
            try {
              fn(m);
            } catch {
              /* subscriber threw; ignore */
            }
          });
        }
        function onMedia() {
          if (current === 'system') {
            apply('system');
            notify('system');
          }
        }
        if (media.addEventListener) {
          media.addEventListener('change', onMedia);
        } else if (media.addListener) {
          media.addListener(onMedia);
        }
        function setMode(m) {
          if (m !== 'light' && m !== 'dark') {
            m = 'system';
          }
          current = m;
          try {
            if (m === 'system') {
              localStorage.removeItem(storageKey);
            } else {
              localStorage.setItem(storageKey, m);
            }
          } catch {
            /* persistence failed */
          }
          apply(m);
          notify(m);
        }
        window.__cometTheme = {
          getMode: () => current,
          setMode,
          subscribe: (fn) => {
            if (typeof fn !== 'function') return () => {};
            subscribers.add(fn);
            try {
              fn(current);
            } catch {
              /* initial subscriber failed */
            }
            return () => subscribers.delete(fn);
          },
        };
      })();
    </script>
    {
      preloadFont &&
        fontMode !== 'default' &&
        ((src) => (
          <link
            rel="preload"
            as="font"
            href={src}
            type="font/woff2"
            crossorigin
          />
        ))
    }
  </head>
  <body
    class={[
      'min-h-screen bg-slate-100 text-slate-900 dark:bg-slate-950 dark:text-slate-100',
      resolvedFontClass,
      highLegibility && 'a11y-highlegibility',
    ]
      .filter(Boolean)
      .join(' ')}
    data-font-mode={fontMode}
  >
    <SkipLink targetId={mainId} label="Skip to main content" />
    {
      announceRegion && (
        <div
          id={liveId}
          class="sr-only"
          aria-live="polite"
          aria-atomic="true"
        />
      )
    }

    <header
      role="banner"
      class="w-full bg-white dark:bg-slate-900 shadow-sm border-b border-slate-200 dark:border-slate-800"
    >
      <Container
        size={containerSize}
        className="py-4 flex items-center justify-between gap-4"
      >
        <div class="flex items-center gap-3 min-w-0">
          <a
            href="/"
            class="text-base font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-700 dark:focus-visible:ring-blue-300"
          >
            {title}
          </a>
        </div>
        <div class="flex items-center gap-4">
          <slot name="theme" />
          <!-- Font set via fontMode prop (no live font switcher here). -->
        </div>
      </Container>
    </header>

    <nav
      aria-label="Primary"
      class="w-full border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900"
    >
      <Container size={containerSize} className="py-2">
        <slot name="nav" />
      </Container>
    </nav>

    <div class="flex flex-1 flex-row min-h-[60vh]">
      <aside
        aria-label="Sidebar"
        class="hidden lg:block w-72 border-r border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900"
      >
        <div class="p-4 h-full overflow-y-auto">
          <slot name="sidebar" />
        </div>
      </aside>
      <main
        id={mainId}
        tabindex="-1"
        role="main"
        class="flex-1 bg-white dark:bg-slate-900 focus:outline-none"
      >
        <Container size={containerSize} className="py-8 space-y-8">
          {
            heading && (
              <h1 class="text-2xl font-extrabold tracking-tight text-slate-900 dark:text-slate-50">
                {heading}
              </h1>
            )
          }
          <slot />
        </Container>
      </main>
    </div>

    <footer
      role="contentinfo"
      class="mt-auto border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900"
    >
      <Container
        size={containerSize}
        className="py-6 text-sm text-slate-600 dark:text-slate-400 flex flex-col gap-4"
      >
        <slot name="footer" />
        <p class="m-0">
          Accessibility mode fonts: Atkinson, OpenDyslexic and others â€“
          configurable.
        </p>
      </Container>
    </footer>

    <!-- No client switching: font fixed via prop. For dynamic switching use a separate component. -->
  </body>
</html>
