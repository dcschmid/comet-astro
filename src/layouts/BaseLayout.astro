---
/* BaseLayout.astro
 * A minimal, extensible, WCAG-focused layout skeleton for apps using Comet Astro.
 * Provides: semantic landmarks, skip link, font preference handling, theme toggle slot, optional nav/sidebar slots.
 */
import '../styles/tailwind.css';
import '../styles/accessible-fonts.css';
import '../styles/fontsource.css';
import SkipLink from '../components/SkipLink.astro';
import Container from '../components/Container.astro';

interface Props {
  seoTitle?: string;
  /** Site-wide short title (shown in header) */
  sitetitle?: string;
  seoDescription?: string;
  lang?: string;
  /** Fixed font for the page (overrides user preference) */
  fontMode?: 'default' | 'atkinson' | 'opendyslexic';
  /** Enables high legibility (larger line height & word spacing) */
  highLegibility?: boolean;
  /** Provide a page heading (h1) directly here if not using slot in content */
  /* heading prop removed: use named main slot for page heading */
  /** Constrain content width via Container */
  containerSize?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | 'full';
  /** Add global a11y status region */
  announceRegion?: boolean;
  /** Preload selected font (only when not default) */
  preloadFont?: boolean;
}

const {
  seoTitle = 'Comet Astro Page',
  sitetitle = 'Comet Astro',
  seoDescription,
  lang = 'en',
  fontMode = 'atkinson',
  highLegibility = false,
  containerSize = 'lg',
  announceRegion = true,
  preloadFont = true,
} = Astro.props as Props;

// Compose a useful page title: "Page Title — Site Title" when both present.
// Compose a useful page title for SEO: "SEO Title — Site Title" when both present.
const pageTitle = sitetitle
  ? seoTitle
    ? `${seoTitle} — ${sitetitle}`
    : sitetitle
  : seoTitle;

const liveId = `a11y-live-${Math.random().toString(36).slice(2, 8)}`;
const mainId = `main-${Math.random().toString(36).slice(2, 8)}`;
const fontClassMap: Record<string, string> = {
  default: 'font-default',
  atkinson: 'font-atkinson',
  opendyslexic: 'font-opendyslexic',
};
const resolvedFontClass = fontClassMap[fontMode] || fontClassMap.default;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {pageTitle && <title>{pageTitle}</title>}
    {seoDescription && <meta name="description" content={seoDescription} />}
    <meta name="color-scheme" content="dark light" />
    <script is:inline>
      (function () {
        const storageKey = 'comet-theme';
        const root = document.documentElement;
        const media = window.matchMedia('(prefers-color-scheme: dark)');
        const subscribers = new Set();
        function apply(mode) {
          const resolved =
            mode === 'system' ? (media.matches ? 'dark' : 'light') : mode;
          root.classList.toggle('dark', resolved === 'dark');
          root.dataset.themeMode = mode;
          root.dataset.themeResolved = resolved;
        }
        function read() {
          try {
            return localStorage.getItem(storageKey);
          } catch {
            return null;
          }
        }
        let current = ['light', 'dark'].includes(read() || '')
          ? read()
          : 'system';
        apply(current);
        function notify(m) {
          subscribers.forEach((fn) => {
            try {
              fn(m);
            } catch {
              /* subscriber threw; ignore */
            }
          });
        }
        function onMedia() {
          if (current === 'system') {
            apply('system');
            notify('system');
          }
        }
        if (media.addEventListener) {
          media.addEventListener('change', onMedia);
        } else if (media.addListener) {
          media.addListener(onMedia);
        }
        function setMode(m) {
          if (m !== 'light' && m !== 'dark') {
            m = 'system';
          }
          current = m;
          try {
            if (m === 'system') {
              localStorage.removeItem(storageKey);
            } else {
              localStorage.setItem(storageKey, m);
            }
          } catch {
            /* persistence failed */
          }
          apply(m);
          notify(m);
        }
        window.__cometTheme = {
          getMode: () => current,
          setMode,
          subscribe: (fn) => {
            if (typeof fn !== 'function') return () => {};
            subscribers.add(fn);
            try {
              fn(current);
            } catch {
              /* initial subscriber failed */
            }
            return () => subscribers.delete(fn);
          },
        };
      })();
    </script>
    {
      preloadFont &&
        fontMode !== 'default' &&
        ((src) => (
          <link
            rel="preload"
            as="font"
            href={src}
            type="font/woff2"
            crossorigin
          />
        ))
    }
  </head>
  <body
    class={[
      'min-h-screen bg-slate-100 text-slate-900 dark:bg-slate-950 dark:text-slate-100',
      resolvedFontClass,
      highLegibility && 'a11y-highlegibility',
    ]
      .filter(Boolean)
      .join(' ')}
    data-font-mode={fontMode}
  >
    <SkipLink targetId={mainId} label="Skip to main content" />
    {
      announceRegion && (
        <div
          id={liveId}
          class="sr-only"
          aria-live="polite"
          aria-atomic="true"
        />
      )
    }

    <Container size={containerSize} as="header">
      <slot name="header" />
    </Container>

    <Container size={containerSize} as="nav">
      <slot name="nav" />
    </Container>

    <Container size={containerSize} as="aside">
      <slot name="sidebar" />
    </Container>

    <Container size={containerSize} as="main" id={mainId}>
      <slot name="main" />
    </Container>
  </body>

  <Container size={containerSize} as="footer">
    <slot name="footer" />
  </Container>
</html>
